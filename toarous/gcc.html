<!DOCTYPE html>
<html>
	<head>
		<title>gcc.org</title>
		<link rel="stylesheet" href="/diary/resources/css/main.css" />
		<link rel="stylesheet" href="/diary/resources/highlight/styles/default.css" />
		<script src="/diary/resources/js/jquery-3.4.1.min.js"></script>
		<script src="/diary/resources/js/swgen.js"></script>
		<script src="/diary/resources/highlight/highlight.pack.js"></script>
		<script src='https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-MML-AM_CHTML' async></script>
		<script>hljs.initHighlightingOnLoad();</script>
	</head>
	<body>
		<nav id='content'>
		</nav>
		<section class="main-article-area">
			<div id='main'>
				<h1 id="inline-assembly">inline assembly</h1>
<h2 id="example-1">example 1</h2>
<div class="sourceCode" id="cb1"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb1-1"><a href="#cb1-1"></a><span class="co">/*</span></span>
<span id="cb1-2"><a href="#cb1-2"></a><span class="co"> * inportb</span></span>
<span id="cb1-3"><a href="#cb1-3"></a><span class="co"> * Read from an I/O port.</span></span>
<span id="cb1-4"><a href="#cb1-4"></a><span class="co"> */</span></span>
<span id="cb1-5"><a href="#cb1-5"></a><span class="dt">unsigned</span> <span class="dt">char</span></span>
<span id="cb1-6"><a href="#cb1-6"></a>inportb(</span>
<span id="cb1-7"><a href="#cb1-7"></a>        <span class="dt">unsigned</span> <span class="dt">short</span> _port</span>
<span id="cb1-8"><a href="#cb1-8"></a>       ) {</span>
<span id="cb1-9"><a href="#cb1-9"></a>    <span class="dt">unsigned</span> <span class="dt">char</span> rv;</span>
<span id="cb1-10"><a href="#cb1-10"></a>    __asm__ __volatile__ (<span class="st">&quot;inb %1, %0&quot;</span> : <span class="st">&quot;=a&quot;</span> (rv) : <span class="st">&quot;dN&quot;</span> (_port));</span>
<span id="cb1-11"><a href="#cb1-11"></a>    <span class="cf">return</span> rv;</span>
<span id="cb1-12"><a href="#cb1-12"></a>}</span></code></pre></div>
<p>The parameters for <code>__asm__</code> are</p>
<ol class="incremental">
<li>assembler template: GAS mode, and register name starts with <code>%%</code></li>
<li>output operand</li>
<li>input operand</li>
</ol>
<p>There can be a fourth parameter, named <strong>clobbered registers list</strong>.</p>
<p>Use C variable <code>rv</code> to store the input port. And map the EAX register (for optimal performance) to this variable.</p>
<ol class="incremental">
<li><code>=</code> means your assembly code does not care about the initial value of the mapped variable</li>
<li><code>a</code> means use EAX register</li>
</ol>
<p>Input operand</p>
<ol class="incremental">
<li><code>d</code> for the "d" register</li>
<li><code>N</code> for the constant is in range 0 to 255</li>
</ol>
<h2 id="example-2">example 2</h2>
<div class="sourceCode" id="cb2"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb2-1"><a href="#cb2-1"></a><span class="co">/*</span></span>
<span id="cb2-2"><a href="#cb2-2"></a><span class="co"> * outportb</span></span>
<span id="cb2-3"><a href="#cb2-3"></a><span class="co"> * Write to an I/O port.</span></span>
<span id="cb2-4"><a href="#cb2-4"></a><span class="co"> */</span></span>
<span id="cb2-5"><a href="#cb2-5"></a><span class="dt">void</span></span>
<span id="cb2-6"><a href="#cb2-6"></a>outportb(</span>
<span id="cb2-7"><a href="#cb2-7"></a>        <span class="dt">unsigned</span> <span class="dt">short</span> _port,</span>
<span id="cb2-8"><a href="#cb2-8"></a>        <span class="dt">unsigned</span> <span class="dt">char</span> _data</span>
<span id="cb2-9"><a href="#cb2-9"></a>        ) {</span>
<span id="cb2-10"><a href="#cb2-10"></a>    __asm__ __volatile__ (<span class="st">&quot;outb %1, %0&quot;</span> : : <span class="st">&quot;dN&quot;</span> (_port), <span class="st">&quot;a&quot;</span> (_data));</span>
<span id="cb2-11"><a href="#cb2-11"></a>}</span></code></pre></div>
<p>Write the value of C variable <code>_data</code> (map in EAX register) to the port specificed in <code>_port</code> variable (map to EDX register and limit in [0-255] range)</p>
<h2 id="example-3">example 3</h2>
<div class="sourceCode" id="cb3"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb3-1"><a href="#cb3-1"></a><span class="dt">void</span></span>
<span id="cb3-2"><a href="#cb3-2"></a>switch_page_directory(</span>
<span id="cb3-3"><a href="#cb3-3"></a>                page_directory_t * dir</span>
<span id="cb3-4"><a href="#cb3-4"></a>                ) {</span>
<span id="cb3-5"><a href="#cb3-5"></a>        current_directory = dir;</span>
<span id="cb3-6"><a href="#cb3-6"></a>        __asm__ __volatile__ (<span class="st">&quot;mov %0, %%cr3&quot;</span>:: <span class="st">&quot;r&quot;</span>(&amp;dir-&gt;physical_tables));</span>
<span id="cb3-7"><a href="#cb3-7"></a>        <span class="dt">uint32_t</span> cr0;</span>
<span id="cb3-8"><a href="#cb3-8"></a>        __asm__ __volatile__ (<span class="st">&quot;mov %%cr0, %0&quot;</span>: <span class="st">&quot;=r&quot;</span>(cr0));</span>
<span id="cb3-9"><a href="#cb3-9"></a>        cr0 |= <span class="bn">0x80000000</span>;</span>
<span id="cb3-10"><a href="#cb3-10"></a>        __asm__ __volatile__ (<span class="st">&quot;mov %0, %%cr0&quot;</span>:: <span class="st">&quot;r&quot;</span>(cr0));</span>
<span id="cb3-11"><a href="#cb3-11"></a>}</span></code></pre></div>
<ul class="incremental">
<li>'r' constraint means a register operand is allowed provided that it is in a general register</li>
<li>The '=' in output operand constrain means there will be a variable overwriting an existing value (another symbol is '+'</li>
</ul>
<h1 id="reference">Reference</h1>
<ul class="incremental">
<li><a href="https://wiki.osdev.org/Inline_Assembly">Inline Assembly</a></li>
<li><a href="https://gcc.gnu.org/onlinedocs/gcc/Extended-Asm.html#InputOperands">https://gcc.gnu.org/onlinedocs/gcc/Extended-Asm.html#InputOperands</a></li>
</ul>

			</div>
		</section>
	</body>
</html>

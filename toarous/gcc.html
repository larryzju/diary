<!DOCTYPE html>
<html>
	<head>
		<title>gcc.org</title>
		<link rel="stylesheet" href="/diary/resources/css/main.css" />
		<link rel="stylesheet" href="/diary/resources/highlight/styles/default.css" />
		<script src="/diary/resources/js/jquery-3.4.1.min.js"></script>
		<script src="/diary/resources/js/swgen.js"></script>
		<script src="/diary/resources/highlight/highlight.pack.js"></script>
		<script>hljs.initHighlightingOnLoad();</script>
	</head>
	<body>
		<nav id='content'>
		</nav>
		<section class="main-article-area">
			<div id='main'>
				<h1 id="inline-assembly">inline assembly</h1>
<h2 id="example-1">example 1</h2>
<div class="sourceCode"><pre class="sourceCode c"><code class="sourceCode c"><span class="co">/*</span>
<span class="co"> * inportb</span>
<span class="co"> * Read from an I/O port.</span>
<span class="co"> */</span>
<span class="dt">unsigned</span> <span class="dt">char</span>
inportb(
        <span class="dt">unsigned</span> <span class="dt">short</span> _port
       ) {
    <span class="dt">unsigned</span> <span class="dt">char</span> rv;
    __asm__ __volatile__ (<span class="st">&quot;inb %1, %0&quot;</span> : <span class="st">&quot;=a&quot;</span> (rv) : <span class="st">&quot;dN&quot;</span> (_port));
    <span class="cf">return</span> rv;
}</code></pre></div>
<p>The parameters for <code>__asm__</code> are</p>
<ol class="incremental">
<li>assembler template: GAS mode, and register name starts with <code>%%</code></li>
<li>output operand</li>
<li>input operand</li>
</ol>
<p>There can be a fourth parameter, named <strong>clobbered registers list</strong>.</p>
<p>Use C variable <code>rv</code> to store the input port. And map the EAX register (for optimal performance) to this variable.</p>
<ol class="incremental">
<li><code>=</code> means your assembly code does not care about the initial value of the mapped variable</li>
<li><code>a</code> means use EAX register</li>
</ol>
<p>Input operand</p>
<ol class="incremental">
<li><code>d</code> for the &quot;d&quot; register</li>
<li><code>N</code> for the constant is in range 0 to 255</li>
</ol>
<h2 id="example-2">example 2</h2>
<div class="sourceCode"><pre class="sourceCode c"><code class="sourceCode c"><span class="co">/*</span>
<span class="co"> * outportb</span>
<span class="co"> * Write to an I/O port.</span>
<span class="co"> */</span>
<span class="dt">void</span>
outportb(
        <span class="dt">unsigned</span> <span class="dt">short</span> _port,
        <span class="dt">unsigned</span> <span class="dt">char</span> _data
        ) {
    __asm__ __volatile__ (<span class="st">&quot;outb %1, %0&quot;</span> : : <span class="st">&quot;dN&quot;</span> (_port), <span class="st">&quot;a&quot;</span> (_data));
}</code></pre></div>
<p>Write the value of C variable <code>_data</code> (map in EAX register) to the port specificed in <code>_port</code> variable (map to EDX register and limit in [0-255] range)</p>
<h1 id="reference">Reference</h1>
<ul class="incremental">
<li><a href="https://wiki.osdev.org/Inline_Assembly">Inline Assembly</a></li>
</ul>

			</div>
		</section>
	</body>
</html>

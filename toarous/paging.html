<!DOCTYPE html>
<html>
	<head>
		<title>paging.org</title>
		<link rel="stylesheet" href="/diary/resources/css/main.css" />
		<link rel="stylesheet" href="/diary/resources/highlight/styles/default.css" />
		<script src="/diary/resources/js/jquery-3.4.1.min.js"></script>
		<script src="/diary/resources/js/swgen.js"></script>
		<script src="/diary/resources/highlight/highlight.pack.js"></script>
		<script src='https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-MML-AM_CHTML' async></script>
		<script>hljs.initHighlightingOnLoad();</script>
	</head>
	<body>
		<nav id='content'>
		</nav>
		<section class="main-article-area">
			<div id='main'>
				<h1 id="coding-analysis">Coding Analysis</h1>
<p><code>kernel/core/mem.c</code></p>
<h2 id="switch-page-directory">switch page directory</h2>
<div class="sourceCode" id="cb1"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb1-1"><a href="#cb1-1"></a><span class="dt">void</span></span>
<span id="cb1-2"><a href="#cb1-2"></a>switch_page_directory(</span>
<span id="cb1-3"><a href="#cb1-3"></a>                page_directory_t * dir</span>
<span id="cb1-4"><a href="#cb1-4"></a>                ) {</span>
<span id="cb1-5"><a href="#cb1-5"></a>        current_directory = dir;</span>
<span id="cb1-6"><a href="#cb1-6"></a>        __asm__ __volatile__ (<span class="st">&quot;mov %0, %%cr3&quot;</span>:: <span class="st">&quot;r&quot;</span>(&amp;dir-&gt;physical_tables));</span>
<span id="cb1-7"><a href="#cb1-7"></a>        <span class="dt">uint32_t</span> cr0;</span>
<span id="cb1-8"><a href="#cb1-8"></a>        __asm__ __volatile__ (<span class="st">&quot;mov %%cr0, %0&quot;</span>: <span class="st">&quot;=r&quot;</span>(cr0));</span>
<span id="cb1-9"><a href="#cb1-9"></a>        cr0 |= <span class="bn">0x80000000</span>;</span>
<span id="cb1-10"><a href="#cb1-10"></a>        __asm__ __volatile__ (<span class="st">&quot;mov %0, %%cr0&quot;</span>:: <span class="st">&quot;r&quot;</span>(cr0));</span>
<span id="cb1-11"><a href="#cb1-11"></a>}</span></code></pre></div>
<p>Enable page directory by</p>
<ul class="incremental">
<li>load CR3 with the address of the page directory (<code>dir-&gt;physical_tables</code>)</li>
<li>set the PG bit (bit 31) of CR0 to enable paging</li>
<li>(optional) set the PE bit (bit 1) of CR0 to enable protect mode</li>
</ul>
<div class="sourceCode" id="cb2"><pre class="sourceCode asm"><code class="sourceCode fasm"><span id="cb2-1"><a href="#cb2-1"></a><span class="bu">mov</span> <span class="kw">eax</span>, physical_tables</span>
<span id="cb2-2"><a href="#cb2-2"></a><span class="bu">mov</span> <span class="kw">cr3</span>, <span class="kw">eax</span></span>
<span id="cb2-3"><a href="#cb2-3"></a></span>
<span id="cb2-4"><a href="#cb2-4"></a><span class="bu">mov</span> <span class="kw">eax</span>, <span class="kw">cr0</span></span>
<span id="cb2-5"><a href="#cb2-5"></a><span class="bu">or</span>  <span class="kw">eax</span>, <span class="bn">0x8000</span>_<span class="dv">0000</span></span>
<span id="cb2-6"><a href="#cb2-6"></a><span class="bu">mov</span> <span class="kw">cr0</span>, <span class="kw">eax</span></span></code></pre></div>
<h2 id="physical-frame">physical frame</h2>
<div class="sourceCode" id="cb3"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb3-1"><a href="#cb3-1"></a><span class="dt">void</span></span>
<span id="cb3-2"><a href="#cb3-2"></a>alloc_frame(</span>
<span id="cb3-3"><a href="#cb3-3"></a>                page_t *page,</span>
<span id="cb3-4"><a href="#cb3-4"></a>                <span class="dt">int</span> is_kernel,</span>
<span id="cb3-5"><a href="#cb3-5"></a>                <span class="dt">int</span> is_writeable</span>
<span id="cb3-6"><a href="#cb3-6"></a>                ) {</span>
<span id="cb3-7"><a href="#cb3-7"></a>        <span class="cf">if</span> (page-&gt;frame) {</span>
<span id="cb3-8"><a href="#cb3-8"></a>                <span class="cf">return</span>;</span>
<span id="cb3-9"><a href="#cb3-9"></a>        } <span class="cf">else</span> {</span>
<span id="cb3-10"><a href="#cb3-10"></a>                <span class="dt">uint32_t</span> index = first_frame();</span>
<span id="cb3-11"><a href="#cb3-11"></a>                <span class="cf">if</span> (index == (<span class="dt">uint32_t</span>)-<span class="dv">1</span>) {</span>
<span id="cb3-12"><a href="#cb3-12"></a>                        <span class="co">// never happens?</span></span>
<span id="cb3-13"><a href="#cb3-13"></a>                        HALT_AND_CATCH_FIRE(<span class="st">&quot;Failed to allocate a frame: out of frames&quot;</span>);</span>
<span id="cb3-14"><a href="#cb3-14"></a>                }</span>
<span id="cb3-15"><a href="#cb3-15"></a>                set_frame(index * <span class="bn">0x1000</span>); </span>
<span id="cb3-16"><a href="#cb3-16"></a>                page-&gt;present = <span class="dv">1</span>;</span>
<span id="cb3-17"><a href="#cb3-17"></a>                page-&gt;rw      = (is_writeable) ? <span class="dv">1</span> : <span class="dv">0</span>;</span>
<span id="cb3-18"><a href="#cb3-18"></a>                page-&gt;user    = (is_kernel)    ? <span class="dv">0</span> : <span class="dv">1</span>;</span>
<span id="cb3-19"><a href="#cb3-19"></a>                page-&gt;frame   = index;</span>
<span id="cb3-20"><a href="#cb3-20"></a>        }</span>
<span id="cb3-21"><a href="#cb3-21"></a>}</span>
<span id="cb3-22"><a href="#cb3-22"></a></span>
<span id="cb3-23"><a href="#cb3-23"></a><span class="dt">void</span></span>
<span id="cb3-24"><a href="#cb3-24"></a>free_frame(</span>
<span id="cb3-25"><a href="#cb3-25"></a>                page_t *page</span>
<span id="cb3-26"><a href="#cb3-26"></a>                ) {</span>
<span id="cb3-27"><a href="#cb3-27"></a>        <span class="dt">uint32_t</span> frame;</span>
<span id="cb3-28"><a href="#cb3-28"></a>        <span class="cf">if</span> (!(frame = page-&gt;frame)) {</span>
<span id="cb3-29"><a href="#cb3-29"></a>                <span class="cf">return</span>;</span>
<span id="cb3-30"><a href="#cb3-30"></a>        } <span class="cf">else</span> {</span>
<span id="cb3-31"><a href="#cb3-31"></a>                clear_frame(frame);</span>
<span id="cb3-32"><a href="#cb3-32"></a>                page-&gt;frame = <span class="bn">0x0</span>;</span>
<span id="cb3-33"><a href="#cb3-33"></a>        }</span>
<span id="cb3-34"><a href="#cb3-34"></a>}</span></code></pre></div>
<p>Page caches physical frame in <code>page-&gt;frame</code> pointer.</p>
<p>Allocate a frame for a page in below steps</p>
<ol class="incremental">
<li>find the first unused frame</li>
<li>make sure the frame not over <span class="math inline">\(4GiB / 4KiB\)</span> (the code <code>uint32_t - 1</code> would never happened?)</li>
<li>mark this frame
<ul class="incremental">
<li>is been used (whose address is <code>index * 0x1000</code>)</li>
<li>is present</li>
<li>read/write flag</li>
<li>kernel/user flag</li>
</ul></li>
<li>mark its frame as the index (so the PA will be equal to VA?)</li>
</ol>
<p>Free a frame is quiet easy: clear the bitmap and set the <code>frame</code> as zero.</p>
<h2 id="frame-bitmap">frame bitmap</h2>
<div class="sourceCode" id="cb4"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb4-1"><a href="#cb4-1"></a><span class="dt">uint32_t</span> *frames;</span>
<span id="cb4-2"><a href="#cb4-2"></a><span class="dt">uint32_t</span> nframes;</span>
<span id="cb4-3"><a href="#cb4-3"></a></span>
<span id="cb4-4"><a href="#cb4-4"></a><span class="pp">#define INDEX_FROM_BIT(b) (b / 0x20)</span></span>
<span id="cb4-5"><a href="#cb4-5"></a><span class="pp">#define OFFSET_FROM_BIT(b) (b % 0x20)</span></span>
<span id="cb4-6"><a href="#cb4-6"></a></span>
<span id="cb4-7"><a href="#cb4-7"></a><span class="dt">static</span> <span class="dt">void</span></span>
<span id="cb4-8"><a href="#cb4-8"></a>set_frame(</span>
<span id="cb4-9"><a href="#cb4-9"></a>                <span class="dt">uintptr_t</span> frame_addr</span>
<span id="cb4-10"><a href="#cb4-10"></a>                ) {</span>
<span id="cb4-11"><a href="#cb4-11"></a>        <span class="dt">uint32_t</span> frame  = frame_addr / <span class="bn">0x1000</span>;</span>
<span id="cb4-12"><a href="#cb4-12"></a>        <span class="dt">uint32_t</span> index  = INDEX_FROM_BIT(frame);</span>
<span id="cb4-13"><a href="#cb4-13"></a>        <span class="dt">uint32_t</span> offset = OFFSET_FROM_BIT(frame);</span>
<span id="cb4-14"><a href="#cb4-14"></a>        frames[index] |= (<span class="bn">0x1</span> &lt;&lt; offset);</span>
<span id="cb4-15"><a href="#cb4-15"></a>}</span>
<span id="cb4-16"><a href="#cb4-16"></a></span>
<span id="cb4-17"><a href="#cb4-17"></a><span class="dt">static</span> <span class="dt">void</span></span>
<span id="cb4-18"><a href="#cb4-18"></a>clear_frame(</span>
<span id="cb4-19"><a href="#cb4-19"></a>                <span class="dt">uintptr_t</span> frame_addr</span>
<span id="cb4-20"><a href="#cb4-20"></a>                ) {</span>
<span id="cb4-21"><a href="#cb4-21"></a>        <span class="dt">uint32_t</span> frame  = frame_addr / <span class="bn">0x1000</span>;</span>
<span id="cb4-22"><a href="#cb4-22"></a>        <span class="dt">uint32_t</span> index  = INDEX_FROM_BIT(frame);</span>
<span id="cb4-23"><a href="#cb4-23"></a>        <span class="dt">uint32_t</span> offset = OFFSET_FROM_BIT(frame);</span>
<span id="cb4-24"><a href="#cb4-24"></a>        frames[index] &amp;= ~(<span class="bn">0x1</span> &lt;&lt; offset);</span>
<span id="cb4-25"><a href="#cb4-25"></a>}</span>
<span id="cb4-26"><a href="#cb4-26"></a></span>
<span id="cb4-27"><a href="#cb4-27"></a><span class="dt">static</span> <span class="dt">uint32_t</span></span>
<span id="cb4-28"><a href="#cb4-28"></a>test_frame(</span>
<span id="cb4-29"><a href="#cb4-29"></a>                <span class="dt">uintptr_t</span> frame_addr</span>
<span id="cb4-30"><a href="#cb4-30"></a>                ) {</span>
<span id="cb4-31"><a href="#cb4-31"></a>        <span class="dt">uint32_t</span> frame  = frame_addr / <span class="bn">0x1000</span>;</span>
<span id="cb4-32"><a href="#cb4-32"></a>        <span class="dt">uint32_t</span> index  = INDEX_FROM_BIT(frame);</span>
<span id="cb4-33"><a href="#cb4-33"></a>        <span class="dt">uint32_t</span> offset = OFFSET_FROM_BIT(frame);</span>
<span id="cb4-34"><a href="#cb4-34"></a>        <span class="cf">return</span> (frames[index] &amp; (<span class="bn">0x1</span> &lt;&lt; offset));</span>
<span id="cb4-35"><a href="#cb4-35"></a>}</span>
<span id="cb4-36"><a href="#cb4-36"></a></span>
<span id="cb4-37"><a href="#cb4-37"></a><span class="dt">static</span> <span class="dt">uint32_t</span> first_frame() {</span>
<span id="cb4-38"><a href="#cb4-38"></a>        <span class="dt">uint32_t</span> i, j;</span>
<span id="cb4-39"><a href="#cb4-39"></a>        <span class="cf">for</span> (i = <span class="dv">0</span>; i &lt; INDEX_FROM_BIT(nframes); ++i) {</span>
<span id="cb4-40"><a href="#cb4-40"></a>                <span class="cf">if</span> (frames[i] != <span class="bn">0xFFFFFFFF</span>) {</span>
<span id="cb4-41"><a href="#cb4-41"></a>                        <span class="cf">for</span> (j = <span class="dv">0</span>; j &lt; <span class="dv">32</span>; ++j) {</span>
<span id="cb4-42"><a href="#cb4-42"></a>                                <span class="dt">uint32_t</span> test_frame = <span class="bn">0x1</span> &lt;&lt; j;</span>
<span id="cb4-43"><a href="#cb4-43"></a>                                <span class="cf">if</span> (!(frames[i] &amp; test_frame)) {</span>
<span id="cb4-44"><a href="#cb4-44"></a>                                        <span class="cf">return</span> i * <span class="bn">0x20</span> + j;</span>
<span id="cb4-45"><a href="#cb4-45"></a>                                }</span>
<span id="cb4-46"><a href="#cb4-46"></a>                        }</span>
<span id="cb4-47"><a href="#cb4-47"></a>                }</span>
<span id="cb4-48"><a href="#cb4-48"></a>        }       </span>
<span id="cb4-49"><a href="#cb4-49"></a>        <span class="cf">return</span> -<span class="dv">1</span>;</span>
<span id="cb4-50"><a href="#cb4-50"></a>}</span></code></pre></div>
<p>Frame is a 4 KiB continuous addressed block.</p>
<table>
<thead>
<tr class="header">
<th>variable</th>
<th>description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>nframes</code></td>
<td>the count of frames</td>
</tr>
<tr class="even">
<td><code>frames</code></td>
<td>a bitmap consist by multiple 32-bit bytes to represent if the frame is cached</td>
</tr>
</tbody>
</table>
<table>
<thead>
<tr class="header">
<th>expression</th>
<th>description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>frame_addr / 0x1000</code></td>
<td>equals to the frame bitmap index</td>
</tr>
<tr class="even">
<td><code>INDEX_FROM_BIT()</code></td>
<td>macro to calculate the bitmap byte index</td>
</tr>
<tr class="odd">
<td><code>OFFSET_FROM_BIT()</code></td>
<td>macro to calculate the bitmap bit offset</td>
</tr>
<tr class="even">
<td><code>set_frame(addr)</code></td>
<td>set the bitmap bit</td>
</tr>
<tr class="odd">
<td><code>clear_frame(addr)</code></td>
<td>clear the bitmap bit</td>
</tr>
<tr class="even">
<td><code>test_frame(addr)</code></td>
<td>check the bitmap to see if the frame is used</td>
</tr>
<tr class="odd">
<td><code>first_frame()</code></td>
<td>loops over the bitmap and finds the first uncached frame index</td>
</tr>
</tbody>
</table>
<h1 id="paging">Paging</h1>
<p>作用：</p>
<ul class="incremental">
<li>实现虚拟地址空间</li>
<li>并提供页保护机制 (page-level protection)</li>
<li>memory-mapped IO</li>
<li>paging sout to disk (缓存硬盘存储）</li>
</ul>
<p>对 x86 处理器</p>
<ul class="incremental">
<li>x86-32 支持 32 位虚拟地址空间</li>
<li>x86-64 处理器支持 48-bit 虚拟地址空间（256 TiB）</li>
</ul>
<p>64 位平台下已经用 page-level protection 替换了 segmentation protection。 32 位中两者被同时使用。</p>
<h2 id="architecture">Architecture</h2>
<figure>
<img src="./images/paging-architecture.png" alt="" /><figcaption>Paging architecture</figcaption>
</figure>
<p>以二级表方式进行内存映射。</p>
<p>MMU 读取一系列的表（paging directory 和 paging table）来进行内存映射。</p>
<p>CR3 register point to the page directory</p>
<p>Paging directory 和 Paging table 分别包括 1024 个 4 字节的表项</p>
<ul class="incremental">
<li>paging directory 的表项指向一个 paging table</li>
<li>paging table 的每个表项指向一个物理地址</li>
<li>物理地址加上相关 offset 就得到最终地址</li>
</ul>
<div class="sourceCode" id="cb5"><pre class="sourceCode go"><code class="sourceCode go"><span id="cb5-1"><a href="#cb5-1"></a><span class="kw">type</span> PageDirectory <span class="kw">struct</span> {</span>
<span id="cb5-2"><a href="#cb5-2"></a>        PageTableAddress <span class="dt">uintptr</span>:<span class="dv">20</span>   <span class="co">// 4-KiB aligned</span></span>
<span id="cb5-3"><a href="#cb5-3"></a>        Avail    <span class="dt">uintptr</span>:<span class="dv">3</span>            <span class="co">// not used by the processor</span></span>
<span id="cb5-4"><a href="#cb5-4"></a>        Gbit     <span class="dt">uintptr</span>:<span class="dv">1</span></span>
<span id="cb5-5"><a href="#cb5-5"></a>        PageSize <span class="dt">uintptr</span>:<span class="dv">1</span>            <span class="co">// 1 for 4MiB, 0 for 4 KiB</span></span>
<span id="cb5-6"><a href="#cb5-6"></a>        Padbit   <span class="dt">uintptr</span>:<span class="dv">1</span></span>
<span id="cb5-7"><a href="#cb5-7"></a>        Accessed <span class="dt">uintptr</span>:<span class="dv">1</span>            <span class="co">// set if it has been read or write to</span></span>
<span id="cb5-8"><a href="#cb5-8"></a>        CacheDisable <span class="dt">uintptr</span>:<span class="dv">1</span></span>
<span id="cb5-9"><a href="#cb5-9"></a>        WriteThrough <span class="dt">uintptr</span>:<span class="dv">1</span>        <span class="co">// switch for write-through cache</span></span>
<span id="cb5-10"><a href="#cb5-10"></a>        Supervisor   <span class="dt">uintptr</span>:<span class="dv">1</span>        <span class="co">// 1 for all</span></span>
<span id="cb5-11"><a href="#cb5-11"></a>        ReadWrite    <span class="dt">uintptr</span>:<span class="dv">1</span>        <span class="co">// enable to read/write</span></span>
<span id="cb5-12"><a href="#cb5-12"></a>        Present      <span class="dt">uintptr</span>:<span class="dv">1</span>        <span class="co">// whether in physical memory</span></span>
<span id="cb5-13"><a href="#cb5-13"></a>}</span>
<span id="cb5-14"><a href="#cb5-14"></a></span>
<span id="cb5-15"><a href="#cb5-15"></a><span class="kw">func</span> (pd *PageDirectory) AddressBasis() <span class="dt">uintptr</span> {</span>
<span id="cb5-16"><a href="#cb5-16"></a>        <span class="kw">if</span> pd.PageSize == <span class="dv">1</span> {</span>
<span id="cb5-17"><a href="#cb5-17"></a>                <span class="kw">return</span> (pd.PageTableAddress &gt;&gt; <span class="dv">10</span>) * MBytes * <span class="dv">4</span></span>
<span id="cb5-18"><a href="#cb5-18"></a>        } <span class="kw">else</span> {</span>
<span id="cb5-19"><a href="#cb5-19"></a>                <span class="kw">return</span> pd.PageTableAddress * KBytes * <span class="dv">4</span></span>
<span id="cb5-20"><a href="#cb5-20"></a>        }</span>
<span id="cb5-21"><a href="#cb5-21"></a>}</span>
<span id="cb5-22"><a href="#cb5-22"></a></span>
<span id="cb5-23"><a href="#cb5-23"></a><span class="co">// PageTable is similar to page directory entries</span></span>
<span id="cb5-24"><a href="#cb5-24"></a><span class="kw">type</span> PageTable <span class="kw">struct</span> {</span>
<span id="cb5-25"><a href="#cb5-25"></a>        PhysicalPageAddress <span class="dt">uintptr</span>:<span class="dv">20</span> <span class="co">// 4-KiB aligned</span></span>
<span id="cb5-26"><a href="#cb5-26"></a>        Avail    <span class="dt">uintptr</span>:<span class="dv">3</span>            <span class="co">// not used by the processor</span></span>
<span id="cb5-27"><a href="#cb5-27"></a>        Global   <span class="dt">uintptr</span>:<span class="dv">1</span>            </span>
<span id="cb5-28"><a href="#cb5-28"></a>        Padbit   <span class="dt">uintptr</span>:<span class="dv">1</span></span>
<span id="cb5-29"><a href="#cb5-29"></a>        Dirty    <span class="dt">uintptr</span>:<span class="dv">1</span>            <span class="co">// page has been written to</span></span>
<span id="cb5-30"><a href="#cb5-30"></a>        Accessed <span class="dt">uintptr</span>:<span class="dv">1</span></span>
<span id="cb5-31"><a href="#cb5-31"></a>        CacheDisable <span class="dt">uintptr</span>:<span class="dv">1</span></span>
<span id="cb5-32"><a href="#cb5-32"></a>        WriteThrough <span class="dt">uintptr</span>:<span class="dv">1</span>        <span class="co">// switch for write-through cache</span></span>
<span id="cb5-33"><a href="#cb5-33"></a>        Supervisor   <span class="dt">uintptr</span>:<span class="dv">1</span>        <span class="co">// 1 for all</span></span>
<span id="cb5-34"><a href="#cb5-34"></a>        ReadWrite    <span class="dt">uintptr</span>:<span class="dv">1</span>        <span class="co">// enable to read/write</span></span>
<span id="cb5-35"><a href="#cb5-35"></a>        Present      <span class="dt">uintptr</span>:<span class="dv">1</span>        <span class="co">// whether in physical memory</span></span>
<span id="cb5-36"><a href="#cb5-36"></a>}</span></code></pre></div>
<h2 id="page-directory">Page Directory</h2>
<h2 id="page-table">Page Table</h2>
<h2 id="mmu">MMU</h2>
<p>Handles</p>
<ul class="incremental">
<li>memory translation</li>
<li>memory protection</li>
<li>…</li>
</ul>
<h3 id="translation">Translation</h3>
<p>Convert/map virtual addresses to physical address</p>
<h3 id="protection">Protection</h3>
<p>Process can only see memory that it has, it cannot modify or copy any other application's memory.</p>
<h2 id="higher-half-kernel">Higher Half Kernel</h2>
<p>The kernel is loaded at location x, but when paging is initialized the MMU is told to map location x to 0xC0000000.</p>
<p>Linux's kernel reside at virtual addresses 0xC0000000 - 0xFFFFFFFF of every address space. Leaving the range 0x00000000 - 0xBFFFFFFF for user code, data, stacks, libraries, etc.</p>
<h3 id="why">why</h3>
<ul class="incremental">
<li>to set up VM86 processes since the region below 1MB is userrspace</li>
<li>user applications are not dependent on how much memory is kernel space</li>
<li>..</li>
</ul>
<h1 id="reference">Reference</h1>
<ul class="incremental">
<li><a href="https://wiki.osdev.org/Page_directory#Page_Directory">https://wiki.osdev.org/Page_directory#Page_Directory</a></li>
<li><a href="https://wiki.osdev.org/MMU">https://wiki.osdev.org/MMU</a></li>
<li><a href="https://wiki.osdev.org/Higher_Half_Kernel">https://wiki.osdev.org/Higher_Half_Kernel</a></li>
</ul>

			</div>
		</section>
	</body>
</html>

<!DOCTYPE html>
<html>
	<head>
		<title>docker.org</title>
		<link rel="stylesheet" href="/diary/resources/css/main.css" />
		<link rel="stylesheet" href="/diary/resources/highlight/styles/default.css" />
		<script src="/diary/resources/js/jquery-3.4.1.min.js"></script>
		<script src="/diary/resources/js/swgen.js"></script>
		<script src="/diary/resources/highlight/highlight.pack.js"></script>
		<script src='https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-MML-AM_CHTML' async></script>
		<script>hljs.initHighlightingOnLoad();</script>
	</head>
	<body>
		<nav id='content'>
		</nav>
		<section class="main-article-area">
			<div id='main'>
				<h1 id="docker-compose">docker compose</h1>
<h2 id="overview">Overview</h2>
<ul class="incremental">
<li>Orchestration framework, less useful than kubernetes</li>
<li>A tool for defining and running multi-container Docker applications</li>
<li>Configure with a YAML file</li>
</ul>
<h2 id="basic-steps">Basic Steps</h2>
<ol class="incremental">
<li>Configure Apps use <code>Dockerfile</code></li>
<li>Use <code>docker-compose.yml</code> define services</li>
<li>Run <code>docker-compose up</code> and Compose starts and runs your entire app.</li>
</ol>
<h2 id="lifecycle">Lifecycle</h2>
<ol class="incremental">
<li>Start, stop, and rebuild services</li>
<li>View the status of running services</li>
<li>Stream the log output of running services</li>
<li>Run a one-off command on a service</li>
</ol>
<h1 id="docker-versions"><span class="todo TODO">TODO</span> docker versions</h1>
<h1 id="docker">docker</h1>
<h2 id="overview-1">Overview</h2>
<p>Docker can be treated as different things:</p>
<ol class="incremental">
<li><code>docker</code> command lines</li>
<li>docker service to run container, build image</li>
<li>image format to structure container</li>
</ol>
<p>Docker has some advantages:</p>
<ol class="incremental">
<li>Smaller than virtual machine</li>
<li>Improved performance</li>
<li>Secure (isolated from host)</li>
<li>Flexible (portable)</li>
</ol>
<p>Core concepts:</p>
<ul class="incremental">
<li>build image</li>
<li>run container</li>
<li>network</li>
<li>volume (for persist and data share)</li>
</ul>
<h2 id="build">Build</h2>
<p>Docker image can be built with <code>docker build</code> command which interprete of <code>Dockerfile</code> line by line.</p>
<p>The current directory (named <strong>build context</strong>) will be sent to docker daemon. Build context isolated the avaiable files in current build session.</p>
<p>User can tell docker to ignore some files in build context by writing a <code>.dockerignore</code> file.</p>
<p>With <code>docker build</code> command:</p>
<dl class="incremental">
<dt><code>-f</code></dt>
<dd>specify Dockerifle
</dd>
<dt><code>-t shykes/myapp:1.0.2</code></dt>
<dd>image tag
</dd>
</dl>
<p>Docker build tools is smart enough to</p>
<ul class="incremental">
<li>reuse the intermediate image</li>
<li>custom cache policy (see <em>build cache</em> )</li>
</ul>
<p>Thie first line in Dockerfile is <code>FROM ...</code> normally. That means we always build new image from base image.</p>
<h3 id="dockerignore"><code>.dockerignore</code></h3>
<ul class="incremental">
<li>Aim
<ul class="incremental">
<li>safety</li>
<li>ignore large files</li>
</ul></li>
<li>Syntax
<ul class="incremental">
<li>Based on go <code>filepath.Match</code></li>
<li>Special
<ol class="incremental">
<li><p><code>**</code> match any level directory</p></li>
<li><p><code>?</code> match single letter</p></li>
<li><p><code>!</code> reverse match rules (weird!)</p>
<pre class="text"><code># No markdown files are included in the context except README files other than README-secret.md.
*.md
!README*.md
README-secret.md
</code></pre></li>
</ol></li>
</ul></li>
</ul>
<h3 id="parser-directives">Parser Directives</h3>
<ul class="incremental">
<li>Place at the very top for configure parser rules</li>
<li>Syntax: <code># directive=value</code>
<ul class="incremental">
<li>no duplicate</li>
<li>lowercase</li>
<li>invalid is ignored</li>
<li>ignore after any non-directive instruction</li>
</ul></li>
<li>Directive:
<ul class="incremental">
<li><code>escape=`</code> (Change the default escape <code>\</code> for windows)</li>
</ul></li>
</ul>
<h3 id="environment">Environment</h3>
<p>Use <code>ENV</code> define variables, refer by '$'</p>
<ul class="incremental">
<li><p>Define</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode dockerfile"><code class="sourceCode dockerfile"><span id="cb2-1"><a href="#cb2-1"></a><span class="kw">FROM</span> busybox</span>
<span id="cb2-2"><a href="#cb2-2"></a><span class="kw">ENV</span> foo /bar</span>
<span id="cb2-3"><a href="#cb2-3"></a><span class="kw">WORKDIR</span> ${foo}   <span class="co"># WORKDIR /bar</span></span>
<span id="cb2-4"><a href="#cb2-4"></a><span class="kw">ADD</span> . $foo       <span class="co"># ADD . /bar</span></span>
<span id="cb2-5"><a href="#cb2-5"></a><span class="kw">COPY</span> \$foo /quux <span class="co"># COPY $foo /quux</span></span></code></pre></div></li>
<li><p>Bash like</p>
<ul class="incremental">
<li><code>${var:-word}</code>: if var is not set, then return word</li>
<li><code>${var:+word}</code>: if var is set, return word, else return nil</li>
</ul></li>
</ul>
<h3 id="from-instruction">FROM instruction</h3>
<ul class="incremental">
<li><p>Syntax</p>
<pre class="text"><code>FROM &lt;image&gt; [As &lt;name&gt;]
image: image | image:tag | image@digest
</code></pre></li>
<li><p><code>&lt;name&gt;</code> is used for <code>COPY --from=&lt;name&gt;</code> scenario</p></li>
<li><p>Can be used multiple times</p></li>
<li><p>Prefix with <code>ARGS</code> parameters</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode dockerfile"><code class="sourceCode dockerfile"><span id="cb4-1"><a href="#cb4-1"></a><span class="kw">ARG</span> VERSION=latest</span>
<span id="cb4-2"><a href="#cb4-2"></a><span class="kw">FROM</span> busybox:$VERSION</span>
<span id="cb4-3"><a href="#cb4-3"></a><span class="kw">ARG</span> VERSION</span>
<span id="cb4-4"><a href="#cb4-4"></a><span class="kw">RUN</span> echo $VERSION &gt; image_version</span></code></pre></div></li>
</ul>
<h3 id="run-instruction">RUN instruction</h3>
<ul class="incremental">
<li>Syntax
<ol class="incremental">
<li>sh -c mode: <code>RUN &lt;command&gt;</code></li>
<li>exec mode: <code>RUN ["execution", "param1", "param2"]</code></li>
</ol></li>
<li>Note
<ul class="incremental">
<li>exec mode will be commit in JSON format, string must be quoted</li>
<li>exec mode will not expand container environment variable (which is shell's job)</li>
<li>can split long ocmmand line with '\'</li>
<li>use <code>SHELL</code> command to set which shell to be used</li>
<li>generate new commit cache, use <code>docker build --no-cache</code> to ignore</li>
</ul></li>
</ul>
<h3 id="cmd-instruction">CMD instruction</h3>
<ul class="incremental">
<li>Like <code>RUN</code>, but does not execute anything at build time rather than speficies the intended command for the image</li>
<li>Provide the default command's for run container</li>
<li>Companion with <code>ENTRYPOINT</code></li>
<li>Only last one will take effect</li>
<li>Three formats
<ul class="incremental">
<li>exec form: <code>CMD ["executable", "param1", "param2"]</code></li>
<li>as the default parameters to ENTRYPOINT: <code>CMD ["param1", "param2"]</code></li>
<li>shell form: <code>CMD command param1 param2</code></li>
</ul></li>
</ul>
<h3 id="label-instruction">LABEL instruction</h3>
<ul class="incremental">
<li><p>Add metadata to image</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode dockerfile"><code class="sourceCode dockerfile"><span id="cb5-1"><a href="#cb5-1"></a><span class="kw">LABEL</span> <span class="st">&quot;com.example.vendor&quot;</span>=<span class="st">&quot;ACME Incorporated&quot;</span></span>
<span id="cb5-2"><a href="#cb5-2"></a><span class="kw">LABEL</span> com.example.label-with-value=<span class="st">&quot;foo&quot;</span></span>
<span id="cb5-3"><a href="#cb5-3"></a><span class="kw">LABEL</span> version=<span class="st">&quot;1.0&quot;</span></span>
<span id="cb5-4"><a href="#cb5-4"></a><span class="kw">LABEL</span> description=<span class="st">&quot;This text illustrates </span><span class="op">\</span></span>
<span id="cb5-5"><a href="#cb5-5"></a><span class="st">        that label-values can span multiple lines.&quot;</span></span>
<span id="cb5-6"><a href="#cb5-6"></a><span class="kw">LABEL</span> multi.label1=<span class="st">&quot;value1&quot;</span> multi.label2=<span class="st">&quot;value2&quot;</span> other=<span class="st">&quot;value3&quot;</span></span></code></pre></div></li>
<li><p>Check with <code>docker inspect</code></p></li>
<li><p>Image will inherit base or parent image's labels</p></li>
</ul>
<h3 id="expose-instruction">EXPOSE instruction</h3>
<ul class="incremental">
<li><p>Syntax</p>
<pre class="text"><code>EXPOSE &lt;port&gt; [&lt;port&gt;/&lt;protocol&gt;]
</code></pre></li>
<li><p>Just inform the listen port at runtime, do not publish the port</p></li>
<li><p>Manual publish with <code>docker run -p/-P</code></p>
<div class="sourceCode" id="cb7"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb7-1"><a href="#cb7-1"></a><span class="ex">docker</span> run -p 80:80/tcp -p 80:80/udp</span></code></pre></div></li>
</ul>
<h3 id="env-instruction">ENV instruction</h3>
<ul class="incremental">
<li><p>Syntax</p>
<pre class="text"><code>ENV &lt;key&gt; &lt;value&gt;
ENV &lt;key&gt;=&lt;value&gt; &lt;key&gt;=&lt;value&gt; ...
</code></pre></li>
<li><p>Will be replaced with its value</p></li>
<li><p>Both Dockerfile and runtime (os environment) can see</p></li>
<li><p>Can also set by command line</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb9-1"><a href="#cb9-1"></a><span class="ex">docker</span> run --env <span class="op">&lt;</span>key<span class="op">&gt;</span>=<span class="op">&lt;</span>value<span class="op">&gt;</span></span></code></pre></div></li>
<li><p>Be care for overwriting the SHELL environment, use</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode dockerfile"><code class="sourceCode dockerfile"><span id="cb10-1"><a href="#cb10-1"></a><span class="kw">RUN</span> &lt;key&gt;=&lt;value&gt; &lt;command&gt;</span></code></pre></div></li>
</ul>
<h3 id="add-instruction">ADD instruction</h3>
<ul class="incremental">
<li><p>Copy files/directories/remote-resources to image's destination</p></li>
<li><p>syntax</p>
<pre class="text"><code>ADD [--chown=&lt;user&gt;:&lt;group&gt;] &lt;src&gt;... &lt;dest&gt;
ADD [--chown=&lt;user&gt;:&lt;group&gt;] [&quot;&lt;src&gt;&quot;,... &quot;&lt;dest&gt;&quot;]
</code></pre></li>
<li><p>Default owner is <code>0:0</code></p></li>
<li><p>Rules</p>
<ul class="incremental">
<li>src
<ul class="incremental">
<li>Must inside the context of the build</li>
<li>if src is directory, copy its content</li>
<li>if src is archive file, unpack to destination</li>
</ul></li>
<li>dst
<ul class="incremental">
<li>if with trailing slash, copy file to the directory</li>
<li>if without trailing slash, overwrite destination file</li>
<li>if not exists, create the directory automatically</li>
</ul></li>
</ul></li>
</ul>
<h3 id="copy-instruction"><span class="todo TODO">TODO</span> COPY instruction</h3>
<ul class="incremental">
<li>Almost same in syntax and rules with <code>ADD</code></li>
<li><code>--from=&lt;name|index&gt;</code> set the source location to a previous build stage (<code>FROM .. AS &lt;name&gt;</code>)</li>
<li>vs <code>ADD</code> (TODO)</li>
</ul>
<h3 id="entrypoint-instruction">ENTRYPOINT instruction</h3>
<ul class="incremental">
<li><p>Configure the container to run as an executable</p></li>
<li><p>syntax</p>
<ul class="incremental">
<li>exec form: <code>ENTRYPOINT ["executable", "param1", "param2"]</code></li>
<li>shell form: <code>ENTRYPOINT command param1 param2</code></li>
</ul></li>
<li><p>note</p>
<ol class="incremental">
<li>add <code>exec</code> in shell form for receiving Unix signals, else <code>docker stop</code> will not work</li>
<li>shell form execute with <code>sh -c</code></li>
</ol></li>
<li><p>with <code>CMD</code></p>
<table>
<thead>
<tr class="header">
<th></th>
<th>No ENTRYPOINT</th>
<th>ENTRYPOINT exec<sub>entry</sub> p1<sub>entry</sub></th>
<th>ENTRYPOINT [“exec<sub>entry</sub>”, “p1<sub>entry</sub>”]</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>No CMD</td>
<td>error, not allowed</td>
<td>/bin/sh -c exec<sub>entry</sub> p1<sub>entry</sub></td>
<td>exec<sub>entry</sub> p1<sub>entry</sub></td>
</tr>
<tr class="even">
<td>CMD [“exec<sub>cmd</sub>”, “p1<sub>cmd</sub>”]</td>
<td>exec<sub>cmd</sub> p1<sub>cmd</sub></td>
<td>/bin/sh -c exec<sub>entry</sub> p1<sub>entry</sub></td>
<td>exec<sub>entry</sub> p1<sub>entry</sub> exec<sub>cmd</sub> p1<sub>cmd</sub></td>
</tr>
<tr class="odd">
<td>CMD [“p1<sub>cmd</sub>”, “p2<sub>cmd</sub>”]</td>
<td>p1<sub>cmd</sub> p2<sub>cmd</sub></td>
<td>/bin/sh -c exec<sub>entry</sub> p1<sub>entry</sub></td>
<td>exec<sub>entry</sub> p1<sub>entry</sub> p1<sub>cmd</sub> p2<sub>cmd</sub></td>
</tr>
<tr class="even">
<td>CMD exec<sub>cmd</sub> p1<sub>cmd</sub></td>
<td>/bin/sh -c exec<sub>cmd</sub> p1<sub>cmd</sub></td>
<td>/bin/sh -c exec<sub>entry</sub> p1<sub>entry</sub></td>
<td>exec<sub>entry</sub> p1<sub>entry</sub> /bin/sh -c exec<sub>cmd</sub> p1<sub>cmd</sub></td>
</tr>
</tbody>
</table></li>
</ul>
<h3 id="volume-instruction">VOLUME instruction</h3>
<ul class="incremental">
<li>Create shared volume (anonymous directories) with hosts</li>
<li>Remember to <code>docker run --rm</code> ensure cleaning when quit</li>
<li>Just mount point (can't mount a host directory from within the Dockerfile)</li>
</ul>
<h3 id="user-instruction">USER instruction</h3>
<ul class="incremental">
<li><p>set the user (and group) to use when running the image</p></li>
<li><p>for <code>RUN</code>, <code>CMD</code> and <code>ENTRYPOINT</code> instructions the follow it in the <code>Dockerfile</code></p></li>
<li><p>syntax</p>
<pre class="text"><code>USER &lt;user&gt;[:&lt;group&gt;] or
USER &lt;UID&gt;[:&lt;GID&gt;]
</code></pre></li>
</ul>
<h3 id="build-cache"><span class="todo TODO">TODO</span> build cache</h3>
<p><a href="https://docs.docker.com/engine/userguide/eng-image/dockerfile_best-practices/#build-cache">build cache reference</a></p>
<h3 id="push-a-repository-to-its-registry"><span class="todo TODO">TODO</span> push a repository to its registry</h3>
<p><a href="https://docs.docker.com/engine/tutorials/dockerrepos/#/contributing-to-docker-hub">https://docs.docker.com/engine/tutorials/dockerrepos/#/contributing-to-docker-hub</a></p>
<h3 id="base-image"><span class="todo TODO">TODO</span> base image</h3>
<p><a href="https://docs.docker.com/engine/reference/glossary/#base-image">https://docs.docker.com/engine/reference/glossary/#base-image</a></p>
<h1 id="best-practice"><span class="todo TODO">TODO</span> best practice</h1>
<h2 id="docker-overview">Docker Overview</h2>
<p>Dockerfile instruct docker daemon build image in multiple layers. Then generate a container, you add a new writable layer (container layer) on top of the underlying layers.</p>
<h2 id="general-guidelines-and-recommendations">General guidelines and recommendations</h2>
<h3 id="create-ephemeral-containers">Create ephemeral containers</h3>
<p>To be rebuilt and replaced easily</p>
<h3 id="understand-build-context">Understand build context</h3>
<p>avoid large build context</p>
<h3 id="pipe-dockerfile-through-stdin-docker-17.05-and-higher">Pipe Dockerfile through <code>stdin</code> (Docker 17.05 and higher)</h3>
<p>with local or remote build-context</p>
<h3 id="exclude-with-.dockerignore">Exclude with <code>.dockerignore</code></h3>
<p>similar to <code>.gitignore</code></p>
<h3 id="multi-stage-builds-docker-17.05-or-higher">Multi-stage builds (Docker 17.05 or higher)</h3>
<div class="sourceCode" id="cb13"><pre class="sourceCode dockerfile"><code class="sourceCode dockerfile"><span id="cb13-1"><a href="#cb13-1"></a><span class="kw">FROM</span> golang:1.9.2-alpine3.6 AS build</span>
<span id="cb13-2"><a href="#cb13-2"></a><span class="co">## skip ...</span></span>
<span id="cb13-3"><a href="#cb13-3"></a></span>
<span id="cb13-4"><a href="#cb13-4"></a><span class="kw">FROM</span> scratch</span>
<span id="cb13-5"><a href="#cb13-5"></a><span class="kw">COPY</span> --from=build /bin/project /bin/project</span>
<span id="cb13-6"><a href="#cb13-6"></a><span class="co">## skip ...</span></span></code></pre></div>
<p><a href="https://docs.docker.com/engine/userguide/eng-image/dockerfile_best-practices/">https://docs.docker.com/engine/userguide/eng-image/dockerfile_best-practices/</a></p>
<h3 id="dont-install-unnecessary-packages">Don't install unnecessary packages</h3>
<h1 id="docker-network">docker network</h1>
<h2 id="overview-2">Overview</h2>
<p>Split into 6 categories according to the network drivers</p>
<dl class="incremental">
<dt>bridge</dt>
<dd>default, link layer, port mapping
</dd>
<dt>host</dt>
<dd>virtual host IP
</dd>
<dt>overlay</dt>
<dd>cross multiple hosts
</dd>
<dt>macvlan</dt>
<dd>physical layer, assign MAC
</dd>
<dt>none</dt>
<dd>no network
</dd>
<dt>custom plugins</dt>
<dd>others
</dd>
</dl>
<h2 id="commands">Commands</h2>
<dl class="incremental">
<dt>Create bridge network</dt>
<dd><code>docker network create --driver bridge bridge2</code>
</dd>
<dt>List networks</dt>
<dd><code>docker network ls</code>
</dd>
<dt>Join container to network</dt>
<dd><code>docker network connect &lt;bridge&gt; &lt;container&gt;</code>
</dd>
<dt>Disconnect container from network</dt>
<dd><code>docker network disconnect &lt;bridge&gt; &lt;container&gt;</code>
</dd>
<dt>Delete network</dt>
<dd><code>docker network rm &lt;network&gt;</code>
</dd>
<dt>Inspect network</dt>
<dd><code>docker network inspect bridge</code>
</dd>
</dl>
<h2 id="bridge-network">Bridge Network</h2>
<p>Software bridge network which can isolate from containers not connected to the bridge and can automatically install rules in host OS.</p>
<p>By default, Docker create network named <code>bridge</code>. Check with</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb14-1"><a href="#cb14-1"></a><span class="ex">docker</span> network ls</span></code></pre></div>
<p>User can create his own bridge network which is recommended in production environments:</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb15-1"><a href="#cb15-1"></a><span class="ex">docker</span> network create --driver bridge brg0</span></code></pre></div>
<p>Docker container can join the bridge network by:</p>
<ol class="incremental">
<li><code>docker run</code> with <code>--network &lt;network&gt;</code> parameter</li>
<li>with <code>docker network connect</code> command</li>
</ol>
<p>User-defined bridge network is recommended in production environment:</p>
<ol class="incremental">
<li>better isolation and interoperability between containerized aplications
<ul class="incremental">
<li>expose all ports to each other</li>
<li>expose no ports to the outside world</li>
</ul></li>
<li>automatic DNS resolution between containers (not worked in <code>default</code> bridge)</li>
<li>container can be attached and detached from user-defined network on the fly</li>
<li>configuable</li>
</ol>
<p>On user-defined networks, containers can communicate by container name (<strong>automatic service discovery</strong>) when the container on and only on the same bridge network.</p>
<ul class="incremental">
<li><a href="https://docs.docker.com/network/">https://docs.docker.com/network/</a></li>
</ul>
<h1 id="manage-containers">manage containers</h1>
<ul class="incremental">
<li><a href="https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux_atomic_host/7/html-single/managing_containers/">https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux_atomic_host/7/html-single/managing_containers/</a></li>
</ul>
<h2 id="attach-with-detach"><span class="todo TODO">TODO</span> attach with detach</h2>
<h2 id="parameters-in-docker-run">parameters in <code>docker run</code></h2>
<dl class="incremental">
<dt><code>-d</code></dt>
<dd>deteached (in the background)
</dd>
<dt><code>-i</code></dt>
<dd>interactive
</dd>
<dt><code>-t</code></dt>
<dd>TTY (can see Input and Output)
</dd>
</dl>
<h1 id="docker-volume">docker volume</h1>
<ul class="incremental">
<li><a href="https://docs.docker.com/engine/tutorials/dockervolumes/#/mount-a-host-directory-as-a-data-volume">Share Directories via Volumes</a></li>
<li><a href="https://docs.docker.com/storage/storagedriver/">About Storage Driver</a></li>
</ul>
<h1 id="how-to">how to</h1>
<h2 id="stop-container">stop container</h2>
<p>Stop and delete container</p>
<ol class="incremental">
<li><code>docker container stop &lt;container-id&gt;</code></li>
<li><code>docker container rm &lt;container-id&gt;</code></li>
</ol>
<p>Or start with <code>--rm</code> parameter in <code>docker run</code></p>

			</div>
		</section>
	</body>
</html>

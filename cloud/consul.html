<!DOCTYPE html>
<html>
	<head>
		<title>consul.org</title>
		<link rel="stylesheet" href="/diary/resources/css/main.css" />
		<link rel="stylesheet" href="/diary/resources/highlight/styles/default.css" />
		<script src="/diary/resources/js/jquery-3.4.1.min.js"></script>
		<script src="/diary/resources/js/swgen.js"></script>
		<script src="/diary/resources/highlight/highlight.pack.js"></script>
		<script src='https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-MML-AM_CHTML' async></script>
		<script>hljs.initHighlightingOnLoad();</script>
	</head>
	<body>
		<nav id='content'>
		</nav>
		<section class="main-article-area">
			<div id='main'>
				<h1 id="overview">Overview</h1>
<h2 id="什么是-consul">什么是 Consul？</h2>
<div class="line-block">Consul is a service mesh solution providing a full featured control plane with service discovery, configuration,<br />
and segmentation functionality.<br />
<br />
Consul requires a data plane and supports both a proxy and native integration model. Consul ships with a simple<br />
built-in proxy so that everything works out of the box, but also supports 3rd party proxy integrations such as Envoy.</div>
<h3 id="服务发现">服务发现</h3>
<p>提供者注册服务信息，使用者查找具体的服务地址。支持 DNS 和 HTTP 两种方式。</p>
<p>类似于一个公告栏机制。</p>
<h3 id="health-checking">Health Checking</h3>
<p>Agent 内置了 Health Check 功能，可以配置对 service 或 node 定期检查</p>
<ol class="incremental">
<li>ops 维护 consul 集群</li>
<li>服务使用者跳过不健康的服务或主机</li>
</ol>
<h3 id="secure-service-communication"><span class="todo TODO">TODO</span> Secure Service Communication</h3>
<ol class="incremental">
<li><p><span class="todo TODO">TODO</span> Intentions</p></li>
</ol>
<h3 id="multi-datacenter"><span class="todo TODO">TODO</span> Multi Datacenter</h3>
<h2 id="consul-可以用来做什么">Consul 可以用来做什么？</h2>
<h1 id="architecture">Architecture</h1>
<ul class="incremental">
<li>Agent
<ul class="incremental">
<li>检查当前 Node 上的 service 和 node 的健康状态</li>
<li>与其它 Server 通信 (通过任何一个 agent 可以访问到所有 Server)</li>
</ul></li>
<li>Server
<ul class="incremental">
<li>保存数据</li>
<li>副本同步</li>
<li>选举 Leader</li>
</ul></li>
<li>Data Center
<ul class="incremental">
<li>一组 Server 构成 Cluster</li>
<li>DC 之间可以转发消息</li>
</ul></li>
</ul>
<h1 id="service">Service</h1>
<p>注册一个服务（ID 和 TAG）指向本机的某个端口？客户端需要查找具体的服务地址再自行去访问？ Server 本质只是个特殊格式的注册信息？注册的服务必须通过 Agent 来访问？注册的服务仅针对某个 Agent?</p>
<h2 id="配置">配置</h2>
<p>在配置目录（通过 <code>-config-dir</code> 来传入），定义服务 Route 信息</p>
<pre class="yam"><code>service:
  name: web
  tags:
  - rails
  port: 80
</code></pre>
<p>注意：</p>
<ul class="incremental">
<li>每个 json 文件配置一个服务</li>
<li>可以有多个服务</li>
<li>启动后显示 <code>Syned</code> 表示 agent 已经加载了服务定义并注册到 catalog(?)</li>
<li>tag?</li>
</ul>
<h2 id="query">Query</h2>
<p>两种方式：DNS API 或 HTTP API</p>
<h3 id="dns-api"><span class="todo TODO">TODO</span> DNS API</h3>
<ol class="incremental">
<li><p>A Record</p>
<pre class="shell"><code>$ dig @127.0.0.1 -p 8600 web.service.consul

;; QUESTION SECTION:
;web.service.consul.        IN  A

;; ANSWER SECTION:
web.service.consul. 0   IN  A   127.0.0.1
</code></pre>
<p>有什么用？怎么样传入参数？怎么样返回结果？怎么样调用具体的服务代码？</p></li>
<li><p>SRV</p>
<pre class="shell"><code>$ dig @127.0.0.1 -p 8600 web.service.consul SRV

;; QUESTION SECTION:
;web.service.consul.        IN  SRV

;; ANSWER SECTION:
web.service.consul. 0   IN  SRV 1 1 80 Armons-MacBook-Air.node.dc1.consul.

;; ADDITIONAL SECTION:
Armons-MacBook-Air.node.dc1.consul. 0 IN A  127.0.0.1
</code></pre>
<p>SRV 记录的地址是 consul 运行的主机地址？端口 80？有什么用？</p></li>
<li><p>TAG</p>
<pre class="shell"><code>$ dig @127.0.0.1 -p 8600 rails.web.service.consul

;; QUESTION SECTION:
;rails.web.service.consul.      IN  A

;; ANSWER SECTION:
rails.web.service.consul.   0   IN  A   127.0.0.1
</code></pre>
<p>TAG? 子域名？</p></li>
</ol>
<h3 id="http-api">HTTP API</h3>
<ol class="incremental">
<li><p>query</p>
<pre class="shell"><code>$ curl http://localhost:8500/v1/catalog/service/web

[{&quot;Node&quot;:&quot;Armons-MacBook-Air&quot;,&quot;Address&quot;:&quot;172.20.20.11&quot;,&quot;ServiceID&quot;:&quot;web&quot;, \
    &quot;ServiceName&quot;:&quot;web&quot;,&quot;ServiceTags&quot;:[&quot;rails&quot;],&quot;ServicePort&quot;:80}]
</code></pre></li>
<li><p>health check</p>
<pre class="shell"><code>$ curl &#39;http://localhost:8500/v1/health/service/web?passing&#39;

[{&quot;Node&quot;:&quot;Armons-MacBook-Air&quot;,&quot;Address&quot;:&quot;172.20.20.11&quot;,&quot;Service&quot;:{ \
    &quot;ID&quot;:&quot;web&quot;, &quot;Service&quot;:&quot;web&quot;, &quot;Tags&quot;:[&quot;rails&quot;],&quot;Port&quot;:80}, &quot;Checks&quot;: ...}]
</code></pre></li>
</ol>
<h2 id="更新配置">更新配置</h2>
<ol class="incremental">
<li>修改配置，发送 SIGHUP(1) 到 console agent 进程重新加载配置</li>
<li>使用 consule reload 命令（同上）</li>
<li>或者使用 REST API 来动态修改配置</li>
</ol>
<h2 id="service-type"><span class="todo TODO">TODO</span> Service Type</h2>
<h2 id="service-instances"><span class="todo TODO">TODO</span> Service instances</h2>
<h1 id="nodes">Nodes</h1>
<h1 id="keyvalues">Key/Values</h1>
<p>类似于 zookeeper，按目录层次来划分不同的应用和种类</p>
<h1 id="connect">Connect</h1>
<h2 id="为什么要联结两个-service"><span class="todo TODO">TODO</span> 为什么要联结两个 Service?</h2>
<p>提供一种 Route 方式？客户端直接访问 Consul 提供的 Service 就能直接被定位到底层服务？</p>
<p>代理？针对 HTTP 还是 TCP？</p>
<p>提供 TLS 接口，底层可以不加密</p>
<h2 id="怎么联结两个-service"><span class="todo TODO">TODO</span> 怎么联结两个 Service?</h2>
<p>需要启动一个代理程序？为每个 Connect?</p>
<p>如何配置 TLS 连接？</p>
<h2 id="demo1">Demo1</h2>
<h3 id="run-service">Run service</h3>
<pre class="shell"><code>$ socat -v tcp-l:8181,fork exec:&quot;/bin/cat&quot;
</code></pre>
<p>echo server, listen on TCP 8181 port</p>
<h3 id="register-service">Register service</h3>
<div class="sourceCode" id="cb8"><pre class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb8-1"><a href="#cb8-1"></a><span class="fu">service</span><span class="kw">:</span></span>
<span id="cb8-2"><a href="#cb8-2"></a><span class="at">  </span><span class="fu">connect</span><span class="kw">:</span></span>
<span id="cb8-3"><a href="#cb8-3"></a><span class="at">    </span><span class="fu">sidecar_service</span><span class="kw">:</span><span class="at"> </span><span class="kw">{}</span></span>
<span id="cb8-4"><a href="#cb8-4"></a><span class="at">  </span><span class="fu">name</span><span class="kw">:</span><span class="at"> socat</span></span>
<span id="cb8-5"><a href="#cb8-5"></a><span class="at">  </span><span class="fu">port</span><span class="kw">:</span><span class="at"> </span><span class="dv">8181</span></span></code></pre></div>
<p>注册一个新服务 socat，其中 <code>connect</code> 字段要求 Consul 注册一个 sidecar proxy</p>
<ol class="incremental">
<li>监听一个随机端口</li>
<li>TLS 认证连接</li>
<li>转发到 8181 服务</li>
</ol>
<p>注意：此时还没有真正运行 sidecar proxy</p>
<h3 id="启动-proxy">启动 proxy</h3>
<div class="sourceCode" id="cb9"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb9-1"><a href="#cb9-1"></a>$ <span class="ex">consul</span> connect proxy -sidecar-for socat</span>
<span id="cb9-2"><a href="#cb9-2"></a>==<span class="op">&gt;</span> <span class="ex">Consul</span> Connect proxy starting...</span>
<span id="cb9-3"><a href="#cb9-3"></a>    <span class="ex">Configuration</span> mode: Agent API</span>
<span id="cb9-4"><a href="#cb9-4"></a>        <span class="ex">Sidecar</span> for ID: socat</span>
<span id="cb9-5"><a href="#cb9-5"></a>              <span class="ex">Proxy</span> ID: socat-sidecar-proxy</span>
<span id="cb9-6"><a href="#cb9-6"></a></span>
<span id="cb9-7"><a href="#cb9-7"></a><span class="ex">...</span></span></code></pre></div>
<h3 id="建立连接">建立连接</h3>
<div class="sourceCode" id="cb10"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb10-1"><a href="#cb10-1"></a>$ <span class="ex">consul</span> connect proxy -service web -upstream socat:9191</span>
<span id="cb10-2"><a href="#cb10-2"></a>==<span class="op">&gt;</span> <span class="ex">Consul</span> Connect proxy starting...</span>
<span id="cb10-3"><a href="#cb10-3"></a>    <span class="ex">Configuration</span> mode: Flags</span>
<span id="cb10-4"><a href="#cb10-4"></a>               <span class="ex">Service</span>: web</span>
<span id="cb10-5"><a href="#cb10-5"></a>              <span class="ex">Upstream</span>: socat =<span class="op">&gt;</span> :9191</span>
<span id="cb10-6"><a href="#cb10-6"></a>       <span class="ex">Public</span> listener: Disabled</span>
<span id="cb10-7"><a href="#cb10-7"></a></span>
<span id="cb10-8"><a href="#cb10-8"></a><span class="ex">...</span></span></code></pre></div>
<ol class="incremental">
<li>启动一个新的服务 web</li>
<li>web 依赖于 socat 服务，端口是 9191</li>
<li>访问本地 9191 的流量将被定向到 socat 端口</li>
</ol>
<h2 id="demo2-registering-a-dependent-service">Demo2 :Registering a Dependent Service</h2>
<p>创建一个 web 服务（上例用的是 <code>consul connect proxy</code> ，仅用于临时调试）</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb11-1"><a href="#cb11-1"></a><span class="fu">service</span><span class="kw">:</span></span>
<span id="cb11-2"><a href="#cb11-2"></a><span class="at">  </span><span class="fu">connect</span><span class="kw">:</span></span>
<span id="cb11-3"><a href="#cb11-3"></a><span class="at">    </span><span class="fu">sidecar_service</span><span class="kw">:</span></span>
<span id="cb11-4"><a href="#cb11-4"></a><span class="at">      </span><span class="fu">proxy</span><span class="kw">:</span></span>
<span id="cb11-5"><a href="#cb11-5"></a><span class="at">        </span><span class="fu">upstreams</span><span class="kw">:</span></span>
<span id="cb11-6"><a href="#cb11-6"></a><span class="at">        </span><span class="kw">-</span><span class="at"> </span><span class="fu">destination_name</span><span class="kw">:</span><span class="at"> socat</span></span>
<span id="cb11-7"><a href="#cb11-7"></a><span class="at">          </span><span class="fu">local_bind_port</span><span class="kw">:</span><span class="at"> </span><span class="dv">9191</span></span>
<span id="cb11-8"><a href="#cb11-8"></a><span class="at">  </span><span class="fu">name</span><span class="kw">:</span><span class="at"> web</span></span>
<span id="cb11-9"><a href="#cb11-9"></a><span class="at">  </span><span class="fu">port</span><span class="kw">:</span><span class="at"> </span><span class="dv">8080</span></span></code></pre></div>
<p>加 <code>-sidecar-for</code> 生成 proxy</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb12-1"><a href="#cb12-1"></a>$ <span class="ex">consul</span> connect proxy -sidecar-for web</span>
<span id="cb12-2"><a href="#cb12-2"></a>==<span class="op">&gt;</span> <span class="ex">Consul</span> Connect proxy starting...</span>
<span id="cb12-3"><a href="#cb12-3"></a>    <span class="ex">Configuration</span> mode: Agent API</span>
<span id="cb12-4"><a href="#cb12-4"></a>        <span class="ex">Sidecar</span> for ID: web</span>
<span id="cb12-5"><a href="#cb12-5"></a>              <span class="ex">Proxy</span> ID: web-sidecar-proxy</span>
<span id="cb12-6"><a href="#cb12-6"></a></span>
<span id="cb12-7"><a href="#cb12-7"></a>==<span class="op">&gt;</span> <span class="ex">Log</span> data will now stream in as it occurs:</span>
<span id="cb12-8"><a href="#cb12-8"></a></span>
<span id="cb12-9"><a href="#cb12-9"></a>    <span class="ex">2018/10/09</span> 12:34:20 [INFO] 127.0.0.1:9191-<span class="op">&gt;</span>service:default/socat starting on 127.0.0.1:9191</span>
<span id="cb12-10"><a href="#cb12-10"></a>    <span class="ex">2018/10/09</span> 12:34:20 [INFO] Proxy loaded config and ready to serve</span>
<span id="cb12-11"><a href="#cb12-11"></a>    <span class="ex">2018/10/09</span> 12:34:20 [INFO] TLS Identity: spiffe://df34ef6b-5971-ee61-0790-ca8622c3c287.consul/ns/default/dc/dc1/svc/web</span>
<span id="cb12-12"><a href="#cb12-12"></a>    <span class="ex">2018/10/09</span> 12:34:20 [INFO] TLS Roots   : [Consul CA 7]</span></code></pre></div>
<p>为什么 web 监听 8080，sidecar proxy 监听 9191。与 web 服务本身有无关系？</p>
<h1 id="intentions-1">Intentions</h1>
<p>ACL 设置，控制服务之间的访问</p>
<pre><code>$ consul intention create -deny web socat
Created: web =&gt; socat (deny)
</code></pre>
<p>禁止 web 到 socat 的通信</p>
<h1 id="cluster">Cluster</h1>
<h1 id="problem"><span class="todo TODO">TODO</span> Problem</h1>
<h2 id="server">Server</h2>
<h3 id="如何相互发现">如何相互发现</h3>
<h3 id="如何协作">如何协作</h3>
<h2 id="client">Client</h2>
<h3 id="作用">作用</h3>
<ol class="incremental">
<li>register services ?</li>
<li>run health check</li>
<li>forwards queries to servers ?</li>
</ol>
<h3 id="协议">协议</h3>
<h2 id="gossip-protocol">Gossip Protocol</h2>
<h2 id="dns-interface">DNS Interface</h2>
<h2 id="rest-api">REST API</h2>
<p>8500 端口</p>
<h3 id="catalog">catalog</h3>
<ol class="incremental">
<li><p>nodes</p></li>
</ol>
<h2 id="guess">Guess</h2>
<h3 id="agent">agent</h3>
<ul class="incremental">
<li><code>consul agent</code> 同时启动了 server 和 client？</li>
<li>其中 server 提供 raft 支持</li>
<li>client 提供接口</li>
</ul>
<h2 id="agent-1">Agent</h2>
<p>Agent 到底是单指 client，还是同时指 server?</p>

			</div>
		</section>
	</body>
</html>


	<!DOCTYPE html>
	<html>
		<head>
			<title>k8s.org</title>
			<link rel="stylesheet" href="/diary/resources/css/main.css" />
			<script src="/diary/resources/js/jquery-3.4.1.min.js"></script>
			<script src="/diary/resources/js/swgen.js"></script>
		</head>
		<body>
			<nav id='content'>
				<ul><li><details><summary>algorithm</summary><ul><li><details><summary>introduction-to-algorithm</summary><ul><li><a href='/diary/algorithm/introduction-to-algorithm/sort.html'>sort.org</a></li></ul></details></li><li><a href='/diary/algorithm/string-match.html'>string-match.org</a></li></ul></details></li><li><details><summary>blog</summary><ul><li><a href='/diary/blog/rescure-libc-deleted.html'>rescure-libc-deleted.org</a></li><li><a href='/diary/blog/timezone.html'>timezone.org</a></li></ul></details></li><li><details><summary>book</summary><ul><li><a href='/diary/book/git%e6%95%99%e7%a8%8b.html'>git教程.org</a></li><li><a href='/diary/book/go%e8%af%ad%e8%a8%80%e7%bc%96%e7%a8%8b.html'>go语言编程.org</a></li><li><a href='/diary/book/javascript%e5%85%a8%e6%a0%88%e6%95%99%e7%a8%8b.html'>javascript全栈教程.org</a></li><li><a href='/diary/book/rich-dad-and-poor-dad.html'>rich-dad-and-poor-dad.org</a></li><li><a href='/diary/book/%e4%ba%ba%e7%b1%bb%e7%ae%80%e5%8f%b2%e2%80%94%e2%80%94%e4%bb%8e%e5%8a%a8%e7%89%a9%e5%88%b0%e4%b8%8a%e5%b8%9d.html'>人类简史——从动物到上帝.org</a></li><li><details><summary>春秋史话</summary><ul><li><a href='/diary/book/%e6%98%a5%e7%a7%8b%e5%8f%b2%e8%af%9d/%e6%98%a5%e7%a7%8b%e5%8f%b2%e8%af%9d.html'>春秋史话.org</a></li></ul></details></li><li><a href='/diary/book/%e8%9a%8a%e5%ad%90%e5%b9%b2%e5%98%9b%e8%80%81%e5%8f%ae%e6%88%91.html'>蚊子干嘛老叮我.org</a></li></ul></details></li><li><details><summary>cloud</summary><ul><li><a href='/diary/cloud/docker.html'>docker.org</a></li><li><a href='/diary/cloud/gcp.html'>gcp.org</a></li><li><a href='/diary/cloud/gke.html'>gke.org</a></li><li><a href='/diary/cloud/helm.html'>helm.org</a></li><li><details><summary>kubernetes</summary><ul><li><a href='/diary/cloud/kubernetes/README.html'>README.org</a></li><li><a href='/diary/cloud/kubernetes/cloudman.html'>cloudman.org</a></li><li><a href='/diary/cloud/kubernetes/content.html'>content.org</a></li><li><a href='/diary/cloud/kubernetes/controller.html'>controller.org</a></li><li><a href='/diary/cloud/kubernetes/golang.html'>golang.org</a></li><li><a href='/diary/cloud/kubernetes/k8s.html'>k8s.org</a></li><li><a href='/diary/cloud/kubernetes/kubeadm.html'>kubeadm.org</a></li><li><a href='/diary/cloud/kubernetes/kuberbuilder.html'>kuberbuilder.org</a></li><li><a href='/diary/cloud/kubernetes/kubernetes-guide.html'>kubernetes-guide.org</a></li><li><a href='/diary/cloud/kubernetes/operator.html'>operator.org</a></li><li><a href='/diary/cloud/kubernetes/rbac.html'>rbac.org</a></li><li><a href='/diary/cloud/kubernetes/registry.html'>registry.org</a></li><li><a href='/diary/cloud/kubernetes/todo.html'>todo.org</a></li><li><a href='/diary/cloud/kubernetes/tutorial.html'>tutorial.org</a></li><li><a href='/diary/cloud/kubernetes/what-is-container.html'>what-is-container.org</a></li></ul></details></li></ul></details></li><li><details><summary>csapp</summary><ul><li><a href='/diary/csapp/csapp-digest.html'>csapp-digest.org</a></li><li><a href='/diary/csapp/cscpp.html'>cscpp.org</a></li></ul></details></li><li><a href='/diary/docker.html'>docker.org</a></li><li><details><summary>emacs</summary><ul><li><a href='/diary/emacs/orgmode.html'>orgmode.org</a></li></ul></details></li><li><details><summary>history</summary><ul><li><a href='/diary/history/%e5%85%a8%e7%90%83%e9%80%9a%e5%8f%b2.html'>全球通史.org</a></li><li><a href='/diary/history/%e5%8d%97%e5%8c%97%e6%9c%9d.html'>南北朝.org</a></li><li><a href='/diary/history/%e6%99%8b%e5%8f%b2.html'>晋史.org</a></li></ul></details></li><li><a href='/diary/index.html'>index.org</a></li><li><details><summary>linux</summary><ul><li><a href='/diary/linux/centos.html'>centos.org</a></li><li><a href='/diary/linux/filesystem.html'>filesystem.org</a></li><li><a href='/diary/linux/init.d.html'>init.d.org</a></li><li><a href='/diary/linux/iptables.html'>iptables.org</a></li><li><a href='/diary/linux/linuxcast.html'>linuxcast.org</a></li><li><a href='/diary/linux/ss.html'>ss.org</a></li><li><a href='/diary/linux/suse.html'>suse.org</a></li><li><a href='/diary/linux/vps.html'>vps.org</a></li></ul></details></li><li><details><summary>literal</summary><ul><li><a href='/diary/literal/book.html'>book.org</a></li><li><a href='/diary/literal/han.html'>han.org</a></li><li><a href='/diary/literal/movie.html'>movie.org</a></li><li><a href='/diary/literal/nounce.html'>nounce.org</a></li><li><a href='/diary/literal/person.html'>person.org</a></li><li><a href='/diary/literal/%e5%9f%ba%e7%9d%a3%e5%b1%b1%e4%bc%af%e7%88%b5.html'>基督山伯爵.org</a></li></ul></details></li><li><details><summary>math</summary><ul><li><a href='/diary/math/%e6%a6%82%e7%8e%87%e8%ae%ba%e4%b8%8e%e6%95%b0%e7%90%86%e7%bb%9f%e8%ae%a1.html'>概率论与数理统计.org</a></li></ul></details></li><li><a href='/diary/mindmap.html'>mindmap.org</a></li><li><details><summary>misc</summary><ul><li><a href='/diary/misc/org-usage.html'>org-usage.org</a></li><li><a href='/diary/misc/screen.html'>screen.org</a></li></ul></details></li><li><details><summary>network</summary><ul><li><a href='/diary/network/ssl.html'>ssl.org</a></li></ul></details></li><li><a href='/diary/opengl.html'>opengl.org</a></li><li><a href='/diary/orgmode.html'>orgmode.org</a></li><li><details><summary>os</summary><ul><li><a href='/diary/os/80386.html'>80386.org</a></li><li><a href='/diary/os/8259a.html'>8259a.org</a></li><li><a href='/diary/os/boot.html'>boot.org</a></li><li><a href='/diary/os/gcc-inline-asm.html'>gcc-inline-asm.md</a></li><li><a href='/diary/os/linux.html'>linux.org</a></li></ul></details></li><li><details><summary>policy</summary><ul><li><a href='/diary/policy/%e5%85%a8%e7%90%83%e5%8c%96%e6%b3%a2%e6%8a%98%e4%b8%8e%e6%b0%91%e8%90%a5%e7%bb%8f%e6%b5%8e%e7%9a%84%e6%9c%aa%e6%9d%a5_%e5%91%a8%e5%85%b6%e4%bb%81.html'>全球化波折与民营经济的未来_周其仁.org</a></li></ul></details></li><li><details><summary>programming</summary><ul><li><details><summary>algorithm</summary><ul><li><details><summary>algorithm4th</summary><ul><li><a href='/diary/programming/algorithm/algorithm4th/algorithm.html'>algorithm.org</a></li></ul></details></li><li><a href='/diary/programming/algorithm/%e5%b0%8f%e7%94%b2%e9%b1%bc-%e6%95%b0%e6%8d%ae%e7%bb%93%e6%9e%84%e4%b8%8e%e7%ae%97%e6%b3%95-%e8%a7%86%e9%a2%91%e7%ac%94%e8%ae%b0.html'>小甲鱼-数据结构与算法-视频笔记.org</a></li></ul></details></li><li><details><summary>clojure</summary><ul><li><a href='/diary/programming/clojure/clojure.tools.logging.html'>clojure.tools.logging.md</a></li></ul></details></li><li><details><summary>cpp</summary><ul><li><a href='/diary/programming/cpp/tutorials.html'>tutorials.org</a></li></ul></details></li><li><details><summary>elasticsearch</summary><ul><li><a href='/diary/programming/elasticsearch/elasticsearch-definitive-guide-note.html'>elasticsearch-definitive-guide-note.org</a></li></ul></details></li><li><details><summary>git</summary><ul><li><a href='/diary/programming/git/git.html'>git.org</a></li></ul></details></li><li><details><summary>golang</summary><ul><li><a href='/diary/programming/golang/cmd.html'>cmd.org</a></li><li><a href='/diary/programming/golang/effective-go.html'>effective-go.org</a></li><li><a href='/diary/programming/golang/go-concurrency.html'>go-concurrency.org</a></li><li><a href='/diary/programming/golang/how-to-write-go-code.html'>how-to-write-go-code.org</a></li><li><a href='/diary/programming/golang/json.html'>json.org</a></li><li><details><summary>learn-go-note</summary><ul><li><a href='/diary/programming/golang/learn-go-note/learning-go.html'>learning-go.org</a></li></ul></details></li><li><a href='/diary/programming/golang/library.html'>library.org</a></li><li><a href='/diary/programming/golang/misc.html'>misc.org</a></li><li><a href='/diary/programming/golang/reflect.html'>reflect.org</a></li><li><a href='/diary/programming/golang/template.html'>template.org</a></li><li><a href='/diary/programming/golang/the-little-go-book.html'>the-little-go-book.org</a></li><li><a href='/diary/programming/golang/%e6%97%a0%e9%97%bb%e8%a7%86%e9%a2%91%e7%ac%94%e8%ae%b0.html'>无闻视频笔记.org</a></li></ul></details></li><li><details><summary>hadoop</summary><ul><li><a href='/diary/programming/hadoop/hdfs-permission-guide-note.html'>hdfs-permission-guide-note.org</a></li></ul></details></li><li><details><summary>java</summary><ul><li><a href='/diary/programming/java/derby.html'>derby.org</a></li><li><a href='/diary/programming/java/ivy-vs-maven.html'>ivy-vs-maven.org</a></li><li><a href='/diary/programming/java/java-note.html'>java-note.org</a></li><li><a href='/diary/programming/java/maven.html'>maven.org</a></li><li><a href='/diary/programming/java/servlet.html'>servlet.org</a></li><li><a href='/diary/programming/java/thing-java.html'>thing-java.org</a></li><li><a href='/diary/programming/java/%e6%b7%b1%e5%85%a5%e7%90%86%e8%a7%a3java%e8%99%9a%e6%8b%9f%e6%9c%ba.html'>深入理解java虚拟机.org</a></li></ul></details></li><li><details><summary>javascript</summary><ul><li><a href='/diary/programming/javascript/angularjs.html'>angularjs.org</a></li><li><a href='/diary/programming/javascript/dom.html'>dom.org</a></li></ul></details></li><li><a href='/diary/programming/javascript.html'>javascript.org</a></li><li><details><summary>lisp</summary><ul><li><a href='/diary/programming/lisp/the-little-schemer.html'>the-little-schemer.org</a></li></ul></details></li><li><details><summary>python</summary><ul><li><a href='/diary/programming/python/asyncio.html'>asyncio.org</a></li><li><a href='/diary/programming/python/flask.html'>flask.org</a></li><li><a href='/diary/programming/python/idiomatic-python-note.html'>idiomatic-python-note.org</a></li><li><a href='/diary/programming/python/jinja2.html'>jinja2.org</a></li><li><a href='/diary/programming/python/package-manage.html'>package-manage.org</a></li><li><a href='/diary/programming/python/pygame.html'>pygame.org</a></li><li><a href='/diary/programming/python/tools.html'>tools.org</a></li></ul></details></li><li><details><summary>scala</summary><ul><li><a href='/diary/programming/scala/programming-in-scala.html'>programming-in-scala.org</a></li><li><a href='/diary/programming/scala/scala.html'>scala.org</a></li><li><a href='/diary/programming/scala/scalikeJDBC.html'>scalikeJDBC.org</a></li></ul></details></li><li><a href='/diary/programming/storm.html'>storm.org</a></li><li><a href='/diary/programming/thrift.html'>thrift.org</a></li><li><a href='/diary/programming/typescript.html'>typescript.org</a></li><li><details><summary>web</summary><ul><li><a href='/diary/programming/web/liquid.html'>liquid.org</a></li></ul></details></li></ul></details></li><li><details><summary>rdbms</summary><ul><li><a href='/diary/rdbms/rdbms.html'>rdbms.org</a></li></ul></details></li><li><details><summary>resource</summary><ul><li><a href='/diary/resource/emacs.html'>emacs.md</a></li><li><a href='/diary/resource/ml-resource.html'>ml-resource.md</a></li><li><a href='/diary/resource/nlp-resource.html'>nlp-resource.md</a></li></ul></details></li><li><details><summary>services</summary><ul><li><details><summary>mail</summary><ul><li><a href='/diary/services/mail/mail.html'>mail.org</a></li></ul></details></li></ul></details></li><li><details><summary>subtitle</summary><ul><li><a href='/diary/subtitle/docker.html'>docker.org</a></li></ul></details></li><li><details><summary>toarous</summary><ul><li><a href='/diary/toarous/README.html'>README.md</a></li><li><a href='/diary/toarous/idt.html'>idt.md</a></li><li><a href='/diary/toarous/intel.html'>intel.org</a></li><li><a href='/diary/toarous/notes.html'>notes.org</a></li><li><a href='/diary/toarous/osx-environment.html'>osx-environment.org</a></li><li><a href='/diary/toarous/vga.html'>vga.md</a></li></ul></details></li><li><details><summary>tools</summary><ul><li><a href='/diary/tools/GCP.html'>GCP.org</a></li><li><a href='/diary/tools/ansible.html'>ansible.org</a></li><li><a href='/diary/tools/bash.html'>bash.org</a></li><li><a href='/diary/tools/gerrit.html'>gerrit.org</a></li><li><a href='/diary/tools/git.html'>git.org</a></li><li><a href='/diary/tools/gpg.html'>gpg.org</a></li><li><a href='/diary/tools/markdown.html'>markdown.org</a></li><li><a href='/diary/tools/nginx.html'>nginx.org</a></li><li><a href='/diary/tools/rpm.html'>rpm.org</a></li><li><a href='/diary/tools/spark.html'>spark.org</a></li><li><a href='/diary/tools/tmux.html'>tmux.org</a></li></ul></details></li><li><details><summary>ui</summary><ul><li><a href='/diary/ui/react.html'>react.org</a></li><li><a href='/diary/ui/tk.html'>tk.org</a></li></ul></details></li><li><details><summary>web</summary><ul><li><a href='/diary/web/chrome-extension.html'>chrome-extension.org</a></li></ul></details></li><li><a href='/diary/words.html'>words.org</a></li><li><a href='/diary/%e7%bd%91%e6%b0%91%e7%9a%84%e7%8b%82%e6%ac%a2.html'>网民的狂欢.org</a></li></ul>
			</nav>
			<section class="main-article-area">
				<div id='main'>
					<h1 id="overview">Overview</h1>
<p>Kubernetes Control Plane (aka Kubernetes) consists of</p>
<ol class="incremental">
<li>Master</li>
<li>Node</li>
</ol>
<p>And the major works of kubernetes are:</p>
<ol class="incremental">
<li>execute instructions (interact)</li>
<li>making the cluster's actual state match the desired state (maintain)</li>
</ol>
<p>We interact with Kubernetes cluster and check the status of Kubernetes with API. <code>kubectl</code> is a command line tools for interaction. We can write yaml files in API specification, and the kubectl will convert it to json format and submit to kubernetes' components.</p>
<p>Kubernetes would maintain the status of cluster and jobs, such like</p>
<ol class="incremental">
<li>start or restart containers</li>
<li>scaling the number of replicas of an Application</li>
</ol>
<h2 id="master">Master</h2>
<p>Consists of three process:</p>
<ol class="incremental">
<li><code>kube-apiserver</code></li>
<li><code>kube-controller-manager</code></li>
<li><code>kube-scheduler</code></li>
</ol>
<h2 id="node">Node</h2>
<p>Node components run on every node</p>
<ol class="incremental">
<li>maintain running Pods</li>
<li>provide the Kubernetes runtime environment</li>
</ol>
<p>On each node, there're several components running:</p>
<ol class="incremental">
<li>kubelet: Run container as the rules of <code>PodSpecs</code></li>
<li>kube-proxy: maintain network configuration for supporting Service</li>
<li>container runtime: docker, rkt, OCI runtime-spec</li>
</ol>
<h2 id="feature">Feature</h2>
<p>From <a href="https://courses.edx.org/courses/course-v1:LinuxFoundationX+LFS158x+1T2018/courseware/8835181d87b046b697603bd83f242f16/669a580b34764a0cadee817202b8c74a/?child=first">Kubernetes Features I</a> and <a href="https://courses.edx.org/courses/course-v1:LinuxFoundationX+LFS158x+1T2018/courseware/8835181d87b046b697603bd83f242f16/669a580b34764a0cadee817202b8c74a/?child=first">Kubernetes Feature II</a></p>
<dl class="incremental">
<dt>Automatic binpacking</dt>
<dd>Kubernetes automatically schedules the containers based on resource usage and constraints, without sacrificing the availability
</dd>
<dt>Self-healing</dt>
<dd>Kubernetes automatically replaces and reschedules the containers from failed nodes. It also kills and restarts the containers which do not respond to health checks, based on existing rules/policy.
</dd>
<dt>Horizontal scaling</dt>
<dd>Kubernetes can automatically scale applications based on resource usage like CPU and memory. In some cases, it also supports dynamic scaling based on customer metrics.
</dd>
<dt>Service discovery and Load balancing</dt>
<dd>Kubernetes groups sets of containers and referes to them via a Domain Name System (DNS). This DNS is also called a Kubernetes <strong>service</strong>. Kubernetes can discover these services automatically, and load-balance requests between containers of a given service.
</dd>
<dt>Automated rollouts and rollbacks</dt>
<dd>Kubernetes can roll out and roll back new version/configurations of an application, without introducing any downtime.
</dd>
<dt>Secrets and configuration management</dt>
<dd>Kubernetes can manages secrets and configuration details for an application without re-building the respective images. With secrets, we can share confidential information to our application without exposing it to the stack configuration, like on Github.
</dd>
<dt>Storage orchestration</dt>
<dd>With Kubernetes and its plugins, we can automatically mount local, external, and storage solutions to the containers in a seamless manner, based on software-defined storage (SDS).
</dd>
<dt>Batch execution</dt>
<dd>Besides long running jobs, Kubernetes also supports batch execution.
</dd>
</dl>
<h2 id="objects">Objects</h2>
<p>Basic objects in Kubernetes are</p>
<dl class="incremental">
<dt>pod</dt>
<dd>a group of running instances
</dd>
<dt>service</dt>
<dd>policy to expose network
</dd>
<dt>volume</dt>
<dd>persist storage
</dd>
<dt>namespace</dt>
<dd>isolate resources
</dd>
</dl>
<p>In high level, there're some abstracts named <strong>controller</strong>, such as</p>
<ul class="incremental">
<li>ReplicaSet</li>
<li>Deployment</li>
<li>StatefulSet</li>
<li>DaemonSet</li>
<li>Job</li>
</ul>
<p>Objects informations can be split into two groups</p>
<dl class="incremental">
<dt>spec</dt>
<dd>desired state
</dd>
<dt>status</dt>
<dd>actual state, and is supplied and updated by the kubernete system
</dd>
</dl>
<h1 id="pods">Pods</h1>
<h2 id="what-is">What is?</h2>
<ul class="incremental">
<li>Smallest deployable units of computing that can be created and managed in k8s cluster</li>
<li>A group of Docker containers with shared namespaces and shared volumes
<ul class="incremental">
<li>a group of containers, relatively tightly coupled</li>
<li>shared storage/network</li>
<li>with specification for how to run the containers</li>
<li>containers share an <strong>IP address and port space</strong>, can communicate with each-other via <strong>localhost</strong></li>
<li>volume provides shared filesystem and data persistent</li>
</ul></li>
<li>Some notes about underlying
<ul class="incremental">
<li>supports more container runtimes (beyond Docker)</li>
<li>undergroupd is a set of Linux namespaces, cgroups, and potentially other facets of isolation</li>
</ul></li>
</ul>
<h2 id="life-of-a-pod"><span class="todo TODO">TODO</span> life of a pod</h2>
<ul class="incremental">
<li>relatively ephemeral</li>
<li>volume has the same lifetime as the pod</li>
<li><a href="https://kubernetes.io/docs/concepts/workloads/pods/pod-lifecycle/" class="uri">https://kubernetes.io/docs/concepts/workloads/pods/pod-lifecycle/</a></li>
</ul>
<h2 id="replication"><span class="todo TODO">TODO</span> replication</h2>
<p>pod 的一个 node 异常后，将重新发起一个新的 pod 替换之</p>
<p><a href="https://kubernetes.io/docs/concepts/workloads/controllers/replicationcontroller/" class="uri">https://kubernetes.io/docs/concepts/workloads/controllers/replicationcontroller/</a></p>
<h2 id="motivation">Motivation</h2>
<ul class="incremental">
<li>Serve as unit of deployment, horizontal scaling, and replication.</li>
<li>Automatically handles:
<ul class="incremental">
<li>Colocation (co-scheduling)</li>
<li>shared fate (termination together)</li>
<li>coordinated replication</li>
<li>resource sharing</li>
<li>dependency management</li>
</ul></li>
</ul>
<h2 id="usage"><span class="todo TODO">TODO</span> Usage</h2>
<h2 id="terminates"><span class="todo TODO">TODO</span> Terminates</h2>
<h3 id="how-to-find-each-other-by-localhost"><span class="todo TODO">TODO</span> How to find each other by <strong>localhost</strong></h3>
<h1 id="volume">Volume</h1>
<h2 id="vs-docker-volume">vs Docker Volume</h2>
<p>docker volume 是将本地的一个目录挂载到 container 中，存在以下问题</p>
<ol class="incremental">
<li>实现方式单一（docker driver 提供了一定的扩展功能）</li>
<li>不能在多个容器之间共享</li>
<li>没有生命周期管理（独立于 container）</li>
</ol>
<p>k8s volume 有以下特点：</p>
<ol class="incremental">
<li>与 Pod 生命周期相同</li>
<li>当 Pod 容器重启后，volume 依旧存在</li>
<li>Pod 中的窗口共享 volume</li>
<li>有很多种 backend 实现方式</li>
</ol>
<h2 id="persistentvolume-persistentvolumeclaims">PersistentVolume &amp; PersistentVolumeClaims</h2>
<h3 id="pv-vs-pvc">PV vs PVC</h3>
<ul class="incremental">
<li>PVs are resources in the cluster</li>
<li>PVCs are requests for those resources and also act as <em>claim checks</em> to the resource.</li>
</ul>
<h3 id="lifecycle">Lifecycle</h3>
<ol class="incremental">
<li><p>Provisioning</p>
<ol class="incremental">
<li>Static: Administration allocated</li>
<li>Dynamic: automatic provision for PVC request, based on <code>StorageClasses</code></li>
</ol></li>
<li><p>Binding</p>
<ul class="incremental">
<li>PVC request amount of storage and access mode</li>
<li>Master find a matching PV for PVC and binding them together</li>
</ul></li>
<li><p>Using</p></li>
</ol>
<h1 id="deployments">Deployments</h1>
<h1 id="replicasets">ReplicaSets</h1>
<ul class="incremental">
<li>Use <code>Deployment</code> instead when possible to support rolling update feature</li>
<li><code>Deployment</code> is a high-level abstract of <code>ReplicaSets</code></li>
<li>Similar to <code>ReplicationController</code>, but support set-based selector</li>
<li>Specific pod configuration by <code>spec.template</code></li>
</ul>
<h1 id="network">Network</h1>
<p>Pods had private cluster-IP which means:</p>
<ol class="incremental">
<li>containers in Pod can reach each other's port on <code>localhost</code></li>
<li>All pods can see each other without NAT</li>
</ol>
<h2 id="vs-docker-bridge-network">vs Docker Bridge Network</h2>
<p>Docker's conatiners can visit others on the same machine.</p>
<p>But for communicating across machine, user must setup proxy to forward traffic to specific ports.</p>
<h1 id="service">Service</h1>
<h2 id="overview-1">Overview</h2>
<p>Pod has internal and temporary cluster-IP address which is easy-to-dead.</p>
<p>Kubernetes provides Deployment or ReplicaSet controller for monitoring pods status which would spawn new pods with different cluster-IP address when necessary.</p>
<p><code>Service</code> is an abstraction which defines a logical set of <code>Pods</code> and a policy by which to access them. Use <code>service</code> to decouple frontend pod with backend pod connection.</p>
<p>Service is assigned a unique IP address which is independent with pods. Traffic will be routed to some pod in the groups of service.</p>
<h2 id="how-to-create-services">How to create services</h2>
<ol class="incremental">
<li><code>kubectl expose &lt;deployment&gt;</code></li>
<li><p>create by <code>Service</code> API</p>
<div class="sourceCode"><pre class="sourceCode yaml"><code class="sourceCode yaml"> <span class="fu">kind:</span><span class="at"> Service</span>
<span class="fu">apiVersion:</span><span class="at"> v1</span>
<span class="fu">metadata:</span>
  <span class="fu">name:</span><span class="at"> my-service</span>
<span class="fu">spec:</span>
  <span class="fu">selector:</span>
    <span class="fu">app:</span><span class="at"> MyApp</span>
  <span class="fu">ports:</span>
  <span class="kw">-</span> <span class="fu">protocol:</span><span class="at"> TCP</span>
    <span class="fu">port:</span><span class="at"> 80</span>
    <span class="fu">targetPort:</span><span class="at"> 9376</span></code></pre></div></li>
</ol>
<h2 id="endpoints"><code>Endpoints</code></h2>
<p><code>Endpoints</code> is an object for Pods and will update whenever set of <code>Pods</code> in a <code>Service</code> changed.</p>
<p>For non-native application, use virtual-IP-based bridge to Service.</p>
<p>When create <code>Service</code>, an <code>Endpoints</code> will be created with the same name as Service (must have label selectors)</p>
<h2 id="label-selectors">Label Selectors</h2>
<ul class="incremental">
<li>Worked just as a route item, map port to target port which is not part of <code>Pods</code></li>
<li>Because no selector specific, there will not be <code>Endpoints</code> be created automatically</li>
<li>Create <code>Endpoint</code> manual</li>
<li><em>ExternalName service</em> is a special case, see below</li>
</ul>
<h2 id="network-1">Network</h2>
<p>Pod has cluster-IP and can be visited in other cluster's nodes or pods.</p>
<h2 id="define-a-service">Define a service</h2>
<ul class="incremental">
<li>Would be assigned an IP address (cluster-IP), which is used by proxy</li>
<li>An <code>Endpoints</code> also named 'my-service' will be created automatically</li>
<li>Map an incompoint <code>port</code> to any <code>targetPort</code></li>
</ul>
<h2 id="proxy">Proxy</h2>
<ul class="incremental">
<li>Each node has a process named <code>kube-proxy</code></li>
<li>Which is responsible for implementing a form of virtual IP for <code>Services</code></li>
<li>There are three mode for <code>Proxy</code>
<ul class="incremental">
<li>Userspace
<ol class="incremental">
<li>iptable rules to forward <code>ClusterIP:Port</code> to <code>localhost:ProxyPort</code></li>
<li>proxied <code>localhost:ProxyPort</code>'s traffic to one of the <code>Service</code>'s backend <code>Pods</code></li>
</ol></li>
<li>Iptables
<ul class="incremental">
<li>Set iptable rule for each <code>Endpoints</code></li>
<li>Random forward request to <code>CLusterIP:Port</code> to backend <code>Pod</code></li>
<li>But can not retry for failed, depends on having working readiness probes</li>
</ul></li>
<li>ipvs (new in v1.9, skip)</li>
</ul></li>
</ul>
<h2 id="find-service">Find <code>Service</code></h2>
<p><code>Service</code> clusterIP is choosed randomly, Two methods to find <code>Service</code> clusterIP</p>
<h3 id="environment">Environment</h3>
<ul class="incremental">
<li><p>After create <code>Services</code>, new <code>Pods</code> will be configured with environment variables</p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash"><span class="va">${SVCNAME}</span><span class="ex">_SERVICE_HOST</span>
<span class="va">${SVCNAME}</span><span class="ex">_SERVICE_PORT</span></code></pre></div></li>
<li><p>To use env, Services must be created before Pods</p></li>
</ul>
<h3 id="dns">DNS</h3>
<ul class="incremental">
<li><code>kube-system/kube-dns</code> pod provide DNS service</li>
<li>DNS Server monitor the changes of <code>Services</code> and maintain items to service IP</li>
<li>Map <code>service-name.namespace</code> to Service cluster IP</li>
</ul>
<h2 id="publish-services-to-external">Publish services to external</h2>
<p>Some kind of service by setting <code>Type</code> value (ServiceType)</p>
<ol class="incremental">
<li>ClusterIP: for cluster-internal usage</li>
<li>NodePort: Can be visited from external by <code>&lt;NodeIP&gt;:&lt;NodePort&gt;</code> (every node)</li>
<li>LoadBalancer: Expose the service externally using a cloud provider's load balancer(?)</li>
<li>ExternalName: return a <code>CNAME</code> record with <code>externalName</code> field's value (?)</li>
</ol>
<h2 id="shortcomings"><span class="todo TODO">TODO</span> Shortcomings</h2>
<h2 id="misc">Misc</h2>
<ul class="incremental">
<li><p><code>Services</code> can expose more than one port and you must give all of your ports names. For examples:</p>
<div class="sourceCode"><pre class="sourceCode yaml"><code class="sourceCode yaml"><span class="fu">kind:</span><span class="at"> Service</span>
<span class="fu">apiVersion:</span><span class="at"> v1</span>
<span class="fu">metadata:</span>
  <span class="fu">name:</span><span class="at"> my-service</span>
<span class="fu">spec:</span>
  <span class="fu">selector:</span>
    <span class="fu">app:</span><span class="at"> MyApp</span>
  <span class="fu">ports:</span>
  <span class="kw">-</span> <span class="fu">name:</span><span class="at"> http</span>
    <span class="fu">protocol:</span><span class="at"> TCP</span>
    <span class="fu">port:</span><span class="at"> 80</span>
    <span class="fu">targetPort:</span><span class="at"> 9376</span>
  <span class="kw">-</span> <span class="fu">name:</span><span class="at"> https</span>
    <span class="fu">protocol:</span><span class="at"> TCP</span>
    <span class="fu">port:</span><span class="at"> 443</span>
    <span class="fu">targetPort:</span><span class="at"> 9377</span></code></pre></div></li>
<li>Can set clusterIP of <code>Services</code> by <code>.spec.clusterIP</code>. Most useful for legacy system which configured a specific IP address</li>
</ul>
<h1 id="configmap"><span class="todo TODO">TODO</span> ConfigMap</h1>
<p>Something like register or key/value database(?)</p>
<p>Can be mounted to container's file.</p>
<h1 id="todo"><span class="todo TODO">TODO</span> TODO</h1>
<h2 id="prove-containers-ports-may-conflict-under-docker-bridge-networks">Prove containers' ports may conflict under docker bridge networks</h2>
<h2 id="link-how-we-archieve-this">link: how we archieve this</h2>
<h2 id="pod-spec-containerport">Pod spec containerPort</h2>
<h2 id="pods-container-port-and-targetport">Pod's container port and targetPort</h2>
<h2 id="printenv-vs-env"><code>printenv</code> vs <code>env</code></h2>
<h2 id="how-does-kubernetes-monitor-the-status-change">How does kubernetes monitor the status change?</h2>
<ol class="incremental">
<li>polling</li>
<li>callback?</li>
</ol>
<p>I guess polling is much easier to implement.</p>
<h1 id="kubectl">kubectl</h1>
<h2 id="run">run</h2>
<p>create a deployment</p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash"><span class="ex">kubectl</span> run nginx --image=nginx --replicas=2</code></pre></div>
<h2 id="expose">expose</h2>
<p>create a service for deployment</p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash"><span class="ex">kubectl</span> expose deployment nginx --port=80</code></pre></div>

				</div>
			</section>
		</body>
	</html>
	
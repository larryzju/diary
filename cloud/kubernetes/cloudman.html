<!DOCTYPE html>
<html>
	<head>
		<title>cloudman.org</title>
		<link rel="stylesheet" href="/diary/_resources/css/main.css" />
		<script src="/diary/_resources/js/jquery-3.4.1.min.js"></script>
		<script src="/diary/_resources/js/swgen.js"></script>
	</head>
	<body>
		<nav id='content'>
		</nav>
		<section class="main-article-area">
			<div id='main'>
				<h1 id="背景">背景</h1>
<h2 id="kubernetes-vs-mesos-vs-docker-swarm"><span class="todo TODO">TODO</span> Kubernetes vs Mesos vs Docker Swarm</h2>
<h2 id="google-borg">Google Borg</h2>
<ul class="incremental">
<li>Kubernetes 是 Google Omega 的开源版本</li>
<li>Omega 以前叫做 Borg</li>
<li>Borg 是 Google 内部用来管理容量的工具</li>
</ul>
<h1 id="概念">概念</h1>
<h2 id="cluster">Cluster</h2>
<ul class="incremental">
<li>计算、存储和网络资源的集合</li>
<li>Kubernetes 利用 Cluster 资源运行各种基于容器的应用</li>
</ul>
<h2 id="master">Master</h2>
<ul class="incremental">
<li>调度</li>
<li>可以 HA</li>
</ul>
<h2 id="node">Node</h2>
<ul class="incremental">
<li>运行容器，管理容器的生命周期</li>
<li>接受 Master 管理</li>
<li>监控并汇报容器的状态</li>
</ul>
<h2 id="controller">Controller</h2>
<ul class="incremental">
<li>Kubernetes 不会直接创建 Pod，而是通过 Controller 来管理 Pod</li>
<li>Controller 定义了 Pod 的部署特性（如副本，Node 的选择）</li>
<li>内置有多种 Controller，如 Deployment, ReplicaSet, DaemonSet, StatefuleSet, Job</li>
</ul>
<h2 id="deployment">Deployment</h2>
<ul class="incremental">
<li>应用，自动管理副本</li>
<li>用 <code>kubectl get deploymentes</code></li>
<li>副本可以增大，也可以减小</li>
</ul>
<h2 id="replicaset">ReplicaSet</h2>
<ul class="incremental">
<li>多副本管理</li>
<li>Deployment 会创建 ReplicaSet</li>
<li>通常不要直接使用 ReplicaSet</li>
</ul>
<h2 id="statefuleset"><span class="todo TODO">TODO</span> StatefuleSet</h2>
<ul class="incremental">
<li>保证 Pod 的每个副本在整个生命周期中的名称不变</li>
<li>保证副本按固定的顺序启动、更新或删除</li>
<li>有什么用？</li>
</ul>
<h2 id="job"><span class="todo TODO">TODO</span> Job</h2>
<ul class="incremental">
<li>运行结束就删除的应用场景</li>
</ul>
<h2 id="namespace">Namespace</h2>
<ul class="incremental">
<li>将物理 Cluster 逻辑划分为多个虚拟的 Cluster</li>
<li>不同 Cluster 的资源是隔离的</li>
</ul>
<h2 id="pod">Pod</h2>
<ul class="incremental">
<li>容器的集合</li>
<li>在一个 Node 上运行</li>
<li>同一 Pod 中的所有容器共享 IP 地址和 Port 空间</li>
<li>是 Kubernetes 调度的最小单位</li>
<li>用 <code>kubectl get pods</code> 查看当前的 Pod</li>
<li>只能在集群内部访问 Pod 的容器</li>
</ul>
<h2 id="service">Service</h2>
<ul class="incremental">
<li>Pod 的地址只能在集群内部分使用，而且可能会被频繁地销毁和重启</li>
<li>Service 定义了外界访问一组特定 Pod 的方式</li>
<li>有自己的 IP 和端口</li>
<li>为 Pod 提供了负载均衡能力</li>
<li><p>将 Pod 端口映射到外部</p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash"><span class="ex">kubectl</span> expose deployment/kubernetes-bootcamp \
        --type=<span class="st">&quot;NodePort&quot;</span> --port 8080</code></pre></div></li>
<li>用 <code>kubectl get service</code> 查看映射</li>
<li><p>映射到的外部服务端口号是随机的</p></li>
</ul>
<h2 id="rolling">Rolling</h2>
<ul class="incremental">
<li><p><code>kubectl set image</code> 命令动态更新 Deployment 中的容器镜像</p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash"><span class="co"># update deployments kubernetes-bootcamp&#39;s container&#39;s image to kubernetes-bootcamp:v2</span>
<span class="ex">kubectl</span> set image deployments/kubernetes-bootcamp \
        kubernetes-bootcamp=jocatalin/kubernetes-bootcamp:v2</code></pre></div></li>
<li><p><code>kubectl rollout undo</code> 回退版本</p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash"><span class="ex">kubectl</span> rollout undo deployments/kubernetes-bootcamp</code></pre></div></li>
</ul>
<h1 id="架构">架构</h1>
<h2 id="pod-的作用">Pod 的作用</h2>
<ol class="incremental">
<li>可管理性（更高的抽象层次）</li>
<li>通信和资源共享
<ul class="incremental">
<li>Pod 中的容器共享网络</li>
<li>可以直接用 localhost 通信</li>
<li>可以共享存储（Volume 实际对 Pod 中每个 Container 可见）</li>
</ul></li>
</ol>
<h2 id="pod-与-container">Pod 与 Container</h2>
<ol class="incremental">
<li>可以运行单一容器，称为 <code>one-container-per-pod</code></li>
<li>运行多个容器：要求容器必须联系紧密，有共享资源的需求</li>
</ol>
<h2 id="controller-与-service">Controller 与 Service</h2>
<ul class="incremental">
<li>Controller 负责运行容器</li>
<li>Service 负责访问容器（能力）</li>
</ul>
<h1 id="优化">优化</h1>
<h2 id="资源">资源</h2>
<h2 id="高可用">高可用</h2>
<h2 id="滚动更新">滚动更新</h2>
<ul class="incremental">
<li>参见 <em>Rolling</em></li>
</ul>
<h2 id="网络插件">网络插件</h2>
<h2 id="服务发现">服务发现</h2>
<h2 id="监控">监控</h2>
<h2 id="数据管理">数据管理</h2>
<h2 id="日志管理">日志管理</h2>
<h1 id="问题">问题</h1>
<h2 id="部署应用-deployment-run-create-apply-的异同"><span class="todo TODO">TODO</span> 部署应用 deployment, run, create, apply 的异同</h2>
<h1 id="安装">安装</h1>
<h2 id="kubeadm-方式-ubuntu-16.04">kubeadm 方式 (ubuntu 16.04)</h2>
<ol class="incremental">
<li><p>节点安装 docker</p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash"><span class="ex">apt-get</span> update <span class="kw">&amp;&amp;</span> <span class="ex">apt-get</span> install docker.io</code></pre></div></li>
<li>节点安装 kubelet, kubeadm, kubectl
<ul class="incremental">
<li>kubelet 负责启动 Pod 和容器</li>
<li>kubeadm 用于初始化 Cluster</li>
<li>kubectl 命令行工具</li>
<li><p>命令如下</p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash"><span class="ex">apt-get</span> update <span class="kw">&amp;&amp;</span> <span class="ex">apt-get</span> install -y apt-transport-https
<span class="ex">curl</span> -s https://packages.cloud.google.com/apt/doc/apt-key.gpg <span class="kw">|</span> <span class="ex">apt-key</span> add -cat <span class="op">&lt;&lt;EOF</span> <span class="op">&gt;</span><span class="ex">/etc/apt/sources.list.d/kubernetes.list</span>
deb http://apt.kubernetes.io/ kubernetes-xenial main
EOF
apt-get updateapt-get install -y kubelet kubeadm kubectl</code></pre></div></li>
</ul></li>
<li><p>初始化 Master （在 Master 节点操作）</p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash"><span class="co"># apiserver 指定 master 网络接口</span>
<span class="co"># pod-network-cider 指定 Pod 网络范围</span>
<span class="ex">kubeadm</span> init --apiserver-advertise-address 192.168.56.105 \
        --pod-network-cidr=10.244.0.0/16</code></pre></div></li>
</ol>
<h1 id="命令">命令</h1>
<ul class="incremental">
<li>信息查看
<dl class="incremental">
<dt><code>kubectl cluster-info</code></dt>
<dd>查看集群信息
</dd>
<dt><code>kubectl get nodes</code></dt>
<dd>查看集群结点
</dd>
<dt><code>kubectl get pods</code></dt>
<dd>查看当前的 Pod
</dd>
<dt><code>kubectl get services</code></dt>
<dd>查看服务映射
</dd>
<dt><code>kubectl get deployments</code></dt>
<dd>查看部署情况（包含副本数）
</dd>
</dl></li>
<li>部署
<dl class="incremental">
<dt><code>kubectl run name --image=xx</code></dt>
<dd>部署应用
</dd>
<dt><code>kubectl expose deployment --type=&quot;NodePort&quot; --port 8080</code></dt>
<dd>映射服务
</dd>
</dl></li>
<li>维护
<dl class="incremental">
<dt><code>kubectl scale deployment --replicas=3</code></dt>
<dd>修改副本数
</dd>
<dt><code>kubectl set image</code></dt>
<dd>更改容器的镜像
</dd>
<dt><code>kubectl rollout undo</code></dt>
<dd>回退版本
</dd>
</dl></li>
</ul>

			</div>
		</section>
	</body>
</html>

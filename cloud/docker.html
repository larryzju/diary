
	<!DOCTYPE html>
	<html>
		<head>
			<title>docker.org</title>
			<link rel="stylesheet" href="/diary/resources/css/main.css" />
			<script src="/diary/resources/js/jquery-3.4.1.min.js"></script>
			<script src="/diary/resources/js/swgen.js"></script>
		</head>
		<body>
			<nav id='content'>
				<ul><li><details><summary>algorithm</summary><ul><li><details><summary>introduction-to-algorithm</summary><ul><li><a href='/diary/algorithm/introduction-to-algorithm/sort.html'>sort.org</a></li></ul></details></li><li><a href='/diary/algorithm/string-match.html'>string-match.org</a></li></ul></details></li><li><details><summary>blog</summary><ul><li><a href='/diary/blog/rescure-libc-deleted.html'>rescure-libc-deleted.org</a></li><li><a href='/diary/blog/timezone.html'>timezone.org</a></li></ul></details></li><li><details><summary>book</summary><ul><li><a href='/diary/book/git%e6%95%99%e7%a8%8b.html'>git教程.org</a></li><li><a href='/diary/book/go%e8%af%ad%e8%a8%80%e7%bc%96%e7%a8%8b.html'>go语言编程.org</a></li><li><a href='/diary/book/javascript%e5%85%a8%e6%a0%88%e6%95%99%e7%a8%8b.html'>javascript全栈教程.org</a></li><li><a href='/diary/book/rich-dad-and-poor-dad.html'>rich-dad-and-poor-dad.org</a></li><li><a href='/diary/book/%e4%ba%ba%e7%b1%bb%e7%ae%80%e5%8f%b2%e2%80%94%e2%80%94%e4%bb%8e%e5%8a%a8%e7%89%a9%e5%88%b0%e4%b8%8a%e5%b8%9d.html'>人类简史——从动物到上帝.org</a></li><li><details><summary>春秋史话</summary><ul><li><a href='/diary/book/%e6%98%a5%e7%a7%8b%e5%8f%b2%e8%af%9d/%e6%98%a5%e7%a7%8b%e5%8f%b2%e8%af%9d.html'>春秋史话.org</a></li></ul></details></li><li><a href='/diary/book/%e8%9a%8a%e5%ad%90%e5%b9%b2%e5%98%9b%e8%80%81%e5%8f%ae%e6%88%91.html'>蚊子干嘛老叮我.org</a></li></ul></details></li><li><details><summary>cloud</summary><ul><li><a href='/diary/cloud/docker.html'>docker.org</a></li><li><a href='/diary/cloud/gcp.html'>gcp.org</a></li><li><a href='/diary/cloud/gke.html'>gke.org</a></li><li><a href='/diary/cloud/helm.html'>helm.org</a></li><li><details><summary>kubernetes</summary><ul><li><a href='/diary/cloud/kubernetes/README.html'>README.org</a></li><li><a href='/diary/cloud/kubernetes/cloudman.html'>cloudman.org</a></li><li><a href='/diary/cloud/kubernetes/content.html'>content.org</a></li><li><a href='/diary/cloud/kubernetes/controller.html'>controller.org</a></li><li><a href='/diary/cloud/kubernetes/golang.html'>golang.org</a></li><li><a href='/diary/cloud/kubernetes/k8s.html'>k8s.org</a></li><li><a href='/diary/cloud/kubernetes/kubeadm.html'>kubeadm.org</a></li><li><a href='/diary/cloud/kubernetes/kuberbuilder.html'>kuberbuilder.org</a></li><li><a href='/diary/cloud/kubernetes/kubernetes-guide.html'>kubernetes-guide.org</a></li><li><a href='/diary/cloud/kubernetes/operator.html'>operator.org</a></li><li><a href='/diary/cloud/kubernetes/rbac.html'>rbac.org</a></li><li><a href='/diary/cloud/kubernetes/registry.html'>registry.org</a></li><li><a href='/diary/cloud/kubernetes/todo.html'>todo.org</a></li><li><a href='/diary/cloud/kubernetes/tutorial.html'>tutorial.org</a></li><li><a href='/diary/cloud/kubernetes/what-is-container.html'>what-is-container.org</a></li></ul></details></li></ul></details></li><li><details><summary>csapp</summary><ul><li><a href='/diary/csapp/csapp-digest.html'>csapp-digest.org</a></li><li><a href='/diary/csapp/cscpp.html'>cscpp.org</a></li></ul></details></li><li><a href='/diary/docker.html'>docker.org</a></li><li><details><summary>emacs</summary><ul><li><a href='/diary/emacs/orgmode.html'>orgmode.org</a></li></ul></details></li><li><details><summary>history</summary><ul><li><a href='/diary/history/%e5%85%a8%e7%90%83%e9%80%9a%e5%8f%b2.html'>全球通史.org</a></li><li><a href='/diary/history/%e5%8d%97%e5%8c%97%e6%9c%9d.html'>南北朝.org</a></li><li><a href='/diary/history/%e6%99%8b%e5%8f%b2.html'>晋史.org</a></li></ul></details></li><li><a href='/diary/index.html'>index.org</a></li><li><details><summary>linux</summary><ul><li><a href='/diary/linux/centos.html'>centos.org</a></li><li><a href='/diary/linux/filesystem.html'>filesystem.org</a></li><li><a href='/diary/linux/init.d.html'>init.d.org</a></li><li><a href='/diary/linux/iptables.html'>iptables.org</a></li><li><a href='/diary/linux/linuxcast.html'>linuxcast.org</a></li><li><a href='/diary/linux/ss.html'>ss.org</a></li><li><a href='/diary/linux/suse.html'>suse.org</a></li><li><a href='/diary/linux/vps.html'>vps.org</a></li></ul></details></li><li><details><summary>literal</summary><ul><li><a href='/diary/literal/book.html'>book.org</a></li><li><a href='/diary/literal/han.html'>han.org</a></li><li><a href='/diary/literal/movie.html'>movie.org</a></li><li><a href='/diary/literal/nounce.html'>nounce.org</a></li><li><a href='/diary/literal/person.html'>person.org</a></li><li><a href='/diary/literal/%e5%9f%ba%e7%9d%a3%e5%b1%b1%e4%bc%af%e7%88%b5.html'>基督山伯爵.org</a></li></ul></details></li><li><details><summary>math</summary><ul><li><a href='/diary/math/%e6%a6%82%e7%8e%87%e8%ae%ba%e4%b8%8e%e6%95%b0%e7%90%86%e7%bb%9f%e8%ae%a1.html'>概率论与数理统计.org</a></li></ul></details></li><li><a href='/diary/mindmap.html'>mindmap.org</a></li><li><details><summary>misc</summary><ul><li><a href='/diary/misc/org-usage.html'>org-usage.org</a></li><li><a href='/diary/misc/screen.html'>screen.org</a></li></ul></details></li><li><details><summary>network</summary><ul><li><a href='/diary/network/ssl.html'>ssl.org</a></li></ul></details></li><li><a href='/diary/opengl.html'>opengl.org</a></li><li><a href='/diary/orgmode.html'>orgmode.org</a></li><li><details><summary>os</summary><ul><li><a href='/diary/os/80386.html'>80386.org</a></li><li><a href='/diary/os/8259a.html'>8259a.org</a></li><li><a href='/diary/os/boot.html'>boot.org</a></li><li><a href='/diary/os/gcc-inline-asm.html'>gcc-inline-asm.md</a></li><li><a href='/diary/os/linux.html'>linux.org</a></li></ul></details></li><li><details><summary>policy</summary><ul><li><a href='/diary/policy/%e5%85%a8%e7%90%83%e5%8c%96%e6%b3%a2%e6%8a%98%e4%b8%8e%e6%b0%91%e8%90%a5%e7%bb%8f%e6%b5%8e%e7%9a%84%e6%9c%aa%e6%9d%a5_%e5%91%a8%e5%85%b6%e4%bb%81.html'>全球化波折与民营经济的未来_周其仁.org</a></li></ul></details></li><li><details><summary>programming</summary><ul><li><details><summary>algorithm</summary><ul><li><details><summary>algorithm4th</summary><ul><li><a href='/diary/programming/algorithm/algorithm4th/algorithm.html'>algorithm.org</a></li></ul></details></li><li><a href='/diary/programming/algorithm/%e5%b0%8f%e7%94%b2%e9%b1%bc-%e6%95%b0%e6%8d%ae%e7%bb%93%e6%9e%84%e4%b8%8e%e7%ae%97%e6%b3%95-%e8%a7%86%e9%a2%91%e7%ac%94%e8%ae%b0.html'>小甲鱼-数据结构与算法-视频笔记.org</a></li></ul></details></li><li><details><summary>clojure</summary><ul><li><a href='/diary/programming/clojure/clojure.tools.logging.html'>clojure.tools.logging.md</a></li></ul></details></li><li><details><summary>cpp</summary><ul><li><a href='/diary/programming/cpp/tutorials.html'>tutorials.org</a></li></ul></details></li><li><details><summary>elasticsearch</summary><ul><li><a href='/diary/programming/elasticsearch/elasticsearch-definitive-guide-note.html'>elasticsearch-definitive-guide-note.org</a></li></ul></details></li><li><details><summary>git</summary><ul><li><a href='/diary/programming/git/git.html'>git.org</a></li></ul></details></li><li><details><summary>golang</summary><ul><li><a href='/diary/programming/golang/cmd.html'>cmd.org</a></li><li><a href='/diary/programming/golang/effective-go.html'>effective-go.org</a></li><li><a href='/diary/programming/golang/go-concurrency.html'>go-concurrency.org</a></li><li><a href='/diary/programming/golang/how-to-write-go-code.html'>how-to-write-go-code.org</a></li><li><a href='/diary/programming/golang/json.html'>json.org</a></li><li><details><summary>learn-go-note</summary><ul><li><a href='/diary/programming/golang/learn-go-note/learning-go.html'>learning-go.org</a></li></ul></details></li><li><a href='/diary/programming/golang/library.html'>library.org</a></li><li><a href='/diary/programming/golang/misc.html'>misc.org</a></li><li><a href='/diary/programming/golang/reflect.html'>reflect.org</a></li><li><a href='/diary/programming/golang/template.html'>template.org</a></li><li><a href='/diary/programming/golang/the-little-go-book.html'>the-little-go-book.org</a></li><li><a href='/diary/programming/golang/%e6%97%a0%e9%97%bb%e8%a7%86%e9%a2%91%e7%ac%94%e8%ae%b0.html'>无闻视频笔记.org</a></li></ul></details></li><li><details><summary>hadoop</summary><ul><li><a href='/diary/programming/hadoop/hdfs-permission-guide-note.html'>hdfs-permission-guide-note.org</a></li></ul></details></li><li><details><summary>java</summary><ul><li><a href='/diary/programming/java/derby.html'>derby.org</a></li><li><a href='/diary/programming/java/ivy-vs-maven.html'>ivy-vs-maven.org</a></li><li><a href='/diary/programming/java/java-note.html'>java-note.org</a></li><li><a href='/diary/programming/java/maven.html'>maven.org</a></li><li><a href='/diary/programming/java/servlet.html'>servlet.org</a></li><li><a href='/diary/programming/java/thing-java.html'>thing-java.org</a></li><li><a href='/diary/programming/java/%e6%b7%b1%e5%85%a5%e7%90%86%e8%a7%a3java%e8%99%9a%e6%8b%9f%e6%9c%ba.html'>深入理解java虚拟机.org</a></li></ul></details></li><li><details><summary>javascript</summary><ul><li><a href='/diary/programming/javascript/angularjs.html'>angularjs.org</a></li><li><a href='/diary/programming/javascript/dom.html'>dom.org</a></li></ul></details></li><li><a href='/diary/programming/javascript.html'>javascript.org</a></li><li><details><summary>lisp</summary><ul><li><a href='/diary/programming/lisp/the-little-schemer.html'>the-little-schemer.org</a></li></ul></details></li><li><details><summary>python</summary><ul><li><a href='/diary/programming/python/asyncio.html'>asyncio.org</a></li><li><a href='/diary/programming/python/flask.html'>flask.org</a></li><li><a href='/diary/programming/python/idiomatic-python-note.html'>idiomatic-python-note.org</a></li><li><a href='/diary/programming/python/jinja2.html'>jinja2.org</a></li><li><a href='/diary/programming/python/package-manage.html'>package-manage.org</a></li><li><a href='/diary/programming/python/pygame.html'>pygame.org</a></li><li><a href='/diary/programming/python/tools.html'>tools.org</a></li></ul></details></li><li><details><summary>scala</summary><ul><li><a href='/diary/programming/scala/programming-in-scala.html'>programming-in-scala.org</a></li><li><a href='/diary/programming/scala/scala.html'>scala.org</a></li><li><a href='/diary/programming/scala/scalikeJDBC.html'>scalikeJDBC.org</a></li></ul></details></li><li><a href='/diary/programming/storm.html'>storm.org</a></li><li><a href='/diary/programming/thrift.html'>thrift.org</a></li><li><a href='/diary/programming/typescript.html'>typescript.org</a></li><li><details><summary>web</summary><ul><li><a href='/diary/programming/web/liquid.html'>liquid.org</a></li></ul></details></li></ul></details></li><li><details><summary>rdbms</summary><ul><li><a href='/diary/rdbms/rdbms.html'>rdbms.org</a></li></ul></details></li><li><details><summary>resource</summary><ul><li><a href='/diary/resource/emacs.html'>emacs.md</a></li><li><a href='/diary/resource/ml-resource.html'>ml-resource.md</a></li><li><a href='/diary/resource/nlp-resource.html'>nlp-resource.md</a></li></ul></details></li><li><details><summary>services</summary><ul><li><details><summary>mail</summary><ul><li><a href='/diary/services/mail/mail.html'>mail.org</a></li></ul></details></li></ul></details></li><li><details><summary>subtitle</summary><ul><li><a href='/diary/subtitle/docker.html'>docker.org</a></li></ul></details></li><li><details><summary>toarous</summary><ul><li><a href='/diary/toarous/README.html'>README.md</a></li><li><a href='/diary/toarous/idt.html'>idt.md</a></li><li><a href='/diary/toarous/intel.html'>intel.org</a></li><li><a href='/diary/toarous/notes.html'>notes.org</a></li><li><a href='/diary/toarous/osx-environment.html'>osx-environment.org</a></li><li><a href='/diary/toarous/vga.html'>vga.md</a></li></ul></details></li><li><details><summary>tools</summary><ul><li><a href='/diary/tools/GCP.html'>GCP.org</a></li><li><a href='/diary/tools/ansible.html'>ansible.org</a></li><li><a href='/diary/tools/bash.html'>bash.org</a></li><li><a href='/diary/tools/gerrit.html'>gerrit.org</a></li><li><a href='/diary/tools/git.html'>git.org</a></li><li><a href='/diary/tools/gpg.html'>gpg.org</a></li><li><a href='/diary/tools/markdown.html'>markdown.org</a></li><li><a href='/diary/tools/nginx.html'>nginx.org</a></li><li><a href='/diary/tools/rpm.html'>rpm.org</a></li><li><a href='/diary/tools/spark.html'>spark.org</a></li><li><a href='/diary/tools/tmux.html'>tmux.org</a></li></ul></details></li><li><details><summary>ui</summary><ul><li><a href='/diary/ui/react.html'>react.org</a></li><li><a href='/diary/ui/tk.html'>tk.org</a></li></ul></details></li><li><details><summary>web</summary><ul><li><a href='/diary/web/chrome-extension.html'>chrome-extension.org</a></li></ul></details></li><li><a href='/diary/words.html'>words.org</a></li><li><a href='/diary/%e7%bd%91%e6%b0%91%e7%9a%84%e7%8b%82%e6%ac%a2.html'>网民的狂欢.org</a></li></ul>
			</nav>
			<section class="main-article-area">
				<div id='main'>
					<h1 id="docker-compose">docker compose</h1>
<h2 id="overview">Overview</h2>
<ul class="incremental">
<li>Orchestration framework, less useful than kubernetes</li>
<li>A tool for defining and running multi-container Docker applications</li>
<li>Configure with a YAML file</li>
</ul>
<h2 id="basic-steps">Basic Steps</h2>
<ol class="incremental">
<li>Configure Apps use <code>Dockerfile</code></li>
<li>Use <code>docker-compose.yml</code> define services</li>
<li>Run <code>docker-compose up</code> and Compose starts and runs your entire app.</li>
</ol>
<h2 id="lifecycle">Lifecycle</h2>
<ol class="incremental">
<li>Start, stop, and rebuild services</li>
<li>View the status of running services</li>
<li>Stream the log output of running services</li>
<li>Run a one-off command on a service</li>
</ol>
<h1 id="docker">docker</h1>
<h2 id="overview-1">Overview</h2>
<p>Docker can be treated as different things:</p>
<ol class="incremental">
<li><code>docker</code> command lines</li>
<li>docker service to run container, build image</li>
<li>image format to structure container</li>
</ol>
<p>Docker has some advantages:</p>
<ol class="incremental">
<li>Smaller than virtual machine</li>
<li>Improved performance</li>
<li>Secure (isolated from host)</li>
<li>Flexible (portable)</li>
</ol>
<p>Core concepts:</p>
<ul class="incremental">
<li>build image</li>
<li>run container</li>
<li>network</li>
<li>volume (for persist and data share)</li>
</ul>
<h2 id="build">Build</h2>
<p>Docker image can be built with <code>docker build</code> command which interprete of <code>Dockerfile</code> line by line.</p>
<p>The current directory (named <strong>build context</strong>) will be sent to docker daemon. Build context isolated the avaiable files in current build session.</p>
<p>User can tell docker to ignore some files in build context by writing a <code>.dockerignore</code> file.</p>
<p>With <code>docker build</code> command:</p>
<dl class="incremental">
<dt><code>-f</code></dt>
<dd>specify Dockerifle
</dd>
<dt><code>-t shykes/myapp:1.0.2</code></dt>
<dd>image tag
</dd>
</dl>
<p>Docker build tools is smart enough to</p>
<ul class="incremental">
<li>reuse the intermediate image</li>
<li>custom cache policy (see <em>build cache</em> )</li>
</ul>
<p>Thie first line in Dockerfile is <code>FROM ...</code> normally. That means we always build new image from base image.</p>
<h3 id="dockerignore"><code>.dockerignore</code></h3>
<ul class="incremental">
<li>Aim
<ul class="incremental">
<li>safety</li>
<li>ignore large files</li>
</ul></li>
<li>Syntax
<ul class="incremental">
<li>Based on go <code>filepath.Match</code></li>
<li>Special
<ol class="incremental">
<li><code>**</code> match any level directory</li>
<li><code>?</code> match single letter</li>
<li><p><code>!</code> reverse match rules (weird!)</p>
<pre class="text"><code># No markdown files are included in the context except README files other than README-secret.md.
*.md
!README*.md
README-secret.md
</code></pre></li>
</ol></li>
</ul></li>
</ul>
<h3 id="parser-directives">Parser Directives</h3>
<ul class="incremental">
<li>Place at the very top for configure parser rules</li>
<li>Syntax: <code># directive=value</code>
<ul class="incremental">
<li>no duplicate</li>
<li>lowercase</li>
<li>invalid is ignored</li>
<li>ignore after any non-directive instruction</li>
</ul></li>
<li>Directive:
<ul class="incremental">
<li><code>escape=`</code> (Change the default escape <code>\</code> for windows)</li>
</ul></li>
</ul>
<h3 id="environment">Environment</h3>
<p>Use <code>ENV</code> define variables, refer by '$'</p>
<ul class="incremental">
<li><p>Define</p>
<div class="sourceCode"><pre class="sourceCode dockerfile"><code class="sourceCode dockerfile"><span class="kw">FROM</span> busybox
<span class="kw">ENV</span> foo /bar
<span class="kw">WORKDIR</span> ${foo}   <span class="co"># WORKDIR /bar</span>
<span class="kw">ADD</span> . $foo       <span class="co"># ADD . /bar</span>
<span class="kw">COPY</span> \$foo /quux <span class="co"># COPY $foo /quux</span></code></pre></div></li>
<li>Bash like
<ul class="incremental">
<li><code>${var:-word}</code>: if var is not set, then return word</li>
<li><code>${var:+word}</code>: if var is set, return word, else return nil</li>
</ul></li>
</ul>
<h3 id="from-instruction">FROM instruction</h3>
<ul class="incremental">
<li><p>Syntax</p>
<pre class="text"><code>FROM &lt;image&gt; [As &lt;name&gt;]
image: image | image:tag | image@digest
</code></pre></li>
<li><code>&lt;name&gt;</code> is used for <code>COPY --from=&lt;name&gt;</code> scenario</li>
<li>Can be used multiple times</li>
<li><p>Prefix with <code>ARGS</code> parameters</p>
<div class="sourceCode"><pre class="sourceCode dockerfile"><code class="sourceCode dockerfile"><span class="kw">ARG</span> VERSION=latest
<span class="kw">FROM</span> busybox:$VERSION
<span class="kw">ARG</span> VERSION
<span class="kw">RUN</span> echo $VERSION &gt; image_version</code></pre></div></li>
</ul>
<h3 id="run-instruction">RUN instruction</h3>
<ul class="incremental">
<li>Syntax
<ol class="incremental">
<li>sh -c mode: <code>RUN &lt;command&gt;</code></li>
<li>exec mode: <code>RUN [&quot;execution&quot;, &quot;param1&quot;, &quot;param2&quot;]</code></li>
</ol></li>
<li>Note
<ul class="incremental">
<li>exec mode will be commit in JSON format, string must be quoted</li>
<li>exec mode will not expand container environment variable (which is shell's job)</li>
<li>can split long ocmmand line with ''</li>
<li>use <code>SHELL</code> command to set which shell to be used</li>
<li>generate new commit cache, use <code>docker build --no-cache</code> to ignore</li>
</ul></li>
</ul>
<h3 id="cmd-instruction">CMD instruction</h3>
<ul class="incremental">
<li>Like <code>RUN</code>, but does not execute anything at build time rather than speficies the intended command for the image</li>
<li>Provide the default command's for run container</li>
<li>Companion with <code>ENTRYPOINT</code></li>
<li>Only last one will take effect</li>
<li>Three formats
<ul class="incremental">
<li>exec form: <code>CMD [&quot;executable&quot;, &quot;param1&quot;, &quot;param2&quot;]</code></li>
<li>as the default parameters to ENTRYPOINT: <code>CMD [&quot;param1&quot;, &quot;param2&quot;]</code></li>
<li>shell form: <code>CMD command param1 param2</code></li>
</ul></li>
</ul>
<h3 id="label-instruction">LABEL instruction</h3>
<ul class="incremental">
<li><p>Add metadata to image</p>
<div class="sourceCode"><pre class="sourceCode dockerfile"><code class="sourceCode dockerfile"><span class="kw">LABEL</span> <span class="st">&quot;com.example.vendor&quot;</span>=<span class="st">&quot;ACME Incorporated&quot;</span>
<span class="kw">LABEL</span> com.example.label-with-value=<span class="st">&quot;foo&quot;</span>
<span class="kw">LABEL</span> version=<span class="st">&quot;1.0&quot;</span>
<span class="kw">LABEL</span> description=<span class="st">&quot;This text illustrates </span>\
<span class="st">        that label-values can span multiple lines.&quot;</span>
<span class="kw">LABEL</span> multi.label1=<span class="st">&quot;value1&quot;</span> multi.label2=<span class="st">&quot;value2&quot;</span> other=<span class="st">&quot;value3&quot;</span></code></pre></div></li>
<li>Check with <code>docker inspect</code></li>
<li><p>Image will inherit base or parent image's labels</p></li>
</ul>
<h3 id="expose-instruction">EXPOSE instruction</h3>
<ul class="incremental">
<li><p>Syntax</p>
<pre class="text"><code>EXPOSE &lt;port&gt; [&lt;port&gt;/&lt;protocol&gt;]
</code></pre></li>
<li>Just inform the listen port at runtime, do not publish the port</li>
<li><p>Manual publish with <code>docker run -p/-P</code></p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash"><span class="ex">docker</span> run -p 80:80/tcp -p 80:80/udp</code></pre></div></li>
</ul>
<h3 id="env-instruction">ENV instruction</h3>
<ul class="incremental">
<li><p>Syntax</p>
<pre class="text"><code>ENV &lt;key&gt; &lt;value&gt;
ENV &lt;key&gt;=&lt;value&gt; &lt;key&gt;=&lt;value&gt; ...
</code></pre></li>
<li>Will be replaced with its value</li>
<li>Both Dockerfile and runtime (os environment) can see</li>
<li><p>Can also set by command line</p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash"><span class="ex">docker</span> run --env <span class="op">&lt;</span>key<span class="op">&gt;</span>=<span class="op">&lt;</span>value<span class="op">&gt;</span></code></pre></div></li>
<li><p>Be care for overwriting the SHELL environment, use</p>
<div class="sourceCode"><pre class="sourceCode dockerfile"><code class="sourceCode dockerfile"><span class="kw">RUN</span> &lt;key&gt;=&lt;value&gt; &lt;command&gt;</code></pre></div></li>
</ul>
<h3 id="add-instruction">ADD instruction</h3>
<ul class="incremental">
<li>Copy files/directories/remote-resources to image's destination</li>
<li><p>syntax</p>
<pre class="text"><code>ADD [--chown=&lt;user&gt;:&lt;group&gt;] &lt;src&gt;... &lt;dest&gt;
ADD [--chown=&lt;user&gt;:&lt;group&gt;] [&quot;&lt;src&gt;&quot;,... &quot;&lt;dest&gt;&quot;]
</code></pre></li>
<li>Default owner is <code>0:0</code></li>
<li>Rules
<ul class="incremental">
<li>src
<ul class="incremental">
<li>Must inside the context of the build</li>
<li>if src is directory, copy its content</li>
<li>if src is archive file, unpack to destination</li>
</ul></li>
<li>dst
<ul class="incremental">
<li>if with trailing slash, copy file to the directory</li>
<li>if without trailing slash, overwrite destination file</li>
<li>if not exists, create the directory automatically</li>
</ul></li>
</ul></li>
</ul>
<h3 id="copy-instruction"><span class="todo TODO">TODO</span> COPY instruction</h3>
<ul class="incremental">
<li>Almost same in syntax and rules with <code>ADD</code></li>
<li><code>--from=&lt;name|index&gt;</code> set the source location to a previous build stage (<code>FROM .. AS &lt;name&gt;</code>)</li>
<li>vs <code>ADD</code> (TODO)</li>
</ul>
<h3 id="entrypoint-instruction">ENTRYPOINT instruction</h3>
<ul class="incremental">
<li>Configure the container to run as an executable</li>
<li>syntax
<ul class="incremental">
<li>exec form: <code>ENTRYPOINT [&quot;executable&quot;, &quot;param1&quot;, &quot;param2&quot;]</code></li>
<li>shell form: <code>ENTRYPOINT command param1 param2</code></li>
</ul></li>
<li>note
<ol class="incremental">
<li>add <code>exec</code> in shell form for receiving Unix signals, else <code>docker stop</code> will not work</li>
<li>shell form execute with <code>sh -c</code></li>
</ol></li>
<li><p>with <code>CMD</code></p>
<table>
<thead>
<tr class="header">
<th></th>
<th>No ENTRYPOINT</th>
<th>ENTRYPOINT exec<sub>entry</sub> p1<sub>entry</sub></th>
<th>ENTRYPOINT [“exec<sub>entry</sub>”, “p1<sub>entry</sub>”]</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>No CMD</td>
<td>error, not allowed</td>
<td>/bin/sh -c exec<sub>entry</sub> p1<sub>entry</sub></td>
<td>exec<sub>entry</sub> p1<sub>entry</sub></td>
</tr>
<tr class="even">
<td>CMD [“exec<sub>cmd</sub>”, “p1<sub>cmd</sub>”]</td>
<td>exec<sub>cmd</sub> p1<sub>cmd</sub></td>
<td>/bin/sh -c exec<sub>entry</sub> p1<sub>entry</sub></td>
<td>exec<sub>entry</sub> p1<sub>entry</sub> exec<sub>cmd</sub> p1<sub>cmd</sub></td>
</tr>
<tr class="odd">
<td>CMD [“p1<sub>cmd</sub>”, “p2<sub>cmd</sub>”]</td>
<td>p1<sub>cmd</sub> p2<sub>cmd</sub></td>
<td>/bin/sh -c exec<sub>entry</sub> p1<sub>entry</sub></td>
<td>exec<sub>entry</sub> p1<sub>entry</sub> p1<sub>cmd</sub> p2<sub>cmd</sub></td>
</tr>
<tr class="even">
<td>CMD exec<sub>cmd</sub> p1<sub>cmd</sub></td>
<td>/bin/sh -c exec<sub>cmd</sub> p1<sub>cmd</sub></td>
<td>/bin/sh -c exec<sub>entry</sub> p1<sub>entry</sub></td>
<td>exec<sub>entry</sub> p1<sub>entry</sub> /bin/sh -c exec<sub>cmd</sub> p1<sub>cmd</sub></td>
</tr>
</tbody>
</table></li>
</ul>
<h3 id="volume-instruction">VOLUME instruction</h3>
<ul class="incremental">
<li>Create shared volume (anonymous directories) with hosts</li>
<li>Remember to <code>docker run --rm</code> ensure cleaning when quit</li>
<li>Just mount point (can't mount a host directory from within the Dockerfile)</li>
</ul>
<h3 id="user-instruction">USER instruction</h3>
<ul class="incremental">
<li>set the user (and group) to use when running the image</li>
<li>for <code>RUN</code>, <code>CMD</code> and <code>ENTRYPOINT</code> instructions the follow it in the <code>Dockerfile</code></li>
<li><p>syntax</p>
<pre class="text"><code>USER &lt;user&gt;[:&lt;group&gt;] or
USER &lt;UID&gt;[:&lt;GID&gt;]
</code></pre></li>
</ul>
<h3 id="build-cache"><span class="todo TODO">TODO</span> build cache</h3>
<p><a href="https://docs.docker.com/engine/userguide/eng-image/dockerfile_best-practices/#build-cache">build cache reference</a></p>
<h3 id="push-a-repository-to-its-registry"><span class="todo TODO">TODO</span> push a repository to its registry</h3>
<p><a href="https://docs.docker.com/engine/tutorials/dockerrepos/#/contributing-to-docker-hub" class="uri">https://docs.docker.com/engine/tutorials/dockerrepos/#/contributing-to-docker-hub</a></p>
<h3 id="base-image"><span class="todo TODO">TODO</span> base image</h3>
<p><a href="https://docs.docker.com/engine/reference/glossary/#base-image" class="uri">https://docs.docker.com/engine/reference/glossary/#base-image</a></p>
<h1 id="best-practice"><span class="todo TODO">TODO</span> best practice</h1>
<h2 id="docker-overview">Docker Overview</h2>
<p>Dockerfile instruct docker daemon build image in multiple layers. Then generate a container, you add a new writable layer (container layer) on top of the underlying layers.</p>
<h2 id="general-guidelines-and-recommendations">General guidelines and recommendations</h2>
<h3 id="create-ephemeral-containers">Create ephemeral containers</h3>
<p>To be rebuilt and replaced easily</p>
<h3 id="understand-build-context">Understand build context</h3>
<p>avoid large build context</p>
<h3 id="pipe-dockerfile-through-stdin-docker-17.05-and-higher">Pipe Dockerfile through <code>stdin</code> (Docker 17.05 and higher)</h3>
<p>with local or remote build-context</p>
<h3 id="exclude-with-.dockerignore">Exclude with <code>.dockerignore</code></h3>
<p>similar to <code>.gitignore</code></p>
<h3 id="multi-stage-builds-docker-17.05-or-higher">Multi-stage builds (Docker 17.05 or higher)</h3>
<div class="sourceCode"><pre class="sourceCode dockerfile"><code class="sourceCode dockerfile"><span class="kw">FROM</span> golang:1.9.2-alpine3.6 AS build
<span class="co">## skip ...</span>

<span class="kw">FROM</span> scratch
<span class="kw">COPY</span> --from=build /bin/project /bin/project
<span class="co">## skip ...</span></code></pre></div>
<p><a href="https://docs.docker.com/engine/userguide/eng-image/dockerfile_best-practices/" class="uri">https://docs.docker.com/engine/userguide/eng-image/dockerfile_best-practices/</a></p>
<h3 id="dont-install-unnecessary-packages">Don't install unnecessary packages</h3>
<h1 id="docker-network">docker network</h1>
<h2 id="overview-2">Overview</h2>
<p>Split into 6 categories according to the network drivers</p>
<dl class="incremental">
<dt>bridge</dt>
<dd>default, link layer, port mapping
</dd>
<dt>host</dt>
<dd>virtual host IP
</dd>
<dt>overlay</dt>
<dd>cross multiple hosts
</dd>
<dt>macvlan</dt>
<dd>physical layer, assign MAC
</dd>
<dt>none</dt>
<dd>no network
</dd>
<dt>custom plugins</dt>
<dd>others
</dd>
</dl>
<h2 id="commands">Commands</h2>
<dl class="incremental">
<dt>Create bridge network</dt>
<dd><code>docker network create --driver bridge bridge2</code>
</dd>
<dt>List networks</dt>
<dd><code>docker network ls</code>
</dd>
<dt>Join container to network</dt>
<dd><code>docker network connect &lt;bridge&gt; &lt;container&gt;</code>
</dd>
<dt>Disconnect container from network</dt>
<dd><code>docker network disconnect &lt;bridge&gt; &lt;container&gt;</code>
</dd>
<dt>Delete network</dt>
<dd><code>docker network rm &lt;network&gt;</code>
</dd>
<dt>Inspect network</dt>
<dd><code>docker network inspect bridge</code>
</dd>
</dl>
<h2 id="bridge-network">Bridge Network</h2>
<p>Software bridge network which can isolate from containers not connected to the bridge and can automatically install rules in host OS.</p>
<p>By default, Docker create network named <code>bridge</code>. Check with</p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash"><span class="ex">docker</span> network ls</code></pre></div>
<p>User can create his own bridge network which is recommended in production environments:</p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash"><span class="ex">docker</span> network create --driver bridge brg0</code></pre></div>
<p>Docker container can join the bridge network by:</p>
<ol class="incremental">
<li><code>docker run</code> with <code>--network &lt;network&gt;</code> parameter</li>
<li>with <code>docker network connect</code> command</li>
</ol>
<p>User-defined bridge network is recommended in production environment:</p>
<ol class="incremental">
<li>better isolation and interoperability between containerized aplications
<ul class="incremental">
<li>expose all ports to each other</li>
<li>expose no ports to the outside world</li>
</ul></li>
<li>automatic DNS resolution between containers (not worked in <code>default</code> bridge)</li>
<li>container can be attached and detached from user-defined network on the fly</li>
<li>configuable</li>
</ol>
<p>On user-defined networks, containers can communicate by container name (<strong>automatic service discovery</strong>) when the container on and only on the same bridge network.</p>
<ul class="incremental">
<li><a href="https://docs.docker.com/network/" class="uri">https://docs.docker.com/network/</a></li>
</ul>
<h1 id="manage-containers">manage containers</h1>
<ul class="incremental">
<li><a href="https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux_atomic_host/7/html-single/managing_containers/" class="uri">https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux_atomic_host/7/html-single/managing_containers/</a></li>
</ul>
<h2 id="attach-with-detach"><span class="todo TODO">TODO</span> attach with detach</h2>
<h2 id="parameters-in-docker-run">parameters in <code>docker run</code></h2>
<dl class="incremental">
<dt><code>-d</code></dt>
<dd>deteached (in the background)
</dd>
<dt><code>-i</code></dt>
<dd>interactive
</dd>
<dt><code>-t</code></dt>
<dd>TTY (can see Input and Output)
</dd>
</dl>
<h1 id="docker-volume">docker volume</h1>
<ul class="incremental">
<li><a href="https://docs.docker.com/engine/tutorials/dockervolumes/#/mount-a-host-directory-as-a-data-volume">Share Directories via Volumes</a></li>
<li><a href="https://docs.docker.com/storage/storagedriver/">About Storage Driver</a></li>
</ul>
<h1 id="docker-versions"><span class="todo TODO">TODO</span> docker versions</h1>
<h1 id="how-to">how to</h1>
<h2 id="stop-container">stop container</h2>
<p>Stop and delete container</p>
<ol class="incremental">
<li><code>docker container stop &lt;container-id&gt;</code></li>
<li><code>docker container rm &lt;container-id&gt;</code></li>
</ol>
<p>Or start with <code>--rm</code> parameter in <code>docker run</code></p>
<h2 id="configure-dockerd-to-store-imagevolumelayer-to-another-disk">configure dockerd to store image/volume/layer to another disk</h2>
<p>Configure dockerd by edit <code>/etc/docker/daemon.json</code></p>
<ol class="incremental">
<li>data-root</li>
<li>exec-root</li>
</ol>
<p>Can also copy old data <code>/var/lib/docker/</code> to <code>data-root</code>. (Be careful to perserve the permissions of files during copy)</p>

				</div>
			</section>
		</body>
	</html>
	
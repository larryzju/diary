<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf8"></meta>
    <title>thrift.org</title>
    <link rel="stylesheet" href="/diary/resources/css/main.css" />
    <link rel="stylesheet" href="/diary/resources/highlight/styles/default.css" />
    <script src="/diary/resources/js/jquery-3.4.1.min.js"></script>
    <script src="/diary/resources/js/swgen.js"></script>
    <script src="/diary/resources/highlight/highlight.pack.js"></script>
    <script src='https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-MML-AM_CHTML' async></script>
    <script>hljs.initHighlightingOnLoad();</script>
  </head>
  <body>
    <section class="main-article-area">
      <nav id='content'>
	<span id="prev">
	  	
	  <a href="/diary/programming/storm.org.html">Prev: storm.org</a>
	  	
	</span>

	<span id="home"><a href="/diary">Home</a></span>
	<span id="Up">
	  
	  <a href="/diary/programming">Up: programming</a>
	  	
	</span>

	<span id="next">
	  
	  <a href="/diary/programming/typescript.org.html">Next: typescript.org</a>
	  	
	</span>
      </nav>
      
      <div id='main'>
	<h1 id="说明">说明</h1>
<p>thrift 是软件栈，提供了跨语言的 RPC 功能。</p>
<p>通过编写 <code>.thrift</code> 描述文件，通过 thrift 编译器生成相关语言的 client 和 server 代码，封装了数据传输、序列化、应用级处理相关内容。</p>
<p>基本的 thrift 描述文件中定义了新的数据类型，以及 service interface</p>
<h1 id="类型系统">类型系统</h1>
<h2 id="基本类型">基本类型</h2>
<p>如 <code>bool</code>, <code>byte</code>, <code>i16</code>, <code>i32</code>, <code>i64</code>, <code>double</code>, <code>string</code> 。不支持 <code>unsigned</code> 修饰</p>
<h2 id="特殊类型">特殊类型</h2>
<dl class="incremental">
<dt><code>binary</code></dt>
<dd>未编码过的二进制序列
</dd>
</dl>
<h2 id="结构体">结构体</h2>
<p>关键字为 <code>struct</code> ，与 C 的相似</p>
<ul class="incremental">
<li>有多个成员</li>
<li>需要指定其类型</li>
</ul>
<p>不同之处在于</p>
<ul class="incremental">
<li>有唯一的标识 id （用于版本管理）</li>
<li>可以指定 optional （类似于 java 中的 transient，不会序列化）</li>
</ul>
<h2 id="容器">容器</h2>
<p>有三种</p>
<table>
<thead>
<tr class="header">
<th>type</th>
<th>java type</th>
<th>description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>list</td>
<td>ArrayList</td>
<td></td>
</tr>
<tr class="even">
<td>set</td>
<td>HashSet</td>
<td></td>
</tr>
<tr class="odd">
<td>map</td>
<td>HashMap</td>
<td></td>
</tr>
</tbody>
</table>
<h2 id="异常">异常</h2>
<p>类似于 scala 中的 case class 构造方法</p>
<h2 id="services">services</h2>
<p>翻译成 java 中的 interface，提供如下功能</p>
<ul class="incremental">
<li>包括一组具名函数，函数有参数列表和返回类型，可以抛出异常</li>
<li>定义的只是接口，需要具体语言通过扩展 <code>iface</code> 来实现</li>
</ul>
<h1 id="协议栈">协议栈</h1>
<h2 id="runtime-library">Runtime Library</h2>
<p>包括两部分：</p>
<ul class="incremental">
<li>protocol，指定序列化方法</li>
<li>transport, 指定传输方式（提供远程读写的管线）</li>
</ul>
<h3 id="protocol-layer">protocol layer</h3>
<ul class="incremental">
<li><code>TBinaryProtocol</code></li>
<li><code>TCompactProtocol</code></li>
<li><code>TDenseProtocol</code></li>
<li><code>TJSONProtocol</code></li>
<li><code>TSimpleJSONProtocol</code></li>
<li><code>TDebugProtocol</code></li>
</ul>
<h3 id="transport-layer">transport layer</h3>
<ul class="incremental">
<li><code>TSocket</code></li>
<li><code>TFramedTransport</code></li>
<li><code>TFileTransport</code></li>
<li><code>TMemoryTransport</code></li>
<li><code>TZlibTransport</code></li>
</ul>
<h2 id="processor">Processor</h2>
<p>封装 <code>Handler</code> （Handler 为用户按照 thrift service 定义实现类）。作用是对输入请求进行处理，生成输出。用在 Server 中。</p>
<h2 id="server">Server</h2>
<p>提供了服务端的几种实现，用于响应客户端请求，调用 Process 处理</p>
<p>可用的实现有</p>
<ul class="incremental">
<li><code>TSimpleServer</code></li>
<li><code>TThreadPoolServer</code></li>
<li><code>TNonblockingServer</code></li>
</ul>
<h1 id="语法及命令">语法及命令</h1>
<ul class="incremental">
<li>使用 <code>thrift --gen &lt;type&gt; &lt;thrift-file&gt;</code> 来生成语言相关代码</li>
<li><code>include &lt;thrift-file&gt;</code> 来包含其他的 thrift 文件，并用文件名作为 namespace 访问</li>
<li><code>enum</code> 定义枚举，从 1 开始</li>
<li>services 中可以使用 <code>extends</code> 来扩展其它服务定义的函数</li>
<li>函数 <code>oneway</code> 修饰符，用于表示客户端单向请求，不需要回应</li>
<li><code>typedef</code> 定义别名</li>
<li><code>map&lt;string,string&gt;</code> 常量定义可用 JSON 字面量来初始化</li>
</ul>
<h1 id="开发">开发</h1>
<h2 id="server-1">Server</h2>
<ul class="incremental">
<li>最终目标是定义一个 TServer 实例，并调用其 <code>server</code> 方法启动监听</li>
<li><code>TServer</code> 有多种实现，如 <code>TSimpleServer</code>, <code>TThreadPoolServer</code> 等</li>
<li>Server 需要指定端口号，及 <code>Processor</code></li>
<li><code>Processor</code> 为服务的 Handler 实现的封装</li>
</ul>
<h2 id="client">Client</h2>
<ul class="incremental">
<li>与 Server 建立连接，并进行远程方法调用</li>
<li>用 <code>Service.Client( protocol )</code> 生成连接实例</li>
<li>protocol 指定 transport 方式（ socket 或其它）</li>
</ul>
<h1 id="参考资料">参考资料</h1>
<ul class="incremental">
<li><a href="http://thrift-tutorial.readthedocs.io/en/latest/index.html">Thrift Tutorial</a></li>
<li>thrift 源码 tutorial 代码</li>
<li><a href="http://jnb.ociweb.com/jnb/jnbJun2009.html">Apache Thrift</a></li>
<li><a href="http://thrift.apache.org/static/files/thrift-20070401.pdf">Thrift: Scalable Cross-Language Services Implementation</a></li>
</ul>

      </div>
    </section>
  </body>
</html>

<!DOCTYPE html>
<html>
	<head>
		<title>spark.org</title>
		<link rel="stylesheet" href="/diary/resources/css/main.css" />
		<link rel="stylesheet" href="/diary/resources/highlight/styles/default.css" />
		<script src="/diary/resources/js/jquery-3.4.1.min.js"></script>
		<script src="/diary/resources/js/swgen.js"></script>
		<script src="/diary/resources/highlight/highlight.pack.js"></script>
		<script src='https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-MML-AM_CHTML' async></script>
		<script>hljs.initHighlightingOnLoad();</script>
	</head>
	<body>
		<nav id='content'>
		</nav>
		<section class="main-article-area">
			<div id='main'>
				<h1 id="pivot-reshaping-the-data"><strong>pivot</strong>: reshaping the data</h1>
<h2 id="概述">概述</h2>
<p>Spark 1.6 中引入了 pivot tables 功能，转置表结构，把某列的内容作为新的列名。可以用于窄表向宽表的转换。</p>
<p>本质上是进行聚合操作： A pivot is an aggregation where one (or more) of the grouping columns has its distinct values transposed into individual columns.</p>
<p>部分 RDBM 及数据分析工具都提供了类型的功能，但在语法上各有不同</p>
<h2 id="语法">语法</h2>
<p>按 A，B 列进行分组，以 C 为旋转轴，对 D 列进行求和。分别用 pandas(Python), reshapes2(R) 和 spark(Scala) 表示，语法如下（作为比较，增强理解）</p>
<table>
<thead>
<tr class="header">
<th>library/language</th>
<th>syntax</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>pandas</td>
<td><code>pivot_table(df, values='D', index=['A','B'], columns=['C'], aggfunc=np.sum)</code></td>
</tr>
<tr class="even">
<td>reshape2</td>
<td><code>dcast(df, A+B~C, sum)</code></td>
</tr>
<tr class="odd">
<td>spark</td>
<td><code>df.groupBy("A","B").pivot("C").sum("D")</code></td>
</tr>
</tbody>
</table>
<p>spark 的 pivot 范式如下</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb1-1"><a href="#cb1-1"></a>df.<span class="fu">groupBy</span>(grouping_columns)</span>
<span id="cb1-2"><a href="#cb1-2"></a>  .<span class="fu">pivot</span>(pivot_columns, [values])</span>
<span id="cb1-3"><a href="#cb1-3"></a>  .<span class="fu">agg</span>(aggregate_expressions)</span></code></pre></div>
<h2 id="性能优化建议">性能优化建议</h2>
<ol class="incremental">
<li>pivot 支持第二个参数，指定 pivot column，表示 pivot 列可能的取值，提高效率。如 <code>.pivot("C",Seq("small","large"))</code></li>
<li>指定 pivot column 提前排好序</li>
<li>spark 不支持直接对多列进行 pivot。需要对多列作 pivot 作计算时，可以用 concat 生成新列</li>
</ol>

			</div>
		</section>
	</body>
</html>

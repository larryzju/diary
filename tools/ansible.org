#+TITLE: Ansible
#+AUTHOR: Zhao Wenbin

* Overview 

** What is Ansible

- automation language (playbook yaml syntax)
- automation engine (=ansible-playbook=)
- Ansible Tower (UI and RESTFul API server)

** Ecosystem

- Red Hat Support
- Ansible Tower
- Ansible Galaxy (CPAN?)

** Feature

- Simple
- Powerful
- Agentless

** TODO Usage

- Config Management
- App deployment
- Provision?
- Continuous delivery?
- Security & Compliance?
- Orchestration?

** Architecture

- Inventory :: lists of hosts
- Playbook :: Describe the desired state of something. Contains *Plays* and *play* contains *Tasks*
- Tasks :: Task run sequentially and calls *Modules*
- Modules :: ?
- Variable :: ?
- Discovered variables (facts) :: ?
- Handlers :: Triggered by Tasks
- Roles :: kind of Playbook that is fully self-contained with task, variables, configurations templates

** How to use

1. ad-hoc command line: =ansible inventory -m=
2. ansible-playbook
3. Ansible Tower (UI)

** Notes

- 批量执行命令
- 类似于 pdsh，更强大
- 无需在各 node 上部署客户端 (Agentless)
- 支持 modules 和 plugins 扩展
- 通过 =/etc/ansible/hosts= 配置主机组
- 通过 Jinja2 语法提供模板替换

* Variable

See [[*Inventory][Inventory]]

* Inventory

** Basic

- Default configure file is located at =/etc/ansible/hosts=
- Group hosts to *group* ( section name in =ini= file )
- Group variables can be defined at section =group_name:vars=
- Two default groups: =all= and =ungrouped=

** Feature

- Jumper :: Alias for host ( =ansible_host= or =ansible_port= )
- Connection Type :: Set =ansible_connection= to =smart=, or =ssh=, or =paramiko=, or =docker=
- Range pattern :: Such as =www[01:50].example.com= 

** Splitting Out Host and Group Specific Data

- Split varaible definition to seperated files
- Files will be placed at =/etc/ansible/{group_vars, host_vars}/name/=

** How Variables Are Merged

The order/precedence is (from lowest to highest):
1. all group
2. parent group
3. child group
4. host

Merge order can be changed by =ansible_group_priority= setting

* Modules

** group

** user

** copy

** file

- Change permission
- Create directory

** TODO fetch

** command

** TODO shell

** cron

** yum

** service

** TODO git
** TODO script

script at local?

** TODO async-status

* Playbook

** Overview

- 通过 yaml 语法进行配置
- =ansible-playbook= 最佳实践
  1. =--syntax-check= 检查语法
  2. =-C= 试运行 (dry-run)


** notify - handlers

** tags

** TODO varibles

** TODO templates

** TODO condition/loop syntax

** TODO roles
* Command line

** ansible-doc

* Misc

** Log types

1. with SSH Key
2. Ask for password =--ask-pass=
3. Switch to other user (=sudo=) with =--ask-become-pass=

** Disable host-key

Disable =host-key-checking= for
1. host information change in =know_hosts=
2. first time to login a ssh server

** =ansible all -m setup=

** background execute

- =-B 3600=: run in background for most 3600s
- =-P= for polling

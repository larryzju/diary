<!DOCTYPE html>
<html>
	<head>
		<title>ansible.org</title>
		<link rel="stylesheet" href="/diary/resources/css/main.css" />
		<link rel="stylesheet" href="/diary/resources/highlight/styles/default.css" />
		<script src="/diary/resources/js/jquery-3.4.1.min.js"></script>
		<script src="/diary/resources/js/swgen.js"></script>
		<script src="/diary/resources/highlight/highlight.pack.js"></script>
		<script>hljs.initHighlightingOnLoad();</script>
	</head>
	<body>
		<nav id='content'>
		</nav>
		<section class="main-article-area">
			<div id='main'>
				<h1 id="overview">Overview</h1>
<p>Run <code>playbook</code> (in YAML format) on multiple remote hosts (defined by <code>Inventory</code>) without deploy clients on hosts.</p>
<p>Ansible provides rich sets of <code>Modules</code> which can hide the detail of underlying platform or system (kubernete, linux, windows, docker...)</p>
<p>The word <code>Ansible</code> has different means:</p>
<ol class="incremental">
<li>language specification for playbook</li>
<li>execute engine: <code>ansible-playbook</code></li>
<li>Ansible Tower: Enterprise API server with UI</li>
</ol>
<h2 id="usage"><span class="todo TODO">TODO</span> Usage</h2>
<ul class="incremental">
<li>Config Management</li>
<li>App deployment</li>
<li>Provision?</li>
<li>Continuous delivery?</li>
<li>Security &amp; Compliance?</li>
<li>Orchestration?</li>
</ul>
<h2 id="architecture">Architecture</h2>
<h2 id="terms">Terms</h2>
<dl class="incremental">
<dt>Inventory</dt>
<dd>hosts group
</dd>
<dt>Playbook</dt>
<dd>collections of <code>plays</code> which contains <code>tasks</code>
</dd>
<dt>Tasks</dt>
<dd>task run sequentially and calls <strong>Modules</strong>
</dd>
<dt>Modules</dt>
<dd>underlying implement in python
</dd>
<dt>Variable</dt>
<dd>substitute in runtime
</dd>
<dt>Discovered variables (facts)</dt>
<dd>runtime parameters of hosts
</dd>
<dt>Handlers</dt>
<dd>Triggered by Tasks's <strong>Notify</strong>
</dd>
<dt>Roles</dt>
<dd>kind of Playbook that is fully self-contained with task, variables, configurations templates
</dd>
</dl>
<h2 id="how-to-use">How to use</h2>
<ol class="incremental">
<li>ad-hoc command line: <code>ansible inventory -m</code></li>
<li><code>ansible-playbook</code> command line</li>
<li>Ansible Tower (UI)</li>
</ol>
<h2 id="notes">Notes</h2>
<p>核心功能是： <strong>登录到一组主机，执行一套命令</strong></p>
<ul class="incremental">
<li>主机组由 Inventory 定义，主机组配置灵活</li>
<li>执行的这组命令称为 Task List</li>
<li>Task List 中的命令以一定的顺序执行</li>
<li>每个 Task 调用系统功能，称为 Module</li>
<li>Module 以 Python 实现，最常见的如 shell 和 file 操作</li>
<li>远程机器的方式可以有 ssh 或 docker，在 module 上实现了操作的统一</li>
<li>无需在各 node 上部署客户端 (Agentless)</li>
<li>通过 Jinja2 语法提供模板替换</li>
</ul>
<h1 id="ad-hoc">Ad-Hoc</h1>
<p><code>ansible</code> command provide ansible ad-hoc cli interface which can do quick things that you might not necessarily want to write a full playbook for.</p>
<p>For example, to get ip list for all hosts defined in inventory-file</p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash"><span class="ex">ansible</span> -i inventory-file all -m shell -a <span class="st">&#39;ip addr list&#39;</span></code></pre></div>
<p>By default, ansible use <code>command</code> module. Option <code>-a</code> will pass the arguments (in key-value pairs) to module.</p>
<h1 id="variable">Variable</h1>
<p>See <em>Inventory</em></p>
<dl class="incremental">
<dt><code>register</code></dt>
<dd>?
</dd>
</dl>
<h1 id="inventory">Inventory</h1>
<h2 id="basic">Basic</h2>
<ul class="incremental">
<li>Default configure file is located at <code>/etc/ansible/hosts</code></li>
<li>Group hosts to <strong>group</strong> ( with the section name in <code>ini</code> file )</li>
<li>Group variables can be defined at section <code>group_name:vars</code></li>
<li>Two default groups: <code>all</code> and <code>ungrouped</code></li>
<li>Coupled with variable definition</li>
<li>Recommend to <em>split variable definition to seperated files</em></li>
</ul>
<h2 id="feature">Feature</h2>
<dl class="incremental">
<dt>Jumper</dt>
<dd>Alias for host ( <code>ansible_host</code> or <code>ansible_port</code> )
</dd>
<dt>Connection Type</dt>
<dd>Set <code>ansible_connection</code> to <code>smart</code>, or <code>ssh</code>, or <code>paramiko</code>, or <code>docker</code>
</dd>
<dt>Range pattern</dt>
<dd>Such as <code>www[01:50].example.com</code>
</dd>
</dl>
<h2 id="splitting-out-host-and-group-specific-data">Splitting Out Host and Group Specific Data</h2>
<ul class="incremental">
<li>Split varaible definition to seperated files</li>
<li>Files will be placed at <code>/etc/ansible/{group_vars, host_vars}/name/</code></li>
<li>Let group to manage the logical host sets</li>
<li>Attach variable defintions to logical host set</li>
</ul>
<h2 id="how-variables-are-merged">How Variables Are Merged</h2>
<p>The order/precedence is (from lowest to highest):</p>
<ol class="incremental">
<li>all group</li>
<li>parent group</li>
<li>child group</li>
<li>host</li>
</ol>
<p>Merge order can be changed by <code>ansible_group_priority</code> setting</p>
<h1 id="playbook">Playbook</h1>
<h2 id="basic-1">Basic</h2>
<ul class="incremental">
<li>Playbook defines lists of <strong>plays</strong></li>
<li>Play maps a group of <strong>hosts</strong> to some well defined <strong>roles</strong>, represented by things ansible calls <strong>tasks</strong></li>
<li>Task calls to an ansible <strong>module</strong></li>
</ul>
<h2 id="order-of-players-in-playbook"><span class="todo TODO">TODO</span> Order of players (in Playbook)</h2>
<h2 id="order-of-tasks-in-play"><span class="todo TODO">TODO</span> Order of tasks (in Play)</h2>
<h2 id="notes-1">Notes</h2>
<ul class="incremental">
<li>通过 yaml 语法进行配置</li>
<li><code>ansible-playbook</code> 最佳实践
<ol class="incremental">
<li><code>--syntax-check</code> 检查语法</li>
<li><code>-C</code> 试运行 (dry-run)</li>
</ol></li>
</ul>
<h2 id="blocks">Blocks</h2>
<h3 id="what-is-block">What is block</h3>
<p>Blocks allow for logical grouping of tasks and in play error handling</p>
<h3 id="example">Example</h3>
<div class="sourceCode"><pre class="sourceCode yaml"><code class="sourceCode yaml"><span class="fu">tasks:</span>
  <span class="kw">-</span> <span class="fu">name:</span><span class="at"> Install Apache</span>
    <span class="fu">block:</span><span class="at">                     </span><span class="co"># become, when, become_user will be applied to this block</span>
      <span class="kw">-</span> <span class="fu">yum:</span>
          <span class="fu">name:</span><span class="at"> </span><span class="st">&quot;{{ item }}&quot;</span>
          <span class="fu">state:</span><span class="at"> installed</span>
        <span class="fu">with_items:</span>
          <span class="kw">-</span> httpd
          <span class="kw">-</span> memcached
      <span class="kw">-</span> <span class="fu">template:</span>
          <span class="fu">src:</span><span class="at"> templates/src.j2</span>
          <span class="fu">dest:</span><span class="at"> /etc/foo.conf</span>
      <span class="kw">-</span> <span class="fu">service:</span>
          <span class="fu">name:</span><span class="at"> bar</span>
          <span class="fu">state:</span><span class="at"> started</span>
          <span class="fu">enabled:</span><span class="at"> True</span>
    <span class="fu">when:</span><span class="at"> ansible_distribution == &#39;CentOS&#39;</span>
    <span class="fu">become:</span><span class="at"> true</span>
    <span class="fu">become_user:</span><span class="at"> root</span></code></pre></div>
<h3 id="error-handling">Error Handling</h3>
<div class="sourceCode"><pre class="sourceCode yaml"><code class="sourceCode yaml"><span class="fu">tasks:</span>
<span class="kw">-</span> <span class="fu">name:</span><span class="at"> Attempt and graceful roll back demo</span>
  <span class="fu">block:</span>
    <span class="kw">-</span> <span class="fu">debug:</span>
        <span class="fu">msg:</span><span class="at"> </span><span class="st">&#39;I execute normally&#39;</span>
    <span class="kw">-</span> <span class="fu">command:</span><span class="at"> /bin/false</span>
    <span class="kw">-</span> <span class="fu">debug:</span>
        <span class="fu">msg:</span><span class="at"> </span><span class="st">&#39;I never execute, due to the above task failing&#39;</span>
  <span class="fu">rescue:</span>
    <span class="kw">-</span> <span class="fu">debug:</span>
        <span class="fu">msg:</span><span class="at"> </span><span class="st">&#39;I caught an error&#39;</span>
    <span class="kw">-</span> <span class="fu">command:</span><span class="at"> /bin/false</span>
    <span class="kw">-</span> <span class="fu">debug:</span>
        <span class="fu">msg:</span><span class="at"> </span><span class="st">&#39;I also never execute :-(&#39;</span>
  <span class="fu">always:</span>
    <span class="kw">-</span> <span class="fu">debug:</span>
        <span class="fu">msg:</span><span class="at"> </span><span class="st">&quot;This always executes&quot;</span></code></pre></div>
<ul class="incremental">
<li>Similar to python <code>try...except...finally</code> logical</li>
</ul>
<h3 id="variable-1">Variable</h3>
<dl class="incremental">
<dt><code>ansible_failed_task</code></dt>
<dd>The task object that returned ‘failed’ and triggered the rescue
</dd>
<dt><code>ansible_failed_result</code></dt>
<dd>The captured return result of the failed task that triggered the rescue
</dd>
</dl>
<h2 id="notify---handlers">notify - handlers</h2>
<ul class="incremental">
<li>'Notify' actions are triggered at the end of each block of tasks in a play, only be triggered only once</li>
<li>'Handlers' are lists of tasks that are referenced by a globally unique name</li>
<li>Regardless of how many tasks notify a handler, the handler will run only once</li>
<li>'Handlers' can listen to spefic named notify (match with handler's name in classic way)</li>
</ul>
<h2 id="tags">Tags</h2>
<h3 id="usage-1">Usage</h3>
<p>For <code>ansible-playbook</code> command line to filter with tags:</p>
<ul class="incremental">
<li><code>--tags</code>: match tags</li>
<li><code>--skip-tags</code>: skip tags</li>
</ul>
<h3 id="scope">Scope</h3>
<p>Can be applied to multiple levels:</p>
<ol class="incremental">
<li>task</li>
<li>play</li>
<li>role</li>
<li>import file</li>
</ol>
<p>Note: Not works at <code>include_tasks</code>, for its dynamic include feature</p>
<h3 id="misc">Misc</h3>
<ul class="incremental">
<li>Use <code>--list-tags</code> in <code>ansible-playbook</code> command line to check all tags</li>
<li>Special tags <code>always</code> and <code>never</code> can be used in mark</li>
<li>Can filter with special tags named <code>tagged</code>, <code>untagged</code>, <code>all</code></li>
</ul>
<h2 id="varibles"><span class="todo TODO">TODO</span> varibles</h2>
<h2 id="templates"><span class="todo TODO">TODO</span> templates</h2>
<h2 id="conditional">Conditional</h2>
<h3 id="why">Why?</h3>
<p>Often the result of a play may depend on</p>
<ol class="incremental">
<li>the value of variable</li>
<li>fact (something learned about the remote system)</li>
<li>previous task result</li>
</ol>
<h3 id="when-statement"><code>when</code> statement</h3>
<ul class="incremental">
<li>without double curly braces</li>
<li>can use parathese to group condition (with logical likes <code>or</code>)</li>
<li>Multiple conditions as a list means logical <code>and</code></li>
<li><code>register</code> result can be compared with <code>{failed,successed,skipped}</code></li>
<li><p>Boolean check</p>
<div class="sourceCode"><pre class="sourceCode yaml"><code class="sourceCode yaml"><span class="fu">vars:</span>
  <span class="fu">epic:</span><span class="at"> true</span>


<span class="co">## true</span>
<span class="fu">tasks:</span>
    <span class="kw">-</span> <span class="fu">shell:</span><span class="at"> echo &quot;This certainly is epic!&quot;</span>
      <span class="fu">when:</span><span class="at"> epic</span>

<span class="co">## or false:</span>
<span class="fu">tasks:</span>
    <span class="kw">-</span> <span class="fu">shell:</span><span class="at"> echo &quot;This certainly isn&#39;t epic!&quot;</span>
      <span class="fu">when:</span><span class="at"> not epic</span></code></pre></div></li>
<li><p>Defined check</p>
<div class="sourceCode"><pre class="sourceCode yaml"><code class="sourceCode yaml"><span class="fu">tasks:</span>
    <span class="kw">-</span> <span class="fu">shell:</span><span class="at"> echo &quot;I&#39;ve got &#39;{{ foo }}&#39; and am not afraid to use it!&quot;</span>
      <span class="fu">when:</span><span class="at"> foo is defined</span>

    <span class="kw">-</span> <span class="fu">fail:</span><span class="at"> msg=&quot;Bailing out. this play requires &#39;bar&#39;&quot;</span>
      <span class="fu">when:</span><span class="at"> bar is undefined</span></code></pre></div></li>
</ul>
<h3 id="loops-and-conditionals">Loops and Conditionals</h3>
<div class="sourceCode"><pre class="sourceCode yaml"><code class="sourceCode yaml"><span class="fu">tasks:</span>
    <span class="kw">-</span> <span class="fu">command:</span><span class="at"> echo {{ item }}</span>
      <span class="fu">loop:</span><span class="at"> </span><span class="kw">[</span> 0<span class="kw">,</span> 2<span class="kw">,</span> 4<span class="kw">,</span> 6<span class="kw">,</span> 8<span class="kw">,</span> 10 <span class="kw">]</span>
      <span class="fu">when:</span><span class="at"> item &gt; 5</span></code></pre></div>
<p>Withing <code>lookup</code> plugin's <code>dict</code> command</p>
<div class="sourceCode"><pre class="sourceCode yaml"><code class="sourceCode yaml"><span class="fu">vars:</span>
  <span class="fu">persons:</span>
    <span class="fu">Lily:</span>
      <span class="fu">sex:</span><span class="at"> female</span>
      <span class="fu">age:</span><span class="at"> 29</span>
    <span class="fu">Lucy:</span>
      <span class="fu">sex:</span><span class="at"> female</span>
      <span class="fu">age:</span><span class="at"> 29</span>
    <span class="fu">LiLei:</span>
      <span class="fu">sex:</span><span class="at"> male</span>
      <span class="fu">age:</span><span class="at"> 30</span>

<span class="fu">tasks:</span>

  <span class="kw">-</span> <span class="fu">name:</span><span class="at"> show male&#39;s list</span>
    <span class="fu">debug:</span>
      <span class="fu">msg:</span><span class="at"> Mr.{{item.key}}&#39;s age is {{item.value.age}}</span>
    <span class="fu">loop:</span><span class="at"> </span><span class="st">&quot;{{ query(&#39;dict&#39;, persons) }}&quot;</span>
    <span class="fu">when:</span><span class="at"> item.value.sex == &#39;male&#39;</span>

  <span class="kw">-</span> <span class="fu">name:</span><span class="at"> show female&#39;s list</span>
    <span class="fu">debug:</span>
      <span class="fu">msg:</span><span class="at"> Miss.{{item.key}}&#39;s age is {{item.value.age}}</span>
    <span class="fu">loop:</span><span class="at"> </span><span class="st">&quot;{{ query(&#39;dict&#39;, persons) }}&quot;</span>
    <span class="fu">when:</span><span class="at"> item.value.sex == &#39;female&#39;</span></code></pre></div>
<h3 id="loading-in-custom-facts"><span class="todo TODO">TODO</span> Loading in Custom Facts</h3>
<h3 id="applying-when-to-roles-imports-and-includes">Applying ‘when’ to roles, imports, and includes</h3>
<div class="sourceCode"><pre class="sourceCode yaml"><code class="sourceCode yaml"><span class="kw">-</span> <span class="fu">hosts:</span><span class="at"> webservers</span>
  <span class="fu">roles:</span>
     <span class="kw">-</span> <span class="fu">role:</span><span class="at"> debian_stock_config</span>
       <span class="fu">when:</span><span class="at"> ansible_os_family == &#39;Debian&#39;</span></code></pre></div>
<h3 id="register-variables">Register variables</h3>
<div class="sourceCode"><pre class="sourceCode yaml"><code class="sourceCode yaml"><span class="kw">-</span> <span class="fu">name:</span><span class="at"> test play</span>
  <span class="fu">hosts:</span><span class="at"> all</span>

  <span class="fu">tasks:</span>

      <span class="kw">-</span> <span class="fu">shell:</span><span class="at"> cat /etc/motd</span>
        <span class="fu">register:</span><span class="at"> motd_contents</span>

      <span class="kw">-</span> <span class="fu">shell:</span><span class="at"> echo &quot;motd contains the word hi&quot;</span>
        <span class="fu">when:</span><span class="at"> motd_contents.stdout.find(&#39;hi&#39;) != -1</span></code></pre></div>
<h3 id="conditional-imports"><span class="todo TODO">TODO</span> conditional Imports</h3>
<h3 id="selecting-files-and-templates-based-on-variables"><span class="todo TODO">TODO</span> Selecting Files and Templates based on variables</h3>
<h2 id="loops">Loops</h2>
<h3 id="scenes">scenes</h3>
<ul class="incremental">
<li>Create multiple user</li>
<li>Install multiple software package</li>
<li>Polling for finished</li>
</ul>
<h3 id="standard-loops">Standard Loops</h3>
<ul class="incremental">
<li><p>Iterator variable named <code>item</code></p>
<div class="sourceCode"><pre class="sourceCode yaml"><code class="sourceCode yaml"><span class="kw">-</span> <span class="fu">name:</span><span class="at"> add several users</span>
  <span class="fu">user:</span>
    <span class="fu">name:</span><span class="at"> </span><span class="st">&quot;{{ item }}&quot;</span>
    <span class="fu">state:</span><span class="at"> present</span>
    <span class="fu">groups:</span><span class="at"> </span><span class="st">&quot;wheel&quot;</span>
  <span class="fu">loop:</span>
     <span class="kw">-</span> testuser1
     <span class="kw">-</span> testuser2</code></pre></div></li>
<li><p>Can loop over list value</p>
<div class="sourceCode"><pre class="sourceCode yaml"><code class="sourceCode yaml"><span class="kw">-</span> <span class="fu">name:</span><span class="at"> non optimal yum, not only slower but might cause issues with interdependencies</span>
  <span class="fu">yum:</span>
    <span class="fu">name:</span><span class="at"> </span><span class="st">&quot;{{item}}&quot;</span>
    <span class="fu">state:</span><span class="at"> present</span>
  <span class="fu">loop:</span><span class="at"> </span><span class="st">&quot;{{list_of_packages}}&quot;</span></code></pre></div></li>
<li><p>Iterate over list of objects</p>
<div class="sourceCode"><pre class="sourceCode yaml"><code class="sourceCode yaml"><span class="kw">-</span> <span class="fu">name:</span><span class="at"> add several users</span>
  <span class="fu">user:</span>
    <span class="fu">name:</span><span class="at"> </span><span class="st">&quot;{{ item.name }}&quot;</span>
    <span class="fu">state:</span><span class="at"> present</span>
    <span class="fu">groups:</span><span class="at"> </span><span class="st">&quot;{{ item.groups }}&quot;</span>
  <span class="fu">loop:</span>
    <span class="kw">-</span> <span class="kw">{</span> <span class="fu">name:</span><span class="at"> </span><span class="st">&#39;testuser1&#39;</span><span class="kw">, </span><span class="fu">groups:</span><span class="at"> </span><span class="st">&#39;wheel&#39;</span> <span class="kw">}</span>
    <span class="kw">-</span> <span class="kw">{</span> <span class="fu">name:</span><span class="at"> </span><span class="st">&#39;testuser2&#39;</span><span class="kw">, </span><span class="fu">groups:</span><span class="at"> </span><span class="st">&#39;root&#39;</span> <span class="kw">}</span></code></pre></div></li>
<li><p>Iterator over dict with <code>dict2items</code> filter</p>
<div class="sourceCode"><pre class="sourceCode yaml"><code class="sourceCode yaml"><span class="kw">-</span> <span class="fu">name:</span><span class="at"> create a tag dictionary of non-empty tags</span>
  <span class="fu">set_fact:</span>
    <span class="fu">tags_dict:</span><span class="at"> </span><span class="st">&quot;{{ (tags_dict|default({}))|combine({item.key: item.value}) }}&quot;</span>
  <span class="fu">loop:</span><span class="at"> </span><span class="st">&quot;{{ tags|dict2items }}&quot;</span>
  <span class="fu">vars:</span>
    <span class="fu">tags:</span>
      <span class="fu">Environment:</span><span class="at"> dev</span>
      <span class="fu">Application:</span><span class="at"> payment</span>
      <span class="fu">Another:</span><span class="at"> </span><span class="st">&quot;{{ doesnotexist|default() }}&quot;</span>
  <span class="fu">when:</span><span class="at"> item.value != &quot;&quot;</span></code></pre></div></li>
</ul>
<h3 id="complex-loops">Complex Loops</h3>
<p>Can use Jinja2 expressions to create complex lists, for example</p>
<div class="sourceCode"><pre class="sourceCode yaml"><code class="sourceCode yaml"><span class="kw">-</span> <span class="fu">name:</span><span class="at"> give users access to multiple databases</span>
  <span class="fu">mysql_user:</span>
    <span class="fu">name:</span><span class="at"> </span><span class="st">&quot;{{ item[0] }}&quot;</span>
    <span class="fu">priv:</span><span class="at"> </span><span class="st">&quot;{{ item[1] }}.*:ALL&quot;</span>
    <span class="fu">append_privs:</span><span class="at"> yes</span>
    <span class="fu">password:</span><span class="at"> </span><span class="st">&quot;foo&quot;</span>
  <span class="fu">loop:</span><span class="at"> </span><span class="st">&quot;{{ [&#39;alice&#39;, &#39;bob&#39;] |product([&#39;clientdb&#39;, &#39;employeedb&#39;, &#39;providerdb&#39;])|list }}&quot;</span></code></pre></div>
<h3 id="querylookup">query/lookup</h3>
<p>See <code>ansible-doc -t lookup inventory_hostnames</code></p>
<div class="sourceCode"><pre class="sourceCode yaml"><code class="sourceCode yaml"><span class="fu">loop:</span><span class="at"> </span><span class="st">&quot;{{ query(&#39;inventory_hostnames&#39;, &#39;all&#39;) }}&quot;</span>
<span class="fu">loop:</span><span class="at"> </span><span class="st">&quot;{{ lookup(&#39;inventory_hostnames&#39;, &#39;all&#39;, wantlist=True) }}&quot;</span></code></pre></div>
<h3 id="do-until-loops-polling">Do-Until Loops (polling)</h3>
<div class="sourceCode"><pre class="sourceCode yaml"><code class="sourceCode yaml"><span class="kw">-</span> <span class="fu">shell:</span><span class="at"> /usr/bin/foo</span>
  <span class="fu">register:</span><span class="at"> result</span>
  <span class="fu">until:</span><span class="at"> result.stdout.find(&quot;all systems go&quot;) != -1</span>
  <span class="fu">retries:</span><span class="at"> 5</span>
  <span class="fu">delay:</span><span class="at"> 10</span></code></pre></div>
<h3 id="register-in-loop">Register in loop</h3>
<ul class="incremental">
<li>can register variable in loop</li>
<li>variable has <code>results</code> fields which is a list for each result</li>
<li><p>During iteration, the result of the current item will be placed in the variable</p>
<div class="sourceCode"><pre class="sourceCode yaml"><code class="sourceCode yaml"><span class="kw">-</span> <span class="fu">shell:</span><span class="at"> echo &quot;{{ item }}&quot;</span>
  <span class="fu">loop:</span>
    <span class="kw">-</span> one
    <span class="kw">-</span> two
  <span class="fu">register:</span><span class="at"> echo</span>
  <span class="fu">changed_when:</span><span class="at"> echo.stdout != &quot;one&quot;</span></code></pre></div></li>
</ul>
<h3 id="loop-over-the-inventory">Loop over the inventory</h3>
<ul class="incremental">
<li><p>Use <code>ansible_play_batch</code> or <code>groups</code> variables</p>
<div class="sourceCode"><pre class="sourceCode yaml"><code class="sourceCode yaml"><span class="co"># show all the hosts in the inventory</span>
<span class="kw">-</span> <span class="fu">debug:</span>
    <span class="fu">msg:</span><span class="at"> </span><span class="st">&quot;{{ item }}&quot;</span>
  <span class="fu">loop:</span><span class="at"> </span><span class="st">&quot;{{ groups[&#39;all&#39;] }}&quot;</span>

<span class="co"># show all the hosts in the current play</span>
<span class="kw">-</span> <span class="fu">debug:</span>
    <span class="fu">msg:</span><span class="at"> </span><span class="st">&quot;{{ item }}&quot;</span>
  <span class="fu">loop:</span><span class="at"> </span><span class="st">&quot;{{ ansible_play_batch }}&quot;</span></code></pre></div></li>
<li><p>with lookup plugin <code>inventory_hostnames</code></p>
<div class="sourceCode"><pre class="sourceCode yaml"><code class="sourceCode yaml"><span class="co"># show all the hosts in the inventory</span>
<span class="kw">-</span> <span class="fu">debug:</span>
    <span class="fu">msg:</span><span class="at"> </span><span class="st">&quot;{{ item }}&quot;</span>
  <span class="fu">loop:</span><span class="at"> </span><span class="st">&quot;{{ query(&#39;inventory_hostnames&#39;, &#39;all&#39;) }}&quot;</span>

<span class="co"># show all the hosts matching the pattern, ie all but the group www</span>
<span class="kw">-</span> <span class="fu">debug:</span>
    <span class="fu">msg:</span><span class="at"> </span><span class="st">&quot;{{ item }}&quot;</span>
  <span class="fu">loop:</span><span class="at"> </span><span class="st">&quot;{{ query(&#39;inventory_hostnames&#39;, &#39;all!www&#39;) }}&quot;</span></code></pre></div></li>
</ul>
<h3 id="loop-control">Loop Control</h3>
<ul class="incremental">
<li><p>Change the iterator name <code>item</code> with <code>loop_control.loop_var</code></p>
<div class="sourceCode"><pre class="sourceCode yaml"><code class="sourceCode yaml"><span class="co"># main.yml</span>
<span class="kw">-</span> <span class="fu">include_tasks:</span><span class="at"> inner.yml</span>
  <span class="fu">loop:</span>
    <span class="kw">-</span> 1
    <span class="kw">-</span> 2
    <span class="kw">-</span> 3
  <span class="fu">loop_control:</span>
    <span class="fu">loop_var:</span><span class="at"> outer_item</span>

<span class="co"># inner.yml</span>
<span class="kw">-</span> <span class="fu">debug:</span>
    <span class="fu">msg:</span><span class="at"> </span><span class="st">&quot;outer item={{ outer_item }} inner item={{ item }}&quot;</span>
  <span class="fu">loop:</span>
    <span class="kw">-</span> a
    <span class="kw">-</span> b
    <span class="kw">-</span> c</code></pre></div></li>
<li><p>Reduce result structure with <code>loop_control.label</code></p>
<div class="sourceCode"><pre class="sourceCode yaml"><code class="sourceCode yaml"><span class="kw">-</span> <span class="fu">name:</span><span class="at"> create servers</span>
  <span class="fu">digital_ocean:</span>
    <span class="fu">name:</span><span class="at"> </span><span class="st">&quot;{{ item.name }}&quot;</span>
    <span class="fu">state:</span><span class="at"> present</span>
  <span class="fu">loop:</span>
    <span class="kw">-</span> <span class="fu">name:</span><span class="at"> server1</span>
      <span class="fu">disks:</span><span class="at"> 3gb</span>
      <span class="fu">ram:</span><span class="at"> 15Gb</span>
      <span class="fu">network:</span>
        <span class="fu">nic01:</span><span class="at"> 100Gb</span>
        <span class="fu">nic02:</span><span class="at"> 10Gb</span>
        ...
  <span class="fu">loop_control:</span>
    <span class="fu">label:</span><span class="at"> </span><span class="st">&quot;{{ item.name }}&quot;</span></code></pre></div></li>
<li><p>Pause for specific seconds between execution of items in a task loop</p>
<div class="sourceCode"><pre class="sourceCode yaml"><code class="sourceCode yaml"><span class="co"># main.yml</span>
<span class="kw">-</span> <span class="fu">name:</span><span class="at"> create servers, pause 3s before creating next</span>
  <span class="fu">digital_ocean:</span>
    <span class="fu">name:</span><span class="at"> </span><span class="st">&quot;{{ item }}&quot;</span>
    <span class="fu">state:</span><span class="at"> present</span>
  <span class="fu">loop:</span>
    <span class="kw">-</span> server1
    <span class="kw">-</span> server2
  <span class="fu">loop_control:</span>
    <span class="fu">pause:</span><span class="at"> 3</span></code></pre></div></li>
<li><p>Loop with index</p>
<div class="sourceCode"><pre class="sourceCode yaml"><code class="sourceCode yaml"><span class="kw">-</span> <span class="fu">name:</span><span class="at"> count our fruit</span>
  <span class="fu">debug:</span>
    <span class="fu">msg:</span><span class="at"> </span><span class="st">&quot;{{ item }} with index {{ my_idx }}&quot;</span>
  <span class="fu">loop:</span>
    <span class="kw">-</span> apple
    <span class="kw">-</span> banana
    <span class="kw">-</span> pear
  <span class="fu">loop_control:</span>
    <span class="fu">index_var:</span><span class="at"> my_idx</span></code></pre></div></li>
</ul>
<h3 id="old-fashion-with_x-methods">Old fashion <code>with_X</code> methods</h3>
<ul class="incremental">
<li><p><code>with_list</code></p>
<div class="sourceCode"><pre class="sourceCode yaml"><code class="sourceCode yaml"><span class="kw">-</span> <span class="fu">name:</span><span class="at"> with_list</span>
  <span class="fu">debug:</span>
    <span class="fu">msg:</span><span class="at"> </span><span class="st">&quot;{{ item }}&quot;</span>
  <span class="fu">with_list:</span>
    <span class="kw">-</span> one
    <span class="kw">-</span> two

<span class="kw">-</span> <span class="fu">name:</span><span class="at"> with_list -&gt; loop</span>
  <span class="fu">debug:</span>
    <span class="fu">msg:</span><span class="at"> </span><span class="st">&quot;{{ item }}&quot;</span>
  <span class="fu">loop:</span>
    <span class="kw">-</span> one
    <span class="kw">-</span> two</code></pre></div></li>
<li><p><code>with_items</code></p>
<div class="sourceCode"><pre class="sourceCode yaml"><code class="sourceCode yaml"><span class="kw">-</span> <span class="fu">name:</span><span class="at"> with_items</span>
  <span class="fu">debug:</span>
    <span class="fu">msg:</span><span class="at"> </span><span class="st">&quot;{{ item }}&quot;</span>
  <span class="fu">with_items:</span><span class="at"> </span><span class="st">&quot;{{ items }}&quot;</span>

<span class="kw">-</span> <span class="fu">name:</span><span class="at"> with_items -&gt; loop</span>
  <span class="fu">debug:</span>
    <span class="fu">msg:</span><span class="at"> </span><span class="st">&quot;{{ item }}&quot;</span>
  <span class="fu">loop:</span><span class="at"> </span><span class="st">&quot;{{ items|flatten(levels=1) }}&quot;</span></code></pre></div></li>
<li><p><code>with_indexed_items</code></p>
<div class="sourceCode"><pre class="sourceCode yaml"><code class="sourceCode yaml"><span class="kw">-</span> <span class="fu">name:</span><span class="at"> with_indexed_items</span>
  <span class="fu">debug:</span>
    <span class="fu">msg:</span><span class="at"> </span><span class="st">&quot;{{ item.0 }} - {{ item.1 }}&quot;</span>
  <span class="fu">with_indexed_items:</span><span class="at"> </span><span class="st">&quot;{{ items }}&quot;</span>

<span class="kw">-</span> <span class="fu">name:</span><span class="at"> with_indexed_items -&gt; loop</span>
  <span class="fu">debug:</span>
    <span class="fu">msg:</span><span class="at"> </span><span class="st">&quot;{{ index }} - {{ item }}&quot;</span>
  <span class="fu">loop:</span><span class="at"> </span><span class="st">&quot;{{ items|flatten(levels=1) }}&quot;</span>
  <span class="fu">loop_control:</span>
    <span class="fu">index_var:</span><span class="at"> index</span></code></pre></div></li>
<li><p><code>with_flattened</code></p>
<div class="sourceCode"><pre class="sourceCode yaml"><code class="sourceCode yaml"><span class="kw">-</span> <span class="fu">name:</span><span class="at"> with_flattened</span>
  <span class="fu">debug:</span>
    <span class="fu">msg:</span><span class="at"> </span><span class="st">&quot;{{ item }}&quot;</span>
  <span class="fu">with_flattened:</span><span class="at"> </span><span class="st">&quot;{{ items }}&quot;</span>

<span class="kw">-</span> <span class="fu">name:</span><span class="at"> with_flattened -&gt; loop</span>
  <span class="fu">debug:</span>
    <span class="fu">msg:</span><span class="at"> </span><span class="st">&quot;{{ item }}&quot;</span>
  <span class="fu">loop:</span><span class="at"> </span><span class="st">&quot;{{ items|flatten }}&quot;</span></code></pre></div></li>
<li><p><code>with_together</code></p>
<div class="sourceCode"><pre class="sourceCode yaml"><code class="sourceCode yaml"><span class="kw">-</span> <span class="fu">name:</span><span class="at"> with_together</span>
  <span class="fu">debug:</span>
    <span class="fu">msg:</span><span class="at"> </span><span class="st">&quot;{{ item.0 }} - {{ item.1 }}&quot;</span>
  <span class="fu">with_together:</span>
    <span class="kw">-</span> <span class="st">&quot;{{ list_one }}&quot;</span>
    <span class="kw">-</span> <span class="st">&quot;{{ list_two }}&quot;</span>

<span class="kw">-</span> <span class="fu">name:</span><span class="at"> with_together -&gt; loop</span>
  <span class="fu">debug:</span>
    <span class="fu">msg:</span><span class="at"> </span><span class="st">&quot;{{ item.0 }} - {{ item.1 }}&quot;</span>
  <span class="fu">loop:</span><span class="at"> </span><span class="st">&quot;{{ list_one|zip(list_two)|list }}&quot;</span></code></pre></div></li>
<li><p><code>with_dict</code></p>
#+BEGIN<sub>SRC</sub> yaml
<ul class="incremental">
<li>name: with<sub>dict</sub></li>
</ul>
<p>debug: msg: &quot;{{ item.key }} - {{ item.value }}&quot; with<sub>dict</sub>: &quot;{{ dictionary }}&quot;</p></li>
<li><p>name: with<sub>dict</sub> -&gt; loop (option 1) debug: msg: &quot;{{ item.key }} - {{ item.value }}&quot; loop: &quot;{{ dictionary|dict2items }}&quot;</p></li>
<li><p>name: with<sub>dict</sub> -&gt; loop (option 2) debug: msg: &quot;{{ item.0 }} - {{ item.1 }}&quot; loop: &quot;{{ dictionary|dictsort }}&quot;</p>
<p>#+END<sub>SRC</sub></p></li>
<li><p><code>with_sequence</code></p>
<div class="sourceCode"><pre class="sourceCode yaml"><code class="sourceCode yaml"><span class="kw">-</span> <span class="fu">name:</span><span class="at"> with_sequence</span>
  <span class="fu">debug:</span>
    <span class="fu">msg:</span><span class="at"> </span><span class="st">&quot;{{ item }}&quot;</span>
  <span class="fu">with_sequence:</span><span class="at"> start=0 end=4 stride=2 format=testuser%02x</span>

<span class="kw">-</span> <span class="fu">name:</span><span class="at"> with_sequence -&gt; loop</span>
  <span class="fu">debug:</span>
    <span class="fu">msg:</span><span class="at"> </span><span class="st">&quot;{{ &#39;testuser%02x&#39; | format(item) }}&quot;</span>
  <span class="co"># range is exclusive of the end point</span>
  <span class="fu">loop:</span><span class="at"> </span><span class="st">&quot;{{ range(0, 4 + 1, 2)|list }}&quot;</span></code></pre></div></li>
<li><p><code>with_subelements</code></p>
<div class="sourceCode"><pre class="sourceCode yaml"><code class="sourceCode yaml"><span class="kw">-</span> <span class="fu">name:</span><span class="at"> with_subelements</span>
  <span class="fu">debug:</span>
    <span class="fu">msg:</span><span class="at"> </span><span class="st">&quot;{{ item.0.name }} - {{ item.1 }}&quot;</span>
  <span class="fu">with_subelements:</span>
    <span class="kw">-</span> <span class="st">&quot;{{ users }}&quot;</span>
    <span class="kw">-</span> mysql.hosts

<span class="kw">-</span> <span class="fu">name:</span><span class="at"> with_subelements -&gt; loop</span>
  <span class="fu">debug:</span>
    <span class="fu">msg:</span><span class="at"> </span><span class="st">&quot;{{ item.0.name }} - {{ item.1 }}&quot;</span>
  <span class="fu">loop:</span><span class="at"> </span><span class="st">&quot;{{ users|subelements(&#39;mysql.hosts&#39;) }}&quot;</span></code></pre></div></li>
<li><p><code>with_nested/with_cartesian</code></p>
<div class="sourceCode"><pre class="sourceCode yaml"><code class="sourceCode yaml"><span class="kw">-</span> <span class="fu">name:</span><span class="at"> with_nested</span>
  <span class="fu">debug:</span>
    <span class="fu">msg:</span><span class="at"> </span><span class="st">&quot;{{ item.0 }} - {{ item.1 }}&quot;</span>
  <span class="fu">with_nested:</span>
    <span class="kw">-</span> <span class="st">&quot;{{ list_one }}&quot;</span>
    <span class="kw">-</span> <span class="st">&quot;{{ list_two }}&quot;</span>

<span class="kw">-</span> <span class="fu">name:</span><span class="at"> with_nested -&gt; loop</span>
  <span class="fu">debug:</span>
    <span class="fu">msg:</span><span class="at"> </span><span class="st">&quot;{{ item.0 }} - {{ item.1 }}&quot;</span>
  <span class="fu">loop:</span><span class="at"> </span><span class="st">&quot;{{ list_one|product(list_two)|list }}&quot;</span></code></pre></div></li>
<li><p><code>with_random_choice</code></p>
<div class="sourceCode"><pre class="sourceCode yaml"><code class="sourceCode yaml"><span class="kw">-</span> <span class="fu">name:</span><span class="at"> with_random_choice</span>
  <span class="fu">debug:</span>
    <span class="fu">msg:</span><span class="at"> </span><span class="st">&quot;{{ item }}&quot;</span>
  <span class="fu">with_random_choice:</span><span class="at"> </span><span class="st">&quot;{{ my_list }}&quot;</span>

<span class="kw">-</span> <span class="fu">name:</span><span class="at"> with_random_choice -&gt; loop (No loop is needed here)</span>
  <span class="fu">debug:</span>
    <span class="fu">msg:</span><span class="at"> </span><span class="st">&quot;{{ my_list|random }}&quot;</span>
  <span class="fu">tags:</span><span class="at"> random</span></code></pre></div></li>
</ul>
<h2 id="playbook-roles"><span class="todo TODO">TODO</span> Playbook &amp; Roles</h2>
<h2 id="resuable">Resuable</h2>
<h3 id="ways">Ways</h3>
<p>3 ways to split large playbook into seperate files</p>
<ol class="incremental">
<li><code>include</code></li>
<li><code>imports</code></li>
<li><code>roles</code></li>
</ol>
<h3 id="comparision">comparision</h3>
<ul class="incremental">
<li><code>roles</code> can package variable, handler, module, plugins</li>
<li><code>import</code>: static including which process during parsing time</li>
<li><code>include</code>: dynamic including which happen during runtime</li>
</ul>
<h2 id="error-handling-1">Error Handling</h2>
<ul class="incremental">
<li>Playbook will fail fast at return error as default behavior</li>
<li>use <code>ignore_errors: yes</code> to ignore errors of task</li>
<li>reactivate unreachable hosts with <code>meta: clear_host_errors</code></li>
<li>force to trigger handdle even errors happen by set <code>force_handler: True</code></li>
<li>use <code>failed_when: &lt;clause&gt;</code> to program which state means failed
<ul class="incremental">
<li>output with &quot;FAILED&quot;: ~failed<sub>when</sub>: &quot;'FAILED' in command<sub>result</sub>.stderr&quot;~</li>
<li>based on return code: <code>failed_when: diff_cmd.rc == 0 or diff_cmd.rc &gt;= 2</code></li>
</ul></li>
<li>Modified the <code>changed</code> status by custom judge, such as ~changed<sub>when</sub>: &quot;bass<sub>result</sub>.rc != 2&quot;~</li>
<li>Abort the play by set <code>any_errors_fatal: true</code></li>
</ul>
<h2 id="best-practice">Best Practice</h2>
<h3 id="content-organization">Content Organization</h3>
<ol class="incremental">
<li><p>Directory Layout</p>
<pre class="text"><code>production                # inventory file for production servers
staging                   # inventory file for staging environment

group_vars/
   group1.yml             # here we assign variables to particular groups
   group2.yml
host_vars/
   hostname1.yml          # here we assign variables to particular systems
   hostname2.yml

library/                  # if any custom modules, put them here (optional)
module_utils/             # if any custom module_utils to support modules, put them here (optional)
filter_plugins/           # if any custom filter plugins, put them here (optional)

site.yml                  # master playbook
webservers.yml            # playbook for webserver tier
dbservers.yml             # playbook for dbserver tier

roles/
    common/               # this hierarchy represents a &quot;role&quot;
        tasks/            #
            main.yml      #  &lt;-- tasks file can include smaller files if warranted
        handlers/         #
            main.yml      #  &lt;-- handlers file
        templates/        #  &lt;-- files for use with the template resource
            ntp.conf.j2   #  &lt;------- templates end in .j2
        files/            #
            bar.txt       #  &lt;-- files for use with the copy resource
            foo.sh        #  &lt;-- script files for use with the script resource
        vars/             #
            main.yml      #  &lt;-- variables associated with this role
        defaults/         #
            main.yml      #  &lt;-- default lower priority variables for this role
        meta/             #
            main.yml      #  &lt;-- role dependencies
        library/          # roles can also include custom modules
        module_utils/     # roles can also include custom module_utils
        lookup_plugins/   # or other types of plugins, like lookup in this case

    webtier/              # same kind of structure as &quot;common&quot; was above, done for the webtier role
    monitoring/           # &quot;&quot;
    fooapp/               # &quot;&quot;
</code></pre></li>
<li><p>Alternative Directory Layout</p>
<p>Alternatively you can put each inventory file with its group<sub>vars</sub>/host<sub>vars</sub> in a separate directory. This is particularly useful if your group<sub>vars</sub>/host<sub>vars</sub> don’t have that much in common in different environments. The layout could look something like this:</p>
<pre class="text"><code>inventories/
   production/
      hosts               # inventory file for production servers
      group_vars/
         group1.yml       # here we assign variables to particular groups
         group2.yml
      host_vars/
         hostname1.yml    # here we assign variables to particular systems
         hostname2.yml

   staging/
      hosts               # inventory file for staging environment
      group_vars/
         group1.yml       # here we assign variables to particular groups
         group2.yml
      host_vars/
         stagehost1.yml   # here we assign variables to particular systems
         stagehost2.yml

library/
module_utils/
filter_plugins/

site.yml
webservers.yml
dbservers.yml

roles/
    common/
    webtier/
    monitoring/
    fooapp/
</code></pre></li>
<li><p>Use Dynamic Inventory With Clouds</p></li>
<li><p>How to Differentiate Staging vs Production</p>
<ol class="incremental">
<li>按业务分组（如 webserver, dbserver）</li>
<li>按区域分组（如 atlanta, boston）</li>
</ol>
<p>例如</p>
<div class="sourceCode"><pre class="sourceCode ini"><code class="sourceCode ini"><span class="co"># file: production</span>

<span class="kw">[atlanta-webservers]</span>
<span class="dt">www-atl-1.example.com</span>
<span class="dt">www-atl-2.example.com</span>

<span class="kw">[boston-webservers]</span>
<span class="dt">www-bos-1.example.com</span>
<span class="dt">www-bos-2.example.com</span>

<span class="kw">[atlanta-dbservers]</span>
<span class="dt">db-atl-1.example.com</span>
<span class="dt">db-atl-2.example.com</span>

<span class="kw">[boston-dbservers]</span>
<span class="dt">db-bos-1.example.com</span>

<span class="co"># webservers in all geos</span>
<span class="kw">[webservers:children]</span>
<span class="dt">atlanta-webservers</span>
<span class="dt">boston-webservers</span>

<span class="co"># dbservers in all geos</span>
<span class="kw">[dbservers:children]</span>
<span class="dt">atlanta-dbservers</span>
<span class="dt">boston-dbservers</span>

<span class="co"># everything in the atlanta geo</span>
<span class="kw">[atlanta:children]</span>
<span class="dt">atlanta-webservers</span>
<span class="dt">atlanta-dbservers</span>

<span class="co"># everything in the boston geo</span>
<span class="kw">[boston:children]</span>
<span class="dt">boston-webservers</span>
<span class="dt">boston-dbservers</span></code></pre></div></li>
<li><p>Group And Host Variables</p>
<p>变量定义顺序为</p>
<ol class="incremental">
<li>group all</li>
<li>group vars</li>
<li>host vars</li>
</ol>
<p>可以为同一个主机的多个组分别设置变量</p></li>
<li><p>Top Level Playbooks Are Separated By Role</p>
<ol class="incremental">
<li><p>在 site.yml 中导入相关业务 yaml</p>
<div class="sourceCode"><pre class="sourceCode yaml"><code class="sourceCode yaml"><span class="ot">---</span>
<span class="co"># file: site.yml</span>
<span class="kw">-</span> <span class="fu">import_playbook:</span><span class="at"> webservers.yml</span>
<span class="kw">-</span> <span class="fu">import_playbook:</span><span class="at"> dbservers.yml</span></code></pre></div></li>
<li><p>在具体 yaml 中引用 roles</p>
<div class="sourceCode"><pre class="sourceCode yaml"><code class="sourceCode yaml"><span class="ot">---</span>
<span class="co"># file: webservers.yml</span>
<span class="kw">-</span> <span class="fu">hosts:</span><span class="at"> webservers</span>
  <span class="fu">roles:</span>
    <span class="kw">-</span> common
    <span class="kw">-</span> webtier</code></pre></div></li>
<li><p>使用时，可以指定 yaml 文件，并使用 <code>--limit</code> 过滤主机</p>
<div class="sourceCode"><pre class="sourceCode yaml"><code class="sourceCode yaml">ansible-playbook site.yml --limit webservers
ansible-playbook webservers.yml</code></pre></div></li>
</ol></li>
<li><p>Task And Handler Organization For A Role</p>
<ul class="incremental">
<li>Role 中将 task 与 handler 分在两个目录中</li>
</ul></li>
<li><p>What This Organization Enables (Examples)</p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash"><span class="co"># working on production inventory</span>
<span class="ex">ansible-playbook</span> -i production site.yml

<span class="co"># To reconfigure NTP on everything:</span>
<span class="ex">ansible-playbook</span> -i production site.yml --tags ntp

<span class="co"># To reconfigure just my webservers:</span>
<span class="ex">ansible-playbook</span> -i production webservers.yml

<span class="co"># For just my webservers in Boston:</span>
<span class="ex">ansible-playbook</span> -i production webservers.yml --limit boston

<span class="co"># For just the first 10, and then the next 10:</span>
<span class="ex">ansible-playbook</span> -i production webservers.yml --limit boston[0:9]
<span class="ex">ansible-playbook</span> -i production webservers.yml --limit boston[10:19]

<span class="co"># And of course just basic ad-hoc stuff is also possible:</span>
<span class="ex">ansible</span> boston -i production -m ping
<span class="ex">ansible</span> boston -i production -m command -a <span class="st">&#39;/sbin/reboot&#39;</span>

<span class="co"># confirm what task names would be run if I ran this command and said &quot;just ntp tasks&quot;</span>
<span class="ex">ansible-playbook</span> -i production webservers.yml --tags ntp --list-tasks

<span class="co"># confirm what hostnames might be communicated with if I said &quot;limit to boston&quot;</span>
<span class="ex">ansible-playbook</span> -i production webservers.yml --limit boston --list-hosts</code></pre></div>
<ul class="incremental">
<li><code>--tags</code>: filter with tag</li>
<li><code>-i &lt;inventory&gt;</code></li>
<li><code>--limit</code>: filter hosts</li>
<li><code>ansible -m</code>: adhoc stuff</li>
<li><code>--list-tasks</code>: list tasks names</li>
<li><code>--list-hosts</code>: list hosts names to play</li>
</ul></li>
</ol>
<h3 id="use-a-separate-inventory-file-for-staging-and-production">Use a separate inventory file for staging and production</h3>
<h3 id="rolling-updates"><span class="todo TODO">TODO</span> Rolling Updates</h3>
<p>Understand the ‘serial’ keyword</p>
<h3 id="always-mention-the-state">Always Mention The State</h3>
<h3 id="group-by-roles"><span class="todo TODO">TODO</span> Group By Roles</h3>
<p>Don't repeat yourself.</p>
<h3 id="operating-system-and-distribution-variance">Operating System and Distribution Variance</h3>
<p>Dynamic group basing on operation system and distribution variance</p>
<div class="sourceCode"><pre class="sourceCode yaml"><code class="sourceCode yaml"><span class="ot">---</span>

 <span class="co"># talk to all hosts just so we can learn about them</span>
 <span class="kw">-</span> <span class="fu">hosts:</span><span class="at"> all</span>
   <span class="fu">tasks:</span>
     <span class="kw">-</span> <span class="fu">group_by:</span>
         <span class="fu">key:</span><span class="at"> os_{{ ansible_distribution }}</span>

 <span class="co"># now just on the CentOS hosts...</span>

 <span class="kw">-</span> <span class="fu">hosts:</span><span class="at"> os_CentOS</span>
   <span class="fu">gather_facts:</span><span class="at"> False</span>
   <span class="fu">tasks:</span>
     <span class="kw">-</span> <span class="co"># tasks that only happen on CentOS go here</span></code></pre></div>
<h3 id="bundling-ansible-modules-with-playbooks">Bundling Ansible Modules With Playbooks</h3>
<p>Playbook can have it's own <code>./library</code> directory for modules that will automatically be in the ansible module path.</p>
<h3 id="whitespace-and-comments">Whitespace and Comments</h3>
<p>Generous use of whitespace to break things up, and use of comments (which start with ‘#’), is encouraged.</p>
<h3 id="always-name-tasks">Always Name Tasks</h3>
<h3 id="keep-it-simple">Keep It Simple</h3>
<h3 id="version-control">Version Control</h3>
<ul class="incremental">
<li>Use version control. Keep your playbooks and inventory file in git</li>
<li>commit when you make changes to them</li>
</ul>
<h3 id="variables-and-vaults"><span class="todo TODO">TODO</span> Variables and Vaults</h3>
<ul class="incremental">
<li>for the sake of <code>grep</code> tools</li>
<li>define all variables in <code>/vars</code></li>
<li>overwrite sensitive variables to the <code>/valut</code> file</li>
</ul>
<h1 id="role">Role</h1>
<h2 id="overview-1">Overview</h2>
<h3 id="what-is-role">What is Role</h3>
<p>Roles are ways of automatically loading certain vars<sub>files</sub>, tasks, and handlers based on a known file structure.</p>
<h3 id="why-role">Why Role?</h3>
<p>For sharing roles with others (encapsulation)</p>
<h3 id="directory-structure">Directory Structure</h3>
<ul class="incremental">
<li>Contains specific sets of directory</li>
<li>Each directory contains a <code>main.yml</code> configuration file</li>
</ul>
<h2 id="directory-explain">Directory Explain</h2>
<dl class="incremental">
<dt>tasks</dt>
<dd>contains the main list of tasks to be executed by the role.
</dd>
<dt>handlers</dt>
<dd>contains handlers, which may be used by this role or even anywhere outside this role.
</dd>
<dt>defaults</dt>
<dd>default variables for the role (see Variables for more information).
</dd>
<dt>vars</dt>
<dd>other variables for the role (see <em>Variable</em> for more information).
</dd>
<dt>files</dt>
<dd>contains files which can be deployed via this role.
</dd>
<dt>templates</dt>
<dd>contains templates which can be deployed via this role.
</dd>
<dt>meta</dt>
<dd>defines some meta data for this role. See below for more details.
</dd>
</dl>
<h2 id="tasks-roles">Tasks &amp; Roles</h2>
<ul class="incremental">
<li>Task can import other tasks by <code>import_tasks</code> and <code>when</code> clause</li>
<li>Task can import other roles by <code>include_role</code> or <code>import_role</code></li>
<li>Tasks are defined under the <code>role/task/main.yml</code></li>
</ul>
<h2 id="modules-plugins-embed"><span class="todo TODO">TODO</span> Modules &amp; Plugins Embed</h2>
<h2 id="usage-2">Usage</h2>
<ul class="incremental">
<li>Playbook choose the roles with <code>roles</code> keyword</li>
<li>If the <code>roles/x/{tasks,handlers,vars,defaults,meta,script,copy,template}</code> directory exists, do something</li>
<li><code>meta</code> configured the behaviour of role</li>
</ul>
<h2 id="playbook-executions-order">Playbook executions order</h2>
<ol class="incremental">
<li>Any <code>pre_tasks</code> defined in the play.</li>
<li>Any <code>handlers</code> triggered so far will be run.</li>
<li>Each role listed in <code>roles</code> will execute in turn. Any role dependencies defined in the roles <code>meta/main.yml</code> will be run first, subject to tag filtering and conditionals.</li>
<li>Any <code>tasks</code> defined in the play.</li>
<li>Any <code>handlers</code> triggered so far will be run.</li>
<li>Any <code>post_tasks</code> defined in the play.</li>
<li>Any <code>handlers</code> triggered so far will be run.</li>
</ol>
<h2 id="dependencies">Dependencies</h2>
<ul class="incremental">
<li>Role can depend other roles</li>
<li>include them in <code>meta/main.yml</code></li>
<li>Execute before current role</li>
</ul>
<h2 id="search-path">Search Path</h2>
<ol class="incremental">
<li><code>role</code> directory, relative to the playbook file</li>
<li>By default, in <code>/etc/ansible/roles</code></li>
</ol>
<h2 id="misc-1">Misc</h2>
<ul class="incremental">
<li>Duplicated roles in playbook would be execute only once (if not be changed in meta)</li>
<li>Default Values as the fallback of <code>vars</code></li>
<li>Roles in playbook can be tagged with <code>tags</code> command</li>
</ul>
<h1 id="modules">Modules</h1>
<h2 id="group">group</h2>
<h2 id="user">user</h2>
<h2 id="copy">copy</h2>
<h2 id="file">file</h2>
<ul class="incremental">
<li>Change permission</li>
<li>Create directory</li>
</ul>
<h2 id="fetch"><span class="todo TODO">TODO</span> fetch</h2>
<h2 id="command">command</h2>
<h2 id="shell"><span class="todo TODO">TODO</span> shell</h2>
<h2 id="cron">cron</h2>
<h2 id="yum">yum</h2>
<h2 id="apt">apt</h2>
<h2 id="systemd">systemd</h2>
<h2 id="service">service</h2>
<h2 id="git"><span class="todo TODO">TODO</span> git</h2>
<h2 id="script"><span class="todo TODO">TODO</span> script</h2>
<p>script at local?</p>
<h2 id="lineinfile">lineinfile</h2>
<p>This module ensures a particular line is in a file, or replace an existing line using a back-referenced regular expression. This is primarily useful when you want to change a single line in a file only.</p>
<p>Something like <code>sed</code> or vim replacement.</p>
<h2 id="async-status"><span class="todo TODO">TODO</span> async-status</h2>
<h1 id="misc-2">Misc</h1>
<h2 id="log-types">Log types</h2>
<ol class="incremental">
<li>with SSH Key</li>
<li>Ask for password <code>--ask-pass</code></li>
<li>Switch to other user (<code>sudo</code>) with <code>--ask-become-pass</code></li>
</ol>
<h2 id="disable-host-key">Disable host-key</h2>
<p>Disable <code>host-key-checking</code> for</p>
<ol class="incremental">
<li>host information change in <code>know_hosts</code></li>
<li>first time to login a ssh server</li>
</ol>
<h2 id="ansible-all--m-setup"><code>ansible all -m setup</code></h2>
<p>Get all hosts' <code>facts</code></p>
<h2 id="background-execute">background execute</h2>
<ul class="incremental">
<li><code>-B 3600</code>: run in background for most 3600s</li>
<li><code>-P</code> for polling</li>
</ul>
<h2 id="ansible-doc"><span class="todo TODO">TODO</span> ansible-doc</h2>
<h2 id="ansible-pull"><span class="todo TODO">TODO</span> ansible-pull</h2>
<h2 id="ansibleosfamily"><span class="todo TODO">TODO</span> =ansible<sub>osfamily</sub>=</h2>
<h2 id="debug"><span class="todo TODO">TODO</span> =debug=</h2>
<h2 id="yaml-syntax">Yaml Syntax</h2>
<ol class="incremental">
<li>(optional) start with <code>---</code> and end with <code>...</code></li>
<li>Starts with =&quot;- &quot;= to express list</li>
<li><code>key:value</code> for mapping</li>
<li>Boolean literal: <code>yes</code>, <code>no</code>, <code>True</code>, <code>TRUE</code>, <code>false</code></li>
<li>Span multiple lines with '|' and '&gt;'
<ol class="incremental">
<li>'|' to keep newline</li>
<li>'&gt;' converts newline to space</li>
</ol></li>
<li>comment line with '#'</li>
<li>use <code>{{}}</code> for variable substitute
<ol class="incremental">
<li>yaml use <code>: {}</code> for dictionary defnition</li>
<li>so quote =&quot;{{}}&quot;= for variable</li>
</ol></li>
<li>Be careful for literal convertion for float and boolean value!</li>
</ol>
<h1 id="cookbook">Cookbook</h1>
<h2 id="first-ansible-command">First Ansible Command</h2>
<p>Echo hello on localhost</p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash"><span class="ex">ansible</span> [-c local] localhost -a <span class="st">&quot;echo hello&quot;</span></code></pre></div>
<p>By default, run with <code>command</code> module which does not support shell syntax like piping and redirects. Use <code>shell</code> module if we need</p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash"><span class="ex">ansible</span> localhost -m shell -a <span class="st">&#39;echo $TERM&#39;</span></code></pre></div>
<h2 id="copy-file-to-lots-of-hosts">Copy file to lots of hosts</h2>
<p>With <code>copy</code> module</p>

			</div>
		</section>
	</body>
</html>

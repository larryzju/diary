<!DOCTYPE html>
<html>
	<head>
		<title>iptables.org</title>
		<link rel="stylesheet" href="/diary/resources/css/main.css" />
		<link rel="stylesheet" href="/diary/resources/highlight/styles/default.css" />
		<script src="/diary/resources/js/jquery-3.4.1.min.js"></script>
		<script src="/diary/resources/js/swgen.js"></script>
		<script src="/diary/resources/highlight/highlight.pack.js"></script>
		<script src='https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-MML-AM_CHTML' async></script>
		<script>hljs.initHighlightingOnLoad();</script>
	</head>
	<body>
		<nav id='content'>
		</nav>
		<section class="main-article-area">
			<div id='main'>
				<h1 id="concept">Concept</h1>
<h2 id="overview">Overview</h2>
<ul class="incremental">
<li>iptables(kernel) is used to inspect, modify, forward, redirect, and/or drop IP packets</li>
<li>The code for filtering IP packets is already built into the kernel and is organized into a collection of tables, each with a specific purpose</li>
<li>The tables are made up of a set of predefined chains, and the chains contain rules which are traversed in order.</li>
<li>iptables(tools) is the user utility which allows you to work with these chains/rules.</li>
</ul>
<h2 id="tables">Tables</h2>
<p>iptables contains five tables</p>
<ol class="incremental">
<li><code>raw</code> is used only for configuring packets so that they are exempt from connection tracking.</li>
<li><code>filter</code> (default table) is where all the actions typically associated with a firewall take place.</li>
<li><code>nat</code> is used for network address translation (e.g. port forwarding)</li>
<li><code>mangle</code> is used for specialized packet alterations.</li>
<li><code>security</code> us used for Mandatory Access Control networking rule (e.g. SELINUX)</li>
</ol>
<p>In most case you will only use <strong>filter</strong> and <strong>nat</strong> tables.</p>
<h2 id="chains">Chains</h2>
<p>Tables consist of chains, which are lists of rules which are followed in order.</p>
<h3 id="filter-chians">filter chians</h3>
<ol class="incremental">
<li><code>INPUT</code></li>
<li><code>OUTPUT</code></li>
<li><code>FORWARD</code></li>
</ol>
<h3 id="nat-chains">nat chains</h3>
<ol class="incremental">
<li><code>PREROUTING</code></li>
<li><code>POSTROUTING</code></li>
<li><code>OUTPUT</code></li>
</ol>
<h3 id="default-rules">Default rules</h3>
<ul class="incremental">
<li>none of the chains contain any rules by default</li>
<li>There's a default policy, which generally set to <code>ACCEPT</code></li>
<li>can be reset to <code>DROP</code></li>
<li>The default policy always applies at the end of a chain only</li>
<li>User-defined chains can be added to make rulesets more efficient or more easily modifiable</li>
</ul>
<h2 id="rules">Rules</h2>
<h3 id="overview-1">Overview</h3>
<ul class="incremental">
<li>Guide packets filtering</li>
<li>Specified by multiple matches and one target
<ul class="incremental">
<li><code>matches</code> means conditions the packets must satisfy so that the rule can be applied</li>
<li><code>target</code> do the action</li>
</ul></li>
<li>Matches such as
<ul class="incremental">
<li>what the interface the packet came in</li>
<li>what type of packet it is (ICMP, TCP, or UDP)</li>
<li>destination port of the packet</li>
</ul></li>
<li>Targets are specified using the <code>-j</code> option (jump)</li>
<li>Targets can be in
<ul class="incremental">
<li>user-defined chains</li>
<li>one of the special built-in targets (the <strong>endpoint</strong>, such as <code>ACCEPT</code>, <code>DROP</code>, <code>QUEUE</code>, <code>RETURN</code>)</li>
<li>target extension (<code>REJECT</code> and <code>LOG</code>)</li>
</ul></li>
</ul>
<h1 id="command-line">Command Line</h1>
<h2 id="dump-restore">Dump &amp; Restore</h2>
<dl class="incremental">
<dt><code>iptables-save</code></dt>
<dd>dump the iptable rules, can be used as configuration
</dd>
<dt><code>iptables-restore</code></dt>
<dd>load the rules directly through iptables
</dd>
</dl>
<h2 id="showing-the-current-rules">Showing the current rules</h2>
<ul class="incremental">
<li><code>iptables --list-rules</code> (<code>-S</code>): output <code>filter</code> table rules</li>
<li><code>iptables --list</code> (<code>-L</code>): accepts more modifiers and show more information
<ul class="incremental">
<li><code>iptables -nvL</code>: show current ruleset and the number of hits per rule</li>
</ul></li>
<li>Specify other tables than <code>default</code> with the <code>-t</code> option</li>
</ul>
<h2 id="resetting-rules">Resetting rules</h2>
<ul class="incremental">
<li><code>iptables [-t &lt;table&gt;] [-P &lt;chain&gt;] -F</code>: delete all rules one by one</li>
<li><code>iptables [-t &lt;table&gt;] [-P &lt;chain&gt;] -X</code>: deletes all empty non-default chains in a table</li>
</ul>
<h2 id="editing-rules">Editing rules</h2>
<h3 id="basic">Basic</h3>
<dl class="incremental">
<dt><code>-A</code></dt>
<dd>appending a rule to a chain
</dd>
<dt><code>-I</code></dt>
<dd>inserting at a specific position on the chain
</dd>
<dt><code>-R</code></dt>
<dd>replace a rule
</dd>
<dt><code>-D</code></dt>
<dd>delete a rule
</dd>
</dl>
<h3 id="example">Example</h3>
<ol class="incremental">
<li><p>Do not as a router</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb1-1"><a href="#cb1-1"></a><span class="ex">iptables</span> -P FORWARD DROP        <span class="co"># set `FORWARD` chains default policy as `DROP`</span></span></code></pre></div></li>
<li><p>Reject Dropbox periodly broadcast packets</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb2-1"><a href="#cb2-1"></a><span class="ex">iptables</span> -A INPUT <span class="dt">\ </span>            <span class="co"># append to chain `INPUT`</span></span>
<span id="cb2-2"><a href="#cb2-2"></a>   <span class="ex">-p</span> tcp  <span class="dt">\ </span>                   <span class="co"># protocol TCP</span></span>
<span id="cb2-3"><a href="#cb2-3"></a>   <span class="ex">--dport</span> 17500 -j REJECT      <span class="co"># jump to target `REJECT`</span></span>
<span id="cb2-4"><a href="#cb2-4"></a>   <span class="ex">--reject-with</span> icmp-port-unreachable</span></code></pre></div></li>
<li><p>Only accept particular IP to use Dropbox broadcast</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb3-1"><a href="#cb3-1"></a><span class="ex">iptables</span> -R INPUT 1 -p tcp --dport 17500 \</span>
<span id="cb3-2"><a href="#cb3-2"></a>         ! -s 10.0.0.85 -j REJECT --reject-with icmp-port-unreable</span></code></pre></div>
<ul class="incremental">
<li><code>-R</code> for replace our old rule</li>
<li>Reject all except the packet with the source IP <code>10.0.0.85</code></li>
</ul></li>
<li><p>Trust some Dropbox</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb4-1"><a href="#cb4-1"></a><span class="co">## accept immediately</span></span>
<span id="cb4-2"><a href="#cb4-2"></a><span class="ex">iptables</span> -I INPUT -p tcp --dport 17500 -s 10.0.0.85 -j ACCEPT \</span>
<span id="cb4-3"><a href="#cb4-3"></a>         -m comment --comment <span class="st">&quot;Friendly Dropbox&quot;</span></span>
<span id="cb4-4"><a href="#cb4-4"></a></span>
<span id="cb4-5"><a href="#cb4-5"></a><span class="co">## replace the second rule to `REJECT` all others dropbox broadcast</span></span>
<span id="cb4-6"><a href="#cb4-6"></a><span class="ex">iptables</span> -R INPUT 2 -p tcp --dport 17500 -j REJECT \</span>
<span id="cb4-7"><a href="#cb4-7"></a>         --reject-with icmp-port-unreachable</span></code></pre></div></li>
<li><p>Logging</p>
<ul class="incremental">
<li>Like middleware, not affect the packet flow.</li>
<li>Rather than add a duplicate <code>LOG</code> rule before each <code>DROP</code> rule</li>
<li>Create a <code>logdrop</code> chain to make things happy
<ol class="incremental">
<li><p>Create the chain</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb5-1"><a href="#cb5-1"></a><span class="ex">iptables</span> -N logdrop</span></code></pre></div></li>
<li><p>Add rules</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb6-1"><a href="#cb6-1"></a><span class="ex">iptables</span> -A logdrop -m limit --limit 5/m --limit-burst 10 -j LOG</span>
<span id="cb6-2"><a href="#cb6-2"></a><span class="ex">iptables</span> -A logdrop -j DROP</span></code></pre></div></li>
<li><p>Use the chain</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb7-1"><a href="#cb7-1"></a><span class="ex">iptables</span> -A INPUT -m conntrack --ctstate INVALID -j logdrop</span></code></pre></div></li>
</ol></li>
<li>Explain
<ul class="incremental">
<li>Use <code>limit</code> module</li>
<li><code>--limit-burst</code> set an initial burst rate: The first 10 packets will be logged</li>
<li>set the average rate with <code>--limit 5/m</code>: only 5 packets per minute will be logged</li>
</ul></li>
</ul></li>
</ol>
<h1 id="todo"><span class="todo TODO">TODO</span> TODO</h1>
<h2 id="netfilter-vs-linux-vs-iptables">Netfilter vs Linux vs Iptables</h2>
<h2 id="extensions">Extensions</h2>
<p><a href="https://jlk.fjfi.cvut.cz/arch/manpages/man/iptables-extensions.8">iptables-extensions</a></p>
<h2 id="nftables"><code>nftables</code></h2>
<h1 id="reference">Reference</h1>
<ul class="incremental">
<li><a href="https://wiki.archlinux.org/index.php/Iptables">Archlinux wiki - iptables</a></li>
</ul>

			</div>
		</section>
	</body>
</html>

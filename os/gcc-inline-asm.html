<!DOCTYPE html>
<html>
	<head>
		<title>gcc-inline-asm.md</title>
		<link rel="stylesheet" href="/diary/resources/css/main.css" />
		<script src="/diary/resources/js/jquery-3.4.1.min.js"></script>
		<script src="/diary/resources/js/swgen.js"></script>
	</head>
	<body>
		<nav id='content'>
		</nav>
		<section class="main-article-area">
			<div id='main'>
				<h1 id="section">概述</h1>

<h2 id="inline">inline</h2>

<p>inline 用于内联插入代码块，是一种代码优化策略。减少函数调用造成的开销</p>

<h2 id="asm">asm</h2>

<p>关键字 <code>asm</code> （也可以用 <code>__asm__</code>） 用于在 C 代码中插入汇编代码</p>

<h2 id="section-1">语法</h2>

<p>使用 AT&amp;T 汇编语法，分为基本语法和扩展语法。</p>

<p>扩展语法主要原因是：</p>

<ul>
  <li>需要传入 C 的变量</li>
  <li>需要告诉 GCC 指令修改了些什么，以便 GCC 进行优化</li>
</ul>

<h2 id="volatile">volatile</h2>

<p>用于阻止 GCC 优化代码，避免编译器将这部分代码移动或删除</p>

<h1 id="att-">AT&amp;T 语法</h1>

<ol>
  <li>Source-Destination Ordering: <code>opcode src dst</code></li>
  <li>Register Nameing: <code>%eax</code></li>
  <li>Immediate Operand: <code>$0x08</code></li>
  <li>Operand Size: <code>movl</code></li>
  <li>Memory Operands: <code>disp(base,index,scale)</code></li>
</ol>

<h1 id="asm-">ASM 语法</h1>

<pre><code>asm ( assembler template
	: output operands
	: input  operands
	: list of clobbered registers );
</code></pre>

<p>其中输入和输出的语法为逗号分隔的变量描述，变量描述如下：</p>

<pre><code>"c" (count)
</code></pre>

<p>前者称为 constraint，用于标记使用的类型（寄存器？内存？立即数）及修饰词</p>

<p>后者为 C 的变量或字面常量</p>

<p>示例如下：</p>

<pre><code>asm ( "movl %1, %%eax;
       movl %%eax, %0;"
    :  "=r" (b)
	:  "r"  (a)
	:  "%eax" );
</code></pre>

<p>第三项称为 clobber list，用于告知 GCC 哪些寄存器被修改，以便进行保护。<strong>不需要列入输入输出寄存器</strong>，因为 GCC 知道它自己修改了这些寄存器中的哪些</p>

<h1 id="section-2">参考资料</h1>

<p><a href="http://www.ibiblio.org/gferg/ldp/GCC-Inline-Assembly-HOWTO.html">GCC inline assembly howto</a></p>

			</div>
		</section>
	</body>
</html>
